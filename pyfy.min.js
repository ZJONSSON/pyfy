/**
  * pyfy.js (c) 2008-2013 Sigurgeir Orn Jonsson (ziggy.jonsson.nyc@gmail.com)
  * @license http://creativecommons.org/licenses/by-nc-sa/3.0/
  * Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported (CC BY-NC-SA 3.0)
  */
(function(){function t(t,n){return+t-n}function n(t){return t}function e(){return this instanceof e?(this.cache={},void 0):new e}function r(){return this instanceof r?(this.ID=P++,void 0):new r}function i(t,n){return this instanceof i?(this.const=t||0,void 0):new i(t,n)}function a(t){return this instanceof a?(this.parents=t,void 0):new a(t)}function o(t,n){return this instanceof o?(r.apply(this,arguments),this.data={},this._dates=[],t&&this.update(t),void 0):new o(t,n)}function s(t,n){return this instanceof s?(o.apply(this,arguments),void 0):new s(t,n)}function u(t,n){return this instanceof u?(o.apply(this,arguments),void 0):new u(t,n)}function h(t,n){return this instanceof h?(o.apply(this,arguments),void 0):new h(t,n)}function c(t,n){return this instanceof c?(o.apply(this,arguments),void 0):new c(t,n)}function f(t,n){return this instanceof f?(r.call(this,arguments),this.parent=t||new r,n&&(this.fn=n),void 0):new f(t,n)}function p(t,n,e){return this instanceof p?(f.call(this,t),this.start=n||-1/0,this.fin=e||1/0,void 0):new p(t,n,e)}function d(t,n){return this instanceof d?(f.call(this,t),this.default=n||0,void 0):new d(t,n)}function l(t){return this instanceof l?(f.call(this,t),void 0):new l(t)}function y(t){return this instanceof y?(f.call(this,t),void 0):new y}function v(t,n){return this instanceof v?(f.call(this,t),this.max=n||0,void 0):new v(t,n)}function w(t,n){return this instanceof w?(f.call(this,t),this.min=n||0,void 0):new w}function D(t){return this instanceof D?(f.call(this,t),void 0):new D}function g(t){return this instanceof g?(f.call(this,t),this.start=t||0,void 0):new g(t)}function m(t,n){return this instanceof m?(f.call(this,t),n&&(this.calendar=n),void 0):new m}function M(t,n,e){return this instanceof M?(r.apply(this,arguments),this.left=n,this.right=e,this.op=t,void 0):new M(t,n,e)}function x(t,n){return this instanceof x?(f.call(this,t),void 0!==n&&this.setDaycount(n),void 0):new M(t,n)}function _(t,n){return this instanceof _?(u.apply(this,arguments),this.df=new b(this),this.daycount=q.daycount.d_30_360,void 0):new _(t,n)}function b(t,n){f.call(this,t),this.val=n}function I(t,n,e,r,i,a){return this instanceof I?(q.derived.apply(this),this.notional=i||1,this.daycount=a,this.rate=r,this.schedule=q.interval(t,n,e).div(e),this.generate(),void 0):new I(t,n,e,r,i,a)}function Y(){function t(){var t=e(),r=127&t;return u[r]>Math.abs(t)?t*o[r]:n(t,r)}function n(t,n){for(var i,a,h=3.442619855899,c=1/h;;){if(i=t*o[n],0===n){for(i=-Math.log(r())*c,a=-Math.log(r());i*i>a+a;)i=-Math.log(r())*c,a=-Math.log(r());return t>0?h+i:-h-i}if(Math.exp(-.5*i*i)>s[n]+r()*(s[n-1]-s[n]))return i;if(t=e(),n=127&t,u[n]>Math.abs(t))return t*o[n]}}function e(){var t=a,n=a;return n^=n<<13,n^=n>>>17,n^=n<<5,a=n,0|t+n}function r(){return.5*(1+e()/-Math.pow(2,31))}function i(){a^=(new Date).getTime();var t=2147483648,n=3.442619855899,e=n,r=.00991256303526217,i=r/Math.exp(-.5*n*n);u[0]=Math.floor(n/i*t),u[1]=0,o[0]=i/t,o[127]=n/t,s[0]=1,s[127]=Math.exp(-.5*n*n);for(var h=126;h>=1;h--)n=Math.sqrt(-2*Math.log(r/n+Math.exp(-.5*n*n))),u[h+1]=Math.floor(n/e*t),e=n,s[h]=Math.exp(-.5*n*n),o[h]=n/t}var a=123456789,o=Array(128),s=Array(128),u=Array(128);this.nextGaussian=function(){return t()},i()}function F(){return 2*Math.random()-1+(2*Math.random()-1)+(2*Math.random()-1)}function O(t,n,e){return this instanceof O?(r.apply(this),this.s=t||0,this.r=n||0,this.vol=e||0,void 0):new O(t,n,e)}function F(){return 2*Math.random()-1+(2*Math.random()-1)+(2*Math.random()-1)}function E(){return this instanceof E?(r.apply(this),this.change=this.diff(this),void 0):new E}var q=this.pyfy={};"undefined"!=typeof module&&(module.exports=q),q.util={},q.util.DAYMS=864e5,q.util.dateParts=function(t){t=new Date(t);var n={y:t.getFullYear(),m:t.getMonth(),d:t.getDate()};return n.date=new Date(n.y,n.m,n.d),n.lastofMonth=new Date(n.y,n.m,n.d+1).getMonth()==n.m+1,n.lastFeb=2==n.m&&n.lastofMonth,n},q.util.today=function(){return q.util.dateParts(new Date).date},q.util.nextDay=function(t,n){return void 0===n&&(n=0),new Date(t.getFullYear(),t.getMonth(),t.getDate()+n)},q.util.bisect=function(t,e,r,i){for(3>arguments.length&&(r=0),4>arguments.length&&(i=t.length);i>r;){var a=r+i>>>1;e>n.call(t,t[a],a)?r=a+1:i=a}return r},q.Query=e,q.query=function(t,n){return n=n||new e,t&&(n.cache[t]=n.cache[t]||{values:{}},n.cache[t].values=n.cache[t].values||{}),n},e.prototype.getCache=function(t){return this.cache[t.ID]||(this.cache[t.ID]={values:{}})},e.prototype.dates=function(n){var e=this.getCache(n);return e.dates||(e.dates=n.dates(this).map(function(t){return t.valueOf()}).sort(t)),e.dates},e.prototype.y=function(t,n){return this.get(t,n)},e.prototype.x=function(t){return this.dates(t).map(function(t){return new Date(t)})},e.prototype.val=function(t,n){return n=n||this.dates(t),n=[].concat(n),this.get(t,n).map(function(t,e){return{x:new Date(n[e]),y:t}},this)},e.prototype.get=function(t,n){return n||(n=this.dates(t)),[].concat(n).map(function(n){return this.fetch(t,n.valueOf())},this)},e.prototype.fetch=function(t,n){if(!isNaN(t))return t;var e=this.getCache(t).values;if(void 0===e[n]){var r=t.fn(this,n.valueOf());void 0!==r&&(e[n]=r)}return e[n]};var P=0;q.base=q.Base=r,r.prototype.dates=function(n){var e=this.rawDates(n),r=[];for(var i in e)r.push(new Date(+e[i]));return r.sort(t)},r.prototype.rawDates=function(t){t=q.query(this.ID,t);var n=t.cache[this.ID];if(!n.rawDates){n.rawDates={};var e="function"==typeof this.inputs?this.inputs():this.inputs;[].concat(e).filter(function(t){return t&&t.rawDates}).forEach(function(e){for(var r in e.rawDates(t))n.rawDates[r]=+r})}return n.rawDates},r.prototype.fn=function(){return 0},[l,y,d,v,w,D,m,x,p,f].forEach(function(t){r.prototype[t.name.toLowerCase()]=function(n,e,r){return new t(this,n,e,r)}}),r.prototype.pv=function(t){var n=0;return isNaN(t)||(t=q.ir(t)),this.mul(t.df).y().forEach(function(t){n+=t}),n},r.prototype.y=function(t){return q.query().get(this,t)},r.prototype.x=function(t){return q.query().x(this,t)},r.prototype.val=function(t){return q.query().val(this,t)},q.const=i,i.prototype=new r,i.prototype.fn=function(){return this.const},i.prototype.update=i.prototype.set=function(t){return this.const=t,this},q.sum=a,a.prototype=new r,a.prototype.inputs=function(){return this.parents},a.prototype.fn=function(t,n){var e=0;return this.parents.forEach(function(r){e+=t.fetch(r,n)}),e},q.data=q.Data=o,o.prototype=new r,o.prototype.rawDates=function(t){t=q.query(this.ID,t);var n=t.cache[this.ID];return n.rawDates||(n.rawDates={},this._dates.forEach(function(t){n.rawDates[t]=t})),n.rawDates},o.prototype.update=function(n){if(0===arguments.length)return this;if(isNaN(n))[].concat(n).forEach(function(t){this.data[t.x.valueOf()]=t.y},this);else{var e=q.util.today().valueOf();this.data[e]=n}return this._dates=Object.keys(this.data).map(function(t){return+t}).sort(t),this},o.prototype.set=function(t){return this.data={},this.update(t)},o.prototype.fn=function(t,n){if(!Object.keys(this.data).length)return 0;if(this.data[n])return this.data[n];var e=t.dates(this),r=q.util.bisect(e,n),i=r-1;return r==e.length&&(r-=1),0===r&&(i=0),this._fn(n,e[i]||e[r],e[r])},o.prototype._fn=function(){return void 0},q.flow=s,s.prototype=new o,s.prototype.fn=function(t,n){return this.data[n]||0},q.stock=u,u.prototype=new o,u.prototype._fn=function(t,n){return this.data[n]},q.price=h,h.prototype=new o,h.prototype._fn=function(t,n,e){var r=this.data[n],i=this.data[e];return n==e?i:e>(t>n)?r+(i-r)*(t-n)/(e-n):i},q.stream=c,c.prototype=new o,q.interval=function(t,n,e,r){for(var i=[],a=0;e+1>a;a++)i.push({x:new Date(t.getFullYear(),t.getMonth()+a*n,t.getDate()),y:r||!a?0:1});return i=q.flow(i),i.no=e,i},q.derived=q.Derived=f,f.prototype=new r,f.prototype.inputs=function(){return this.parent},f.prototype.fn=function(t,n){return t.fetch(this.parent,n)},f.prototype.setParent=function(t){return this.parent=t,this},q.period=p,p.prototype=new f,p.prototype.fn=function(t,n){return n>=this.start&&this.fin>=n?t.fetch(this.parent,n):0},q.prev=d,d.prototype=new f,d.prototype.fn=function(t,n){var e=t.dates(this),r=q.util.bisect(e,n);return r>0?t.fetch(this.parent,e[r-1]):this.default},q.cumul=l,l.prototype=new f,l.prototype.fn=function(t,n){var e=t.dates(this),r=q.util.bisect(e,n);return t.fetch(this.parent,n)+(r?t.fetch(this,e[r-1]):0)},q.diff=y,y.prototype=new f,y.prototype.fn=function(t,n){var e=t.dates(this),r=q.util.bisect(e,n);return r?t.fetch(this.parent,n)-t.fetch(this.parent,e[r-1]):0},q.max=v,v.prototype=new f,v.prototype.fn=function(t,n){return Math.max(t.fetch(this.parent,n),this.max)},q.min=w,w.prototype=new f,w.prototype.fn=function(t,n){return Math.min(t.fetch(this.parent,n),this.min)},q.Neg=D,D.prototype=new f,D.prototype.fn=function(t,n){return-t.fetch(this.parent,n)},q.acct=g,g.prototype=new f,g.prototype.fn=function(t,n){var e=t.dates(this.parent),r=q.util.bisect(e,n);return 1>r?this.start:e[r]==n?t.fetch(this,e[r-1])+t.fetch(this.parent,n):t.fetch(this,e[r-1])},q.Calendar=m,m.prototype=new f,m.prototype.rawDates=function(t){t=q.query(this.ID,t);var n=t.cache[this.ID];n.dateMap={},n.rawDates={};for(var e in this.parent.rawDates(t)){var r=this.calendar(new Date(+e)).valueOf();n.rawDates[r]=+r,n.dateMap[r]=+e}return n.rawDates},m.prototype.fn=function(t,n){var e=t.cache[this.ID];return t.fetch(this.parent,e.dateMap[n]||this.calendar(n))},m.prototype.calendar=function(t){var n=t.getDay();return 0===n||6===n?this.calendar(new Date(t.getFullYear(),t.getMonth(),t.getDate()+1)):t},q.operator=q.Operator=M;var A={add:function(t,n){return t+n},sub:function(t,n){return t-n},mul:function(t,n){return t*n},div:function(t,n){return t/n},pow:function(t,n){return Math.pow(t,n)}};Object.keys(A).forEach(function(t){r.prototype[t]=function(n){return new M(t,this,n)}}),M.prototype=new r,M.prototype.inputs=function(){return[this.left,this.right]},M.prototype.fn=function(t,n){var e,r;return r=t.fetch(this.right,n),r||"mul"!=this.op?(e=t.fetch(this.left,n),A[this.op](e,r)):0},q.daycount=q.daycount||{},q.daycount.d_30_360=function(t,n){return 31==t.d&&(t.d=30),30==t.d&&31==n.d&&(n.d=30),(360*(n.y-t.y)+30*(n.m-t.m)+(n.d-t.d))/360},q.daycount.d_30E_360=function(t,n){return 31==t.d&&(t.d=30),31==n.d&&(n.d=30),(360*(n.y-t.y)+30*(n.m-t.m)+(n.d-t.d))/360},q.daycount.d_30_360US=function(t,n){return t.lastofFeb&&n.lastofFeb&&(n.d=30),t.lastofFeb&&(t.d=30),31!=n.d||30!=t.d&&31!=t.d||(n.d=30),31==t.d&&(t.d=30),(360*(n.y-t.y)+30*(n.m-t.m)+(n.d-t.d))/360},q.daycount.d_act_360=function(t,n){return Math.round((n.date-t.date)/q.util.DAYMS)/360},q.daycount.d_act_act=function(t,n){for(var e=0,r=t.date,i=new Date(Math.min(new Date(r.getFullYear()+1,0,1),n.date));n.date>r;){var a=new Date(r.getFullYear(),1,29),o=29==a.getDate()?366:365;e+=Math.round((i-r)/q.util.DAYMS)/o,r=i,i=new Date(Math.min(new Date(r.getFullYear()+1,0,1),n.date))}return e},q.dcf=x,x.prototype=new f,x.prototype.fn=function(t,n){var e=t.cache[this.ID];if(!Object.keys(e.values).length){var r=t.dates(this);e.values={},r.slice(1).forEach(function(n,i){var a=q.util.dateParts(r[i]),o=q.util.dateParts(n);e.values[n]=r[i]?this.daycount(a,o)*t.fetch(this.parent,n):0},this)}return e.values[n]||0},x.prototype.daycount=q.daycount.d_30_360,x.prototype.setDaycount=function(t){return this.daycount="string"==typeof t?q.daycount[t]:t,this},q.ir=_,_.prototype=new u,_.prototype.setDaycount=function(t){return this.daycount="string"==typeof t?q.daycount[t]:t,this},_.prototype._fn=function(t,n,e){return this.data[e]},q.df=function(t){return new f(t)},b.prototype=new x,b.prototype.fn=function(t,n){var e=t.dates(this),r=q.util.bisect(e,n),i=e[r-1];if(!i)return n==e[r]?1:0;var a=this.parent.daycount(q.util.dateParts(i),q.util.dateParts(n));return t.fetch(this,i)*Math.exp(-t.fetch(this.parent,n)*a)},q.bond=I,I.prototype=new q.derived,I.prototype.generate=function(){this.bal=q.acct(this.notional||1),this.p_scheduled=this.schedule.mul(this.notional),this.p=this.schedule.mul(this.notional),this.bal.setParent(this.p.neg()),this.i=this.bal.prev().dcf().mul(this.rate),this.setParent(this.p.add(this.i))},I.prototype.setSchedule=function(t){return this.schedule=t,this.generate(),this};var N=new Y,F=q.rndNorm=N.nextGaussian;q.norm=O,O.prototype=new r,O.prototype.inputs=function(){return[this.s,this.r,this.vol]},O.prototype.fn=function(t,n,e){var r=this.s;t.__dates__;var i=(t.dates[e]-(t.dates[e-1]||t.dates[0]))/365,r=e>0?this.fetch(t,n,e-1):this.s,a=fetch(this.r,t,n,e),o=fetch(this.vol,t,n,e),s=(a-Math.pow(o,2)/2)*i+o*Math.sqrt(i)*F();return r*Math.exp(s)},q.wiener=E,E.prototype=new r,E.prototype.rawDates=function(t){var n={};return t&&t.cache[this.ID].dates&&t.cache[this.ID].dates.forEach(function(t){n[t]=t}),n},E.prototype.fn=function(t,n){var e,r=t.cache[this.ID];if(!r.dates)return r.dates=[n],r.first={x:n,y:0},r.last={x:n,y:0},0;if(n>r.last.x)return r.dates.push(n),e=r.last.y+F()*(n-r.last.x)/q.util.DAYMS/365.25,r.last={x:n,y:e},e;if(r.first.x>n)return r.dates.slice(0,0,n),e=r.min.y-F()*(r.first.x-n)/q.util.DAYMS/365.25,r.first={x:n,y:e},e;var i=q.util.bisect(r.dates,n),a={x:r.dates[i-1]},o={x:r.dates[i]};return a.y=t.fetch(this,a.x),o.y=t.fetch(this,o.x),r.dates.splice(i,0,n),a.y+(n-a.x)/(o.x-a.x)*(o.y-a.y)},E.prototype.dates=function(t){return t?t.cache[this.ID].dates.all:[]}})();