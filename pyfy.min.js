/**
  * pyfy.js (c) 2008-2013 Sigurgeir Orn Jonsson (ziggy.jonsson.nyc@gmail.com)
  * @license http://creativecommons.org/licenses/by-nc-sa/3.0/
  * Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported (CC BY-NC-SA 3.0)
  */
(function(){function t(t,e){return+t-e}function e(t){return t}function n(){return this instanceof n?(this.cache={},void 0):new n}function r(){return this instanceof r?(this.ID=A++,this.args={},this.version=0,void 0):new r}function a(t,e){return this instanceof a?(r.call(this),this.args.const=t||0,void 0):new a(t,e)}function i(t,e,n,a,o,s,u,h){return this instanceof i?(r.call(this),Array.prototype.slice.call(arguments).map(function(t,e){t&&(this.args[e]=t)},this),void 0):new i(t,e,n,a,o,s,u,h)}function o(t,e){return this instanceof o?(r.apply(this,arguments),this.args.data={},this._dates=[],t&&this.update(t),void 0):new o(t,e)}function s(t,e){return this instanceof s?(o.apply(this,arguments),void 0):new s(t,e)}function u(t,e){return this instanceof u?(o.apply(this,arguments),void 0):new u(t,e)}function h(t,e){return this instanceof h?(o.apply(this,arguments),void 0):new h(t,e)}function c(t,e){return this instanceof c?(o.apply(this,arguments),void 0):new c(t,e)}function f(t){return this instanceof f?(r.call(this,arguments),this.args.parent=t||new r,void 0):new f(t,fn)}function p(t,e,n){return this instanceof p?(f.call(this,t),this.args.start=e||-1/0,this.args.fin=n||1/0,void 0):new p(t,e,n)}function d(t,e){return this instanceof d?(f.call(this,t),this.default=e||0,void 0):new d(t,e)}function l(t){return this instanceof l?(f.call(this,t),void 0):new l(t)}function y(t){return this instanceof y?(f.call(this,t),void 0):new y}function g(t,e){return this instanceof g?(f.call(this,t),this.args.max=e||0,void 0):new g(t,e)}function v(t,e){return this instanceof v?(f.call(this,t),this.args.min=e||0,void 0):new v(t,e)}function w(t){return this instanceof w?(f.call(this,t),void 0):new w}function D(t){return this instanceof D?(f.call(this,t),this.args.start=t||0,void 0):new D(t)}function m(t,e){return this instanceof m?(f.call(this,t),this.args.calendar=e||P.calendar.weekday,void 0):new m(t,e)}function M(t,e,n){return this instanceof M?(r.apply(this),this.args.left=e,this.args.right=n,this.op=t,void 0):new M(t,e,n)}function x(t,e){return this instanceof x?(f.call(this,t),void 0!==e&&this.setDaycount(e),void 0):new M(t,e)}function b(t,e,n){return this instanceof b?(f.call(this,t),this.args.daycount=n||P.daycount.d_30_360,this.args.date=e||new Date,void 0):new b(t,e,n)}function _(t,e){return this instanceof _?(u.apply(this,arguments),this.df=new k(this),this.args.daycount=P.daycount.d_30_360,void 0):new _(t,e)}function k(t,e){f.call(this,t),this.args.val=e}function I(t,e,n,r,a,i){return this instanceof I?(P.derived.apply(this),this.notional=a||1,this.daycount=i,this.rate=r,this.schedule=P.interval(t,e,n).div(n),this.generate(),void 0):new I(t,e,n,r,a,i)}function O(){function t(){var t=n(),r=127&t;return u[r]>Math.abs(t)?t*o[r]:e(t,r)}function e(t,e){for(var a,i,h=3.442619855899,c=1/h;;){if(a=t*o[e],0===e){for(a=-Math.log(r())*c,i=-Math.log(r());a*a>i+i;)a=-Math.log(r())*c,i=-Math.log(r());return t>0?h+a:-h-a}if(Math.exp(-.5*a*a)>s[e]+r()*(s[e-1]-s[e]))return a;if(t=n(),e=127&t,u[e]>Math.abs(t))return t*o[e]}}function n(){var t=i,e=i;return e^=e<<13,e^=e>>>17,e^=e<<5,i=e,0|t+e}function r(){return.5*(1+n()/-Math.pow(2,31))}function a(){i^=(new Date).getTime();var t=2147483648,e=3.442619855899,n=e,r=.00991256303526217,a=r/Math.exp(-.5*e*e);u[0]=Math.floor(e/a*t),u[1]=0,o[0]=a/t,o[127]=e/t,s[0]=1,s[127]=Math.exp(-.5*e*e);for(var h=126;h>=1;h--)e=Math.sqrt(-2*Math.log(r/e+Math.exp(-.5*e*e))),u[h+1]=Math.floor(e/n*t),n=e,s[h]=Math.exp(-.5*e*e),o[h]=e/t}var i=123456789,o=Array(128),s=Array(128),u=Array(128);this.nextGaussian=function(){return t()},a()}function Y(){return this instanceof Y?(r.call(this),void 0):new Y}function F(t){return this instanceof F?(r.apply(this),this.change=this.diff(this),this.random=t||new Y,this.inputs=[t],void 0):new F(t)}function E(t,e,n){return this instanceof E?(F.apply(this),this.s=t||0,this.r=e||0,this.vol=n||0,void 0):new E(t,e,n)}function N(t,e,n){return this instanceof N?(Y.call(this),this.args.parent=t,this.args.random=n||new Y,this.args.correl=e,void 0):new N(t,e)}function C(t){return this instanceof C?(n.call(this),this.num=t,void 0):new C(t)}var P=this.pyfy={};"undefined"!=typeof module&&(module.exports=P),P.util={},P.util.DAYMS=864e5,P.util.dateParts=function(t){t=new Date(t);var e={y:t.getFullYear(),m:t.getMonth(),d:t.getDate()};return e.date=new Date(e.y,e.m,e.d),e.lastofMonth=new Date(e.y,e.m,e.d+1).getMonth()==e.m+1,e.lastFeb=2==e.m&&e.lastofMonth,e},P.util.today=function(){return P.util.dateParts(new Date).date},P.util.nextDay=function(t,e){return void 0===e&&(e=0),new Date(t.getFullYear(),t.getMonth(),t.getDate()+e)},P.util.nextWeekday=function(t,e){var n=t.getDay(),r=n>e?e+7-n:e-n;return new Date(t.getFullYear(),t.getMonth(),t.getDate()+r)},P.util.bisect=function(t,n,r,a){for(3>arguments.length&&(r=0),4>arguments.length&&(a=t.length);a>r;){var i=r+a>>>1;n>e.call(t,t[i],i)?r=i+1:a=i}return r},P.calendar={},P.calendar.weekday=function(t){var e=t.getDay();return 0!==e&&6!=e},P.calendar.easter=function(t,e){e=e||[1,-2];var n,r,a,i,o,s,u,h,c;return 4>(t.getMonth()>1)?(n=t.getFullYear(),r=~~(n/100),a=n-19*~~(n/19),i=~~((r-17)/25),o=r-~~(r/4)-~~((r-i)/3)+19*a+15,o-=30*~~(o/30),o-=o/28*(1-~~(o/28)*~~(29/(o+1))*~~((21-a)/11)),s=n+~~(n/4)+o+2-r+~~(r/4),s-=7*~~(s/7),u=o-s,h=3+~~((u+40)/44)-1,c=Math.round(u+28-31*~~(h/4)),e.every(function(e){return t-new Date(n,h,c+e)})):!0},P.calendar.target=function(t){var e=t.getMonth(),n=t.getDate();return!(!P.calendar.weekday(t)||!P.calendar.easter(t,[1,-2])||0===e&&1==n||11==e&&(26==n||25==n)||4==e&&1==n)},P.calendar.is=function(t){var e=t.getFullYear(),n=t.getMonth(),r=t.getDate();return!(!P.calendar.weekday(t)||!P.calendar.easter(t,[1,-2,-3,39,50])||5==n&&17==r||0===n&&1==r||11==n&&(26==r||25==r)||4==n&&1==r||7==n&&0===t-P.util.nextWeekday(new Date(e,7,1),1)||3==n&&0===t-P.util.nextWeekday(new Date(e,3,19),4))},P.Query=n,P.query=function(t,e){return e=e||new n,t&&(e.cache[t]=e.cache[t]||{values:{}},e.cache[t].values=e.cache[t].values||{}),e},n.prototype.initCache=function(t){if(!t.ID)return!1;var e=!this.cache[t.ID]||this.cache[t.ID].version!=t.version;return t.args&&Object.keys(t.args).forEach(function(n){var r=t.args[n];this.initCache(r)&&(e=!0)},this),e&&(this.cache[t.ID]={values:{},version:t.version}),e},n.prototype.getCache=function(t){return this.initCache(t),this.cache[t.ID]},n.prototype.dates=function(e){var n=this.getCache(e);if(!n.dates){var r=this.rawDates(e),a=n.dates=[];for(var i in r)a.push(r[i]);a.sort(t)}return n.dates},n.prototype.rawDates=function(t,e){var n=this.getCache(t);return e=e||{},n&&!n.rawDates&&(t.args&&Object.keys(t.args).forEach(function(n){e=this.rawDates(t.args[n],e)},this),t.rawDates&&(e=t.rawDates(e,this))),e},n.prototype.y=function(t,e){return this.get(t,e)},n.prototype.x=function(t){return this.dates(t).map(function(t){return new Date(t)})},n.prototype.val=function(t,e){return e=e||this.dates(t),e=[].concat(e),this.get(t,e).map(function(t,n){return{x:new Date(e[n]),y:t}},this)},n.prototype.get=function(t,e){return this.initCache(t),e||(e=this.dates(t)),[].concat(e).map(function(e){return this.fetch(t,e.valueOf())},this)},n.prototype.fetch=function(t,e){if(!isNaN(t))return t;var n=this.cache[t.ID].values;if(void 0===n[e]){var r=t.fn(this,e.valueOf());void 0!==r&&(n[e]=r)}return n[e]};var A=0;P.base=P.Base=r,r.prototype.arg=function(t,e){this.args[t]=e,this.version+=1},r.prototype.fn=function(){return 0},r.prototype.rawDates=void 0,[l,y,d,g,v,w,m,x,p,f,b].forEach(function(t){r.prototype[t.name.toLowerCase()]=function(e,n,r){return new t(this,e,n,r)}}),r.prototype.pv=function(t){var e=0;return isNaN(t)||(t=P.ir(t)),this.mul(t.df).y().forEach(function(t){e+=t}),e},r.prototype.y=function(t){return P.query().get(this,t)},r.prototype.x=function(t){return P.query().x(this,t)},r.prototype.val=function(t){return P.query().val(this,t)},r.prototype.dates=function(){return P.query().dates(this).map(function(t){return new Date(t)})},P.const=a,a.prototype=new r,a.prototype.fn=function(){return this.args.const},a.prototype.update=a.prototype.set=function(t){return this.args.const=t,this},P.sum=i,i.prototype=new r,i.prototype.fn=function(t,e,n){var r=0;return Object.keys(this.args).forEach(function(a){r+=t.fetch(this.args[a],e,n)},this),r},P.data=P.Data=o,o.prototype=new r,o.prototype.rawDates=function(t){return t=t||{},this._dates.forEach(function(e){t[e]=e}),t},o.prototype.update=function(e){if(0===arguments.length)return this;if(isNaN(e))[].concat(e).forEach(function(t){this.args.data[t.x.valueOf()]=t.y},this);else{var n=P.util.today().valueOf();this.args.data[n]=e}return this._dates=Object.keys(this.args.data).map(function(t){return+t}).sort(t),this},o.prototype.set=function(t){return this.args.data={},this.update(t)},o.prototype.fn=function(t,e){if(!Object.keys(this.args.data).length)return 0;if(this.args.data[e])return this.args.data[e];var n=t.dates(this),r=P.util.bisect(n,e),a=r-1;return r==n.length&&(r-=1),0===r&&(a=0),this._fn(e,n[a]||n[r],n[r])},o.prototype._fn=function(){return void 0},P.flow=s,s.prototype=new o,s.prototype.fn=function(t,e){return this.args.data[e]||0},P.stock=u,u.prototype=new o,u.prototype._fn=function(t,e){return this.args.data[e]},P.price=h,h.prototype=new o,h.prototype._fn=function(t,e,n){var r=this.args.data[e],a=this.args.data[n];return e==n?a:n>(t>e)?r+(a-r)*(t-e)/(n-e):a},P.stream=c,c.prototype=new o,P.interval=function(t,e,n,r){t=t||P.util.today();for(var a=[],i=0;n+1>i;i++)a.push({x:new Date(t.getFullYear(),t.getMonth()+i*e,t.getDate()),y:i?r||1:0});return P.flow(a)},P.derived=P.Derived=f,f.prototype=new r,f.prototype.fn=function(t,e,n){return t.fetch(this.args.parent,e,n)},f.prototype.setParent=function(t){this.args.parent=t},P.period=p,p.prototype=new f,p.prototype.rawDates=function(t){var e={};return t&&Object.keys(t).forEach(function(n){var r=t[n];r>=this.args.start&&this.args.fin>=r&&(e[r]=r)},this),e},p.prototype.fn=function(t,e,n){return e>=this.args.start&&this.args.fin>=e?t.fetch(this.args.parent,e,n):0},P.prev=d,d.prototype=new f,d.prototype.fn=function(t,e,n){var r=t.dates(this),a=P.util.bisect(r,e);return a>0?t.fetch(this.args.parent,r[a-1],n):this.default},P.cumul=l,l.prototype=new f,l.prototype.fn=function(t,e,n){var r=t.dates(this),a=P.util.bisect(r,e);return t.fetch(this.args.parent,e,n)+(a?t.fetch(this,r[a-1],n):0)},P.diff=y,y.prototype=new f,y.prototype.fn=function(t,e,n){var r=t.dates(this),a=P.util.bisect(r,e);return a?t.fetch(this.args.parent,e,n)-t.fetch(this.args.parent,r[a-1],n):0},P.max=g,g.prototype=new f,g.prototype.fn=function(t,e,n){return Math.max(t.fetch(this.args.parent,e,n),this.args.max)},P.min=v,v.prototype=new f,v.prototype.fn=function(t,e,n){return Math.min(t.fetch(this.args.parent,e,n),this.args.min)},P.Neg=w,w.prototype=new f,w.prototype.fn=function(t,e,n){return-t.fetch(this.args.parent,e,n)},P.acct=D,D.prototype=new f,D.prototype.fn=function(t,e,n){var r=t.dates(this.args.parent),a=P.util.bisect(r,e);return 1>a?this.start:r[a]==e?t.fetch(this,r[a-1],n)+t.fetch(this.args.parent,e,n):t.fetch(this,r[a-1],n)},P.Calendar=m,m.prototype=new f,m.prototype.checkDate=function(t){function e(){return!r.every(function(e){var n="string"==typeof e?P.calendar[e]:e;return n(t)},this)}function n(){if(t=new Date(t.getFullYear(),t.getMonth(),t.getDate()+1),a++>31)throw"Calendar function always returns false"}t=new Date(t);for(var r=[].concat(this.calendar),a=0;e();)n();return t.valueOf()},m.prototype.rawDates=function(t,e){var n=e.cache[this.ID];t={},n.dateMap={};for(var r in this.args.parent.rawDates()){var a=this.checkDate(+r);t[a]=+a,n.dateMap[a]=+r}return t},m.prototype.fn=function(t,e){var n=t.cache[this.ID];return t.fetch(this.args.parent,n.dateMap[e]||this.calendar(e))},P.operator=P.Operator=M;var j={add:function(t,e){return t+e},sub:function(t,e){return t-e},mul:function(t,e){return t*e},div:function(t,e){return t/e},pow:function(t,e){return Math.pow(t,e)}};Object.keys(j).forEach(function(t){r.prototype[t]=function(e){return new M(t,this,e)}}),M.prototype=new r,M.prototype.fn=function(t,e,n){var r,a;return a=t.fetch(this.args.right,e,n),a||"mul"!=this.op?(r=t.fetch(this.args.left,e,n),j[this.op](r,a)):0},P.daycount=P.daycount||{},P.daycount.d_30_360=function(t,e){return 31==t.d&&(t.d=30),30==t.d&&31==e.d&&(e.d=30),(360*(e.y-t.y)+30*(e.m-t.m)+(e.d-t.d))/360},P.daycount.d_30E_360=function(t,e){return 31==t.d&&(t.d=30),31==e.d&&(e.d=30),(360*(e.y-t.y)+30*(e.m-t.m)+(e.d-t.d))/360},P.daycount.d_30_360US=function(t,e){return t.lastofFeb&&e.lastofFeb&&(e.d=30),t.lastofFeb&&(t.d=30),31!=e.d||30!=t.d&&31!=t.d||(e.d=30),31==t.d&&(t.d=30),(360*(e.y-t.y)+30*(e.m-t.m)+(e.d-t.d))/360},P.daycount.d_act_360=function(t,e){return Math.round((e.date-t.date)/P.util.DAYMS)/360},P.daycount.d_act_act=function(t,e){for(var n=0,r=t.date,a=new Date(Math.min(new Date(r.getFullYear()+1,0,1),e.date));e.date>r;){var i=new Date(r.getFullYear(),1,29),o=29==i.getDate()?366:365;n+=Math.round((a-r)/P.util.DAYMS)/o,r=a,a=new Date(Math.min(new Date(r.getFullYear()+1,0,1),e.date))}return n},P.dcf=x,x.prototype=new f,x.prototype.fn=function(t,e){var n=t.cache[this.ID];if(!Object.keys(n.values).length){var r=t.dates(this);n.values={},r.slice(1).forEach(function(t,e){var a=P.util.dateParts(r[e]),i=P.util.dateParts(t);n.values[t]=r[e]?this.daycount(a,i):0},this)}return n.values[e]||0},x.prototype.daycount=P.daycount.d_30_360,x.prototype.setDaycount=function(t){return this.daycount="string"==typeof t?P.daycount[t]:t,this},P.timeDiff=b,b.prototype=new f,b.prototype.fn=function(t,e){var n=this.args.date;if("string"==typeof n){var r=t.dates(this.args.parent);n=new Date("L"===n.slice(0,1).toUpperCase()?r[r.length-1]:r[0])}return Math.abs(this.args.daycount(P.util.dateParts(n),P.util.dateParts(new Date(e))))},P.ir=_,_.prototype=new u,_.prototype.setDaycount=function(t){return this.args.daycount="string"==typeof t?P.daycount[t]:t,this},_.prototype._fn=function(t,e,n){return this.args.data[n]},P.df=function(t){return new f(t)},k.prototype=new x,k.prototype.fn=function(t,e,n){var r=t.dates(this),a=P.util.bisect(r,e),i=r[a-1];if(!i)return e==r[a]?1:0;var o=this.parent.daycount(P.util.dateParts(i),P.util.dateParts(e));return t.fetch(this,i,n)*Math.exp(-t.fetch(this.args.parent,e,n)*o)},P.bond=I,I.prototype=new P.derived,I.prototype.generate=function(){this.bal=P.acct(this.notional||1),this.p_scheduled=this.schedule.mul(this.notional),this.p=this.schedule.mul(this.notional),this.bal.setParent(this.p.neg()),this.i=this.bal.prev().dcf().mul(this.rate),this.setParent(this.p.add(this.i))},I.prototype.setSchedule=function(t){return this.schedule=t,this.generate(),this};{var q=new O;P.rndNorm=q.nextGaussian}P.random=Y,Y.prototype=new r,Y.prototype.fn=function(){return 2*Math.random()-1+(2*Math.random()-1)+(2*Math.random()-1)},Y.prototype.correl=function(t){return P.correl(this,t)},Y.prototype.wiener=function(){return P.wiener(this)},P.wiener=F,F.prototype=new r,F.prototype.rawDates=function(t){var e={};return t&&t.cache[this.ID]&&t.cache[this.ID].dates&&t.cache[this.ID].dates.forEach(function(t){e[t]=t}),e},F.prototype.fn=function(t,e){var n,r=t.cache[this.ID];if(!r.dates)return r.dates=[e],r.first={x:e,y:0},r.last={x:e,y:0},0;if(e>r.last.x)return r.dates.push(e),n=r.last.y+t.fetch(this.random,e)*(e-r.last.x)/P.util.DAYMS/365.25,r.last={x:e,y:n},n;if(r.first.x>e)return r.dates.slice(0,0,e),n=r.min.y-t.fetch(this.random,e)*(r.first.x-e)/P.util.DAYMS/365.25,r.first={x:e,y:n},n;var a=P.util.bisect(r.dates,e),i={x:r.dates[a-1]},o={x:r.dates[a]};return i.y=t.fetch(this,i.x),o.y=t.fetch(this,o.x),r.dates.splice(a,0,e),i.y+(e-i.x)/(o.x-i.x)*(o.y-i.y)},F.prototype.dates=function(t){return t?t.cache[this.ID].dates.all:[]},P.logNorm=function(t,e,n){return new Norm(t,e,n)},E.prototype=new F,E.prototype.inputs=function(){return[this.s,this.r,this.vol]},E.prototype.fn=function(t,e){if(0==t.cache[this.ID].values.length){var n=new Date;t.cache[this.ID].values[n]=a,t.fetch(this.parent,n)}return i*Math.sqrt(r)*t.fetch(this.parent,e);var r,a,i},P.correl=N,N.prototype=new Y,N.prototype.fn=function(t,e,n){var r=t.fetch(this.args.correl,e,n);return r*t.fetch(this.args.parent,e,n)+Math.sqrt(1-r*r)*t.fetch(this.args.random,e,n)},P.simul=C,C.prototype=new n,C.prototype.fetch=function(t,e,n){if(!isNaN(t))return t;var r=this.cache[t.ID].values;if(r[e]=r[e]||[],void 0===r[e][n]){var a=t.fn(this,e.valueOf(),n);void 0!==a&&(r[e][n]=a)}return r[e][n]},C.prototype.get=function(t){return[].concat(this.dates(t)).map(function(e){for(var n=[],r=this.num;r--;)n.push(this.fetch(t,e.valueOf(),r));return n},this)}})();