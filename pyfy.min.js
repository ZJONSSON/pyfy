/**
  * pyfy.js (c) 2008-2013 Sigurgeir Orn Jonsson (ziggy.jonsson.nyc@gmail.com)
  * @license http://creativecommons.org/licenses/by-nc-sa/3.0/
  * Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported (CC BY-NC-SA 3.0)
  */
(function(){function t(t,n){return+t-n}function n(t){return t}function e(){return this instanceof e?(this.cache={},void 0):new e}function r(){return this instanceof r?(this.ID=E++,void 0):new r}function a(t,n){return this instanceof a?(this.const=t||0,void 0):new a(t,n)}function i(t){return this instanceof i?(this.parents=t,void 0):new i(t)}function o(t,n){return this instanceof o?(r.apply(this,arguments),this.data={},this._dates=[],t&&this.update(t),void 0):new o(t,n)}function s(t,n){return this instanceof s?(o.apply(this,arguments),void 0):new s(t,n)}function u(t,n){return this instanceof u?(o.apply(this,arguments),void 0):new u(t,n)}function h(t,n){return this instanceof h?(o.apply(this,arguments),void 0):new h(t,n)}function c(t,n){return this instanceof c?(r.call(this,arguments),this.parent=t||new r,n&&(this.fn=n),void 0):new c(t,n)}function f(t,n,e){return this instanceof f?(c.call(this,t),this.start=n||-1/0,this.fin=e||1/0,void 0):new f(t,n,e)}function p(t,n){return this instanceof p?(c.call(this,t),this.default=n||0,void 0):new p(t,n)}function d(t){return this instanceof d?(c.call(this,t),void 0):new d(t)}function y(t){return this instanceof y?(c.call(this,t),void 0):new y}function l(t,n){return this instanceof l?(c.call(this,t),this.max=n||0,void 0):new l(t,n)}function v(t,n){return this instanceof v?(c.call(this,t),this.min=n||0,void 0):new v}function w(t){return this instanceof w?(c.call(this,t),void 0):new w}function D(t){return this instanceof D?(c.call(this,t),this.start=t||0,void 0):new D(t)}function g(t,n){return this instanceof g?(c.call(this,t),n&&(this.calendar=n),void 0):new g}function m(t,n,e){return this instanceof m?(r.apply(this,arguments),this.left=n,this.right=e,this.op=t,void 0):new m(t,n,e)}function M(t,n){return this instanceof M?(c.call(this,t),void 0!==n&&this.setDaycount(n),void 0):new m(t,n)}function x(t,n){return this instanceof x?(u.apply(this,arguments),this.df=new _(this),this.daycount=O.daycount.d_30_360,void 0):new x(t,n)}function _(t,n){c.call(this,t),this.val=n}function b(){function t(){var t=e(),r=127&t;return u[r]>Math.abs(t)?t*o[r]:n(t,r)}function n(t,n){for(var a,i,h=3.442619855899,c=1/h;;){if(a=t*o[n],0===n){for(a=-Math.log(r())*c,i=-Math.log(r());a*a>i+i;)a=-Math.log(r())*c,i=-Math.log(r());return t>0?h+a:-h-a}if(Math.exp(-.5*a*a)>s[n]+r()*(s[n-1]-s[n]))return a;if(t=e(),n=127&t,u[n]>Math.abs(t))return t*o[n]}}function e(){var t=i,n=i;return n^=n<<13,n^=n>>>17,n^=n<<5,i=n,0|t+n}function r(){return.5*(1+e()/-Math.pow(2,31))}function a(){i^=(new Date).getTime();var t=2147483648,n=3.442619855899,e=n,r=.00991256303526217,a=r/Math.exp(-.5*n*n);u[0]=Math.floor(n/a*t),u[1]=0,o[0]=a/t,o[127]=n/t,s[0]=1,s[127]=Math.exp(-.5*n*n);for(var h=126;h>=1;h--)n=Math.sqrt(-2*Math.log(r/n+Math.exp(-.5*n*n))),u[h+1]=Math.floor(n/e*t),e=n,s[h]=Math.exp(-.5*n*n),o[h]=n/t}var i=123456789,o=Array(128),s=Array(128),u=Array(128);this.nextGaussian=function(){return t()},a()}function I(){return 2*Math.random()-1+(2*Math.random()-1)+(2*Math.random()-1)}function Y(t,n,e){return this instanceof Y?(r.apply(this),this.s=t||0,this.r=n||0,this.vol=e||0,void 0):new Y(t,n,e)}function I(){return 2*Math.random()-1+(2*Math.random()-1)+(2*Math.random()-1)}function F(){return this instanceof F?(r.apply(this),this.change=this.diff(this),void 0):new F}var O=this.pyfy={};"undefined"!=typeof module&&(module.exports=O),O.util={},O.util.DAYMS=864e5,O.util.dateParts=function(t){t=new Date(t);var n={y:t.getFullYear(),m:t.getMonth(),d:t.getDate()};return n.date=new Date(n.y,n.m,n.d),n.lastofMonth=new Date(n.y,n.m,n.d+1).getMonth()==n.m+1,n.lastFeb=2==n.m&&n.lastofMonth,n},O.util.today=function(){return O.util.dateParts(new Date).date},O.util.nextDay=function(t,n){return void 0===n&&(n=0),new Date(t.getFullYear(),t.getMonth(),t.getDate()+n)},O.util.bisect=function(t,e,r,a){for(3>arguments.length&&(r=0),4>arguments.length&&(a=t.length);a>r;){var i=r+a>>>1;e>n.call(t,t[i],i)?r=i+1:a=i}return r},O.Query=e,O.query=function(t,n){return n=n||new e,t&&(n.cache[t]=n.cache[t]||{values:{}},n.cache[t].values=n.cache[t].values||{}),n},e.prototype.getCache=function(t){return this.cache[t.ID]||(this.cache[t.ID]={values:{}})},e.prototype.dates=function(n){var e=this.getCache(n);return e.dates||(e.dates=n.dates(this).map(function(t){return t.valueOf()}).sort(t)),e.dates},e.prototype.y=function(t,n){return this.get(t,n)},e.prototype.x=function(t){return this.dates(t).map(function(t){return new Date(t)})},e.prototype.val=function(t,n){return n=n||this.dates(t),n=[].concat(n),this.get(t,n).map(function(t,e){return{x:new Date(n[e]),y:t}},this)},e.prototype.get=function(t,n){return n||(n=this.dates(t)),[].concat(n).map(function(n){return this.fetch(t,n.valueOf())},this)},e.prototype.fetch=function(t,n){if(!isNaN(t))return t;var e=this.getCache(t).values;if(void 0===e[n]){var r=t.fn(this,n.valueOf());void 0!==r&&(e[n]=r)}return e[n]};var E=0;O.base=O.Base=r,r.prototype.dates=function(n){var e=this.rawDates(n),r=[];for(var a in e)r.push(new Date(+e[a]));return r.sort(t)},r.prototype.rawDates=function(t){t=O.query(this.ID,t);var n=t.cache[this.ID];if(!n.rawDates){n.rawDates={};var e="function"==typeof this.inputs?this.inputs():this.inputs;[].concat(e).filter(function(t){return t&&t.rawDates}).forEach(function(e){for(var r in e.rawDates(t))n.rawDates[r]=+r})}return n.rawDates},r.prototype.fn=function(){return 0},[d,y,p,l,v,w,g,M,f,c].forEach(function(t){r.prototype[t.name.toLowerCase()]=function(n,e,r){return new t(this,n,e,r)}}),r.prototype.pv=function(t){var n=0;return isNaN(t)||(t=O.ir(t)),this.mul(t.df).y().forEach(function(t){n+=t}),n},r.prototype.y=function(t){return O.query().get(this,t)},r.prototype.x=function(t){return O.query().y(this,t)},r.prototype.val=function(t){return O.query().val(this,t)},O.const=a,a.prototype=new r,a.prototype.fn=function(){return this.const},a.prototype.update=a.prototype.set=function(t){return this.const=t,this},O.sum=i,i.prototype=new r,i.prototype.inputs=function(){return this.parents},i.prototype.fn=function(t,n){var e=0;return this.parents.forEach(function(r){e+=t.fetch(r,n)}),e},O.data=O.Data=o,o.prototype=new r,o.prototype.rawDates=function(t){t=O.query(this.ID,t);var n=t.cache[this.ID];return n.rawDates||(n.rawDates={},this._dates.forEach(function(t){n.rawDates[t]=t})),n.rawDates},o.prototype.update=function(n){if(0===arguments.length)return this;if(isNaN(n))[].concat(n).forEach(function(t){this.data[t.x.valueOf()]=t.y},this);else{var e=O.util.today().valueOf();this.data[e]=n}return this._dates=Object.keys(this.data).map(function(t){return+t}).sort(t),this},o.prototype.set=function(t){return this.data={},this.update(t)},o.prototype.fn=function(t,n){if(!Object.keys(this.data).length)return 0;if(this.data[n])return this.data[n];var e=t.dates(this),r=O.util.bisect(e,n),a=r-1;return r==e.length&&(r-=1),0===r&&(a=0),this._fn(n,e[a]||e[r],e[r])},o.prototype._fn=function(){return void 0},O.flow=s,s.prototype=new o,s.prototype.fn=function(t,n){return this.data[n]||0},O.stock=u,u.prototype=new o,u.prototype._fn=function(t,n){return this.data[n]},O.price=h,h.prototype=new o,h.prototype._fn=function(t,n,e){var r=this.data[n],a=this.data[e];return n==e?a:e>(t>n)?r+(a-r)*(t-n)/(e-n):a},O.interval=function(t,n,e,r){for(var a=[],i=0;e+1>i;i++)a.push({x:new Date(t.getFullYear(),t.getMonth()+i*n,t.getDate()),y:r||!i?0:1});return O.flow(a)},O.derived=O.Derived=c,c.prototype=new r,c.prototype.inputs=function(){return this.parent},c.prototype.fn=function(t,n){return t.fetch(this.parent,n)},c.prototype.setParent=function(t){return this.parent=t,this},O.period=f,f.prototype=new c,f.prototype.fn=function(t,n){return n>=this.start&&this.fin>=n?t.fetch(this.parent,n):0},O.prev=p,p.prototype=new c,p.prototype.fn=function(t,n){var e=t.dates(this),r=O.util.bisect(e,n);return r>0?t.fetch(this.parent,e[r-1]):this.default},O.cumul=d,d.prototype=new c,d.prototype.fn=function(t,n){var e=t.dates(this),r=O.util.bisect(e,n);return t.fetch(this.parent,n)+(r?t.fetch(this,e[r-1]):0)},O.diff=y,y.prototype=new c,y.prototype.fn=function(t,n){var e=t.dates(this),r=O.util.bisect(e,n);return r?t.fetch(this.parent,n)-t.fetch(this.parent,e[r-1]):0},O.max=l,l.prototype=new c,l.prototype.fn=function(t,n){return Math.max(t.fetch(this.parent,n),this.max)},O.min=v,v.prototype=new c,v.prototype.fn=function(t,n){return Math.min(t.fetch(this.parent,n),this.min)},O.Neg=w,w.prototype=new c,w.prototype.fn=function(t,n){return-t.fetch(this.parent,n)},O.acct=D,D.prototype=new c,D.prototype.fn=function(t,n){var e=t.dates(this.parent),r=O.util.bisect(e,n);return 1>r?this.start:e[r]==n?t.fetch(this,e[r-1])+t.fetch(this.parent,n):t.fetch(this,e[r-1])},O.Calendar=g,g.prototype=new c,g.prototype.rawDates=function(t){t=O.query(this.ID,t);var n=t.cache[this.ID];n.dateMap={},n.rawDates={};for(var e in this.parent.rawDates(t)){var r=this.calendar(new Date(+e)).valueOf();n.rawDates[r]=+r,n.dateMap[r]=+e}return n.rawDates},g.prototype.fn=function(t,n){var e=t.cache[this.ID];return t.fetch(this.parent,e.dateMap[n]||this.calendar(n))},g.prototype.calendar=function(t){var n=t.getDay();return 0===n||6===n?this.calendar(new Date(t.getFullYear(),t.getMonth(),t.getDate()+1)):t},O.operator=O.Operator=m;var q={add:function(t,n){return t+n},sub:function(t,n){return t-n},mul:function(t,n){return t*n},div:function(t,n){return t/n},pow:function(t,n){return Math.pow(t,n)}};Object.keys(q).forEach(function(t){r.prototype[t]=function(n){return new m(t,this,n)}}),m.prototype=new r,m.prototype.inputs=function(){return[this.left,this.right]},m.prototype.fn=function(t,n){var e,r;return r=t.fetch(this.right,n),r||"mul"!=this.op?(e=t.fetch(this.left,n),q[this.op](e,r)):0},O.daycount=O.daycount||{},O.daycount.d_30_360=function(t,n){return 31==t.d&&(t.d=30),30==t.d&&31==n.d&&(n.d=30),(360*(n.y-t.y)+30*(n.m-t.m)+(n.d-t.d))/360},O.daycount.d_30E_360=function(t,n){return 31==t.d&&(t.d=30),31==n.d&&(n.d=30),(360*(n.y-t.y)+30*(n.m-t.m)+(n.d-t.d))/360},O.daycount.d_30_360US=function(t,n){return t.lastofFeb&&n.lastofFeb&&(n.d=30),t.lastofFeb&&(t.d=30),31!=n.d||30!=t.d&&31!=t.d||(n.d=30),31==t.d&&(t.d=30),(360*(n.y-t.y)+30*(n.m-t.m)+(n.d-t.d))/360},O.daycount.d_act_360=function(t,n){return Math.round((n.date-t.date)/O.util.DAYMS)/360},O.daycount.d_act_act=function(t,n){for(var e=0,r=t.date,a=new Date(Math.min(new Date(r.getFullYear()+1,0,1),n.date));n.date>r;){var i=new Date(r.getFullYear(),1,29),o=29==i.getDate()?366:365;e+=Math.round((a-r)/O.util.DAYMS)/o,r=a,a=new Date(Math.min(new Date(r.getFullYear()+1,0,1),n.date))}return e},O.dcf=M,M.prototype=new c,M.prototype.fn=function(t){var n=t.cache[this.ID];if(Object.keys(n.values).length)return 0;var e=t.dates(this);n.values={},e.slice(1).forEach(function(t,r){var a=O.util.dateParts(e[r]),i=O.util.dateParts(t);n.values[t]=this.daycount(a,i)},this)},M.prototype.daycount=O.daycount.d_30_360,M.prototype.setDaycount=function(t){return this.daycount="string"==typeof t?O.daycount[t]:t,this},O.ir=x,x.prototype=new u,x.prototype.setDaycount=function(t){return this.daycount="string"==typeof t?O.daycount[t]:t,this},x.prototype._fn=function(t,n,e){return this.data[e]},O.df=function(t){return new c(t)},_.prototype=new M,_.prototype.fn=function(t,n){var e=t.dates(this),r=O.util.bisect(e,n),a=e[r-1];if(!a)return n==e[r]?1:0;var i=this.parent.daycount(O.util.dateParts(a),O.util.dateParts(n));return t.fetch(this,a)*Math.exp(-t.fetch(this.parent,n)*i)};var A=new b,I=O.rndNorm=A.nextGaussian;O.norm=Y,Y.prototype=new r,Y.prototype.inputs=function(){return[this.s,this.r,this.vol]},Y.prototype.fn=function(t,n,e){var r=this.s;t.__dates__;var a=(t.dates[e]-(t.dates[e-1]||t.dates[0]))/365,r=e>0?this.fetch(t,n,e-1):this.s,i=fetch(this.r,t,n,e),o=fetch(this.vol,t,n,e),s=(i-Math.pow(o,2)/2)*a+o*Math.sqrt(a)*I();return r*Math.exp(s)},O.wiener=F,F.prototype=new r,F.prototype.rawDates=function(t){var n={};return t&&t.cache[this.ID].dates&&t.cache[this.ID].dates.forEach(function(t){n[t]=t}),n},F.prototype.fn=function(t,n){var e,r=t.cache[this.ID];if(!r.dates)return r.dates=[n],r.first={x:n,y:0},r.last={x:n,y:0},0;if(n>r.last.x)return r.dates.push(n),e=r.last.y+I()*(n-r.last.x)/O.util.DAYMS/365.25,r.last={x:n,y:e},e;if(r.first.x>n)return r.dates.slice(0,0,n),e=r.min.y-I()*(r.first.x-n)/O.util.DAYMS/365.25,r.first={x:n,y:e},e;var a=O.util.bisect(r.dates,n),i={x:r.dates[a-1]},o={x:r.dates[a]};return i.y=t.fetch(this,i.x),o.y=t.fetch(this,o.x),r.dates.splice(a,0,n),i.y+(n-i.x)/(o.x-i.x)*(o.y-i.y)},F.prototype.dates=function(t){return t?t.cache[this.ID].dates.all:[]}})();