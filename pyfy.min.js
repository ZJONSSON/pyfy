/**
  * pyfy.js (c) 2008-2013 Sigurgeir Orn Jonsson (ziggy.jonsson.nyc@gmail.com)
  * @license http://creativecommons.org/licenses/by-nc-sa/3.0/
  * Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported (CC BY-NC-SA 3.0)
  */
(function(){function t(t,n){return+t-n}function n(t,n,e,r){return t.fetch?t.fetch(n,e,r):t}function e(t){this.rawDates={},this.cache={},this.cache[t]={values:[]}}function r(){this.ID=F++}function o(t){this.const=t||0}function a(t){this.parents=t}function i(t){r.apply(this,arguments),this.data={},this._dates=[],t&&this.update(t)}function u(){i.apply(this,arguments)}function s(){i.apply(this,arguments)}function h(){i.apply(this,arguments)}function c(t,n){r.call(this,arguments),this.parent=t||new r,n&&(this.fn=n)}function p(t,n,e){c.call(this,t),this.start=n||-1/0,this.fin=e||1/0}function f(t){c.call(this,t)}function y(t){c.call(this,t)}function d(t){c.call(this,t)}function l(t,n){c.call(this,t),this.max=n||0}function w(t,n){c.call(this,t),this.min=n||0}function D(t){c.call(this,t)}function v(t,n,e){r.apply(this,arguments),this.left=n,this.right=e,this.op=t}function m(t,n){c.call(this,t),void 0!==n&&this.setDaycount(n)}function g(){s.apply(this,arguments),this.df=new M(this)}function M(t,n){c.call(this,t),this.val=n}function x(){function t(){var t=e(),r=127&t;return s[r]>Math.abs(t)?t*i[r]:n(t,r)}function n(t,n){for(var o,a,h=3.442619855899,c=1/h;;){if(o=t*i[n],0===n){for(o=-Math.log(r())*c,a=-Math.log(r());o*o>a+a;)o=-Math.log(r())*c,a=-Math.log(r());return t>0?h+o:-h-o}if(Math.exp(-.5*o*o)>u[n]+r()*(u[n-1]-u[n]))return o;if(t=e(),n=127&t,s[n]>Math.abs(t))return t*i[n]}}function e(){var t=a,n=a;return n^=n<<13,n^=n>>>17,n^=n<<5,a=n,0|t+n}function r(){return.5*(1+e()/-Math.pow(2,31))}function o(){a^=(new Date).getTime();var t=2147483648,n=3.442619855899,e=n,r=.00991256303526217,o=r/Math.exp(-.5*n*n);s[0]=Math.floor(n/o*t),s[1]=0,i[0]=o/t,i[127]=n/t,u[0]=1,u[127]=Math.exp(-.5*n*n);for(var h=126;h>=1;h--)n=Math.sqrt(-2*Math.log(r/n+Math.exp(-.5*n*n))),s[h+1]=Math.floor(n/e*t),e=n,u[h]=Math.exp(-.5*n*n),i[h]=n/t}var a=123456789,i=Array(128),u=Array(128),s=Array(128);this.nextGaussian=function(){return t()},o()}function I(){return 2*Math.random()-1+(2*Math.random()-1)+(2*Math.random()-1)}function _(t,n,e){r.apply(this),this.s=t||0,this.r=n||0,this.vol=e||0}var b=this.pyfy={};"undefined"!=typeof module&&(module.exports=b),b.util={},b.util.DAYMS=864e5,b.util.dateParts=function(t){var n={y:t.getFullYear(),m:t.getMonth(),d:t.getDate()};return n.date=new Date(n.y,n.m,n.d),n.lastofMonth=new Date(n.y,n.m,n.d+1).getMonth()==n.m+1,n.lastFeb=2==n.m&&n.lastofMonth,n},b.util.today=function(){return pyty.util.dateParts(new Date)},b.util.nextDay=function(t,n){return void 0===n&&(n=0),new Date(t.getFullYear(),t.getMonth(),t.getDate()+n)},e.prototype.register=function(t){this.cache[t]||(this.cache[t]={})},e.prototype.y=function(t){return this.cache[t].values},e.prototype.x=function(){return this.dates},e.prototype.val=function(t){return this.y(t).map(function(t,n){return{x:this.dates[n],y:t}},this)};var F=0;b.base=function(){return new r},b.Base=r,r.prototype.dates=function(n,r){r=r||new e(this.ID),r.dates=[];var o=this.rawDates(r);n&&[].concat(n).forEach(function(t){r.rawDates[t]=t});for(var a in o)r.dates.push(o[a]);return r.dates.sort(t)},r.prototype.rawDates=function(t){if(t=t||new e(this.ID),t.cache[this.ID]=t.cache[this.ID]||{},!t.cache[this.ID].rawDates&&this.inputs){var n="function"==typeof this.inputs?this.inputs():this.inputs;t.cache[this.ID].rawDates=!0,[].concat(n).forEach(function(n){n.rawDates&&n.rawDates(t)})}return t.rawDates},r.prototype.y=function(t){return this.exec(t).y(this.ID)},r.prototype.x=function(t){return this.dates(t)},r.prototype.val=function(t){return this.exec(t).val(this.ID)},r.prototype.exec=function(t){var n=new e,r=n.dates=this.dates(t),o=r.length;return n.cache[this.ID]=n.cache[this.ID]||{},n.cache[this.ID].values=[],r.every(function(t,e){return this.fetch(n,t,e),n.cache[this.ID].values.length!=o},this),n},r.prototype.fetch=function(t,n,e){if(t.cache[this.ID]||(t.cache[this.ID]={}),t.cache[this.ID].values||(t.cache[this.ID].values=[]),void 0===t.cache[this.ID].values[e]){var r=this.fn(t,n,e);void 0!==r&&(t.cache[this.ID].values[e]=r)}return t.cache[this.ID].values[e]},[y,d,f,l,w,D,m].forEach(function(t){r.prototype[t.name.toLowerCase()]=function(n){return new t(this,n)}}),r.prototype.pv=function(t,n,e){var r=0;return this.mul(t.df(n)).y(null,e).forEach(function(t){r+=t}),r},r.prototype.derived=function(t){return new c(this,t)},r.prototype.period=function(t,n){return new p(this,t,n)},r.prototype.fn=function(){return 0},b.const=b.c=function(t){return r.apply(this,arguments),new o(t)},o.prototype=new r,o.prototype.fn=function(){return this.const},o.prototype.update=o.prototype.set=function(t){return this.const=t,this},b.sum=function(t){return new a(t)},a.prototype=new r,a.prototype.inputs=function(){return this.parents},a.prototype.fn=function(t,n,e){var r=0;return this.parents.forEach(function(n){r+=n.fetch(t,n,e)}),r},b.Data=i,i.prototype=new r,i.prototype.rawDates=function(t){return t=t||new e,t.cache[this.ID]=t.cache[this.ID]||{},t.cache[this.ID].rawDates||(this._dates.forEach(function(n){t.rawDates[n]=n}),t.cache[this.ID].rawDates=!0),t.rawDates},i.prototype.update=function(n){if(0===arguments.length)return this;var e=this;if(isNaN(n))void 0===n.length&&(n=[n]),n.forEach(function(t){e.data[t.x]=t});else{var r=today();this.data[r]={x:r,y:n}}return this._dates=Object.keys(this.data).map(function(t){return this.data[t].x},this).sort(t),this},i.prototype.set=function(t){return this.data={},this.update(t)},i.prototype.fn=function(t,n,e){var r=this,o=this.dates(),a=this.data[o[0]],i=this.data[o[o.length-1]];return t.cache[this.ID].values=t.dates.map(function(t){if(!Object.keys(r.data).length)return 0;for(;o.length;){var n=r.data[o[0]];if(t==n.x)return n.y;if(n.x>t)return r._fn(t,a,n);a=n,o=o.slice(1)}return i.y}),t.cache[this.ID].values[e]},i.prototype._fn=function(){return void 0},b.flow=function(t){return new u(t)},b.Flow=u,u.prototype=new i,u.prototype.fn=function(t,n,e){var r=this;return t.cache[this.ID].values=t.dates.map(function(t){return r.data[t]?r.data[t].y:0}),t.cache[this.ID].values[e]},b.Stock=s,b.stock=function(t){return new s(t)},s.prototype=new i,s.prototype._fn=function(t,n){return n.y},b.Price=h,b.price=function(t){return new h(t)},h.prototype=new i,h.prototype._fn=function(t,n,e){return e.x==n.x?n.y:e.x>t?n.y+(e.y-n.y)*(t-n.x)/(e.x-n.x):void 0},b.interval=function(t,n,e,r){for(var o=[],a=0;e>a;a++)o.push({x:t=new Date(t.getFullYear(),t.getMonth()+n,t.getDate()),y:r||1});return b.flow(o)},b.Derived=c,c.prototype=new r,c.prototype.inputs=function(){return this.parent},c.prototype.fn=function(t,n,e){return this.parent.fetch(t,n,e)},c.prototype.setParent=function(t){return this.parent=t,this},b.Period=p,p.prototype=new c,p.prototype.fn=function(t,n,e){return n>=this.start&&this.fin>=n?this.parent.fetch(t,n,e):0},b.Last=f,f.prototype=new c,f.prototype.fn=function(t,n,e){return 0+(e>0&&this.parent.fetch(t,n,e-1))},b.Cumul=y,y.prototype=new c,y.prototype.fn=function(t,n,e){return this.parent.fetch(t,n,e)+(e>0&&t.cache[this.ID].values[e-1])},b.Diff=d,d.prototype=new c,d.prototype.fn=function(t,n,e){var r=Math.max(e-1,0);return+this.parent.fetch(t,n,e)-(this.parent.fetch(t,n,r)||0)},b.Max=l,l.prototype=new c,l.prototype.fn=function(t,n,e){return Math.max(this.parent.fetch(t,n,e),this.max)},b.Min=w,w.prototype=new c,w.prototype.fn=function(t,n,e){return Math.min(this.parent.fetch(t,n,e),this.min)},b.Neg=D,D.prototype=new c,D.prototype.fn=function(t,n,e){return-this.parent.fetch(t,n,e)},b.Operator=v;var E={add:function(t,n){return t+n},sub:function(t,n){return t-n},mul:function(t,n){return t*n},div:function(t,n){return t/n},pow:function(t,n){return Math.pow(t,n)}};Object.keys(E).forEach(function(t){r.prototype[t]=function(n){return new v(t,this,n)}}),b.Operator=v,v.prototype=new r,v.prototype.inputs=function(){return[this.left,this.right]},v.prototype.fn=function(t,e,r){var o,a;return a=n(this.right,t,e,r),a||"mul"!=this.op?(o=n(this.left,t,e,r),E[this.op](o,a)):0},b.daycount=b.daycount||{},b.daycount.d_30_360=function(t,n){return 31==t.d&&(t.d=30),30==t.d&&31==n.d&&(n.d=30),(360*(n.y-t.y)+30*(n.m-t.m)+(n.d-t.d))/360},b.daycount.d_30E_360=function(t,n){return 31==t.d&&(t.d=30),31==n.d&&(n.d=30),(360*(n.y-t.y)+30*(n.m-t.m)+(n.d-t.d))/360},b.daycount.d_30_360US=function(t,n){return t.lastofFeb&&n.lastofFeb&&(n.d=30),t.lastofFeb&&(t.d=30),31!=n.d||30!=t.d&&31!=t.d||(n.d=30),31==t.d&&(t.d=30),(360*(n.y-t.y)+30*(n.m-t.m)+(n.d-t.d))/360},b.daycount.d_act_360=function(t,n){return Math.round((n.date-t.date)/b.util.DAYMS)/360},b.daycount.d_act_act=function(t,n){for(var e=0,r=t.date,o=new Date(Math.min(new Date(r.getFullYear()+1,0,1),n.date));n.date>r;){var a=new Date(r.getFullYear(),1,29),i=29==a.getDate()?366:365;e+=Math.round((o-r)/b.util.DAYMS)/i,r=o,o=new Date(Math.min(new Date(r.getFullYear()+1,0,1),n.date))}return e},b.Dcf=m,m.prototype=new c,m.prototype.fn=function(t){var n=this.dates(),e={};n.slice(1).map(function(t,r){var o=b.util.dateParts(n[r]),a=b.util.dateParts(t);e[t]=this.daycount(o,a)},this),t.cache[this.ID].values=t.dates.map(function(t){return e[t]||0})},m.prototype.daycount=b.daycount.d_30_360,m.prototype.setDaycount=function(t){return this.daycount="string"==typeof t?b.daycount[t]:t,this},b.ir=function(t){return new g(t)},g.prototype=new s,b.df=function(t){return new M(t)},M.prototype=new c,M.prototype.fn=function(t,e,r){var o=this,a=t.__dt__[r]/365;return 0===r?1:n(this,t,e,r-1)*Math.exp(-n(o.parent,t,e,r)*a)};var Y=new x,I=b.rndNorm=Y.nextGaussian;b.norm=function(t,n,e){return new _(t,n,e)},_.prototype=new r,_.prototype.inputs=function(){return[this.s,this.r,this.vol]},_.prototype.fn=function(t,e,r){var o=this.s;t.__dates__;var a=(t.dates[r]-(t.dates[r-1]||t.dates[0]))/365,o=r>0?this.fetch(t,e,r-1):this.s,i=n(this.r,t,e,r),u=n(this.vol,t,e,r),s=(i-Math.pow(u,2)/2)*a+u*Math.sqrt(a)*I();return o*Math.exp(s)}})();