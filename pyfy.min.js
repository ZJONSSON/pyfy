/**
  * pyfy.js (c) 2008-2013 Sigurgeir Orn Jonsson (ziggy.jonsson.nyc@gmail.com)
  * @license http://creativecommons.org/licenses/by-nc-sa/3.0/
  * Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported (CC BY-NC-SA 3.0)
  */
(function(){function t(t,e){return+t-e}function e(t){return t}function n(t){return this instanceof n?(this.cache={options:t},void 0):new n(t)}function r(){return this instanceof r?(this.ID=S++,this.args={},this.version=0,this.cache=!0,void 0):new r}function a(t,e){return this instanceof a?(r.call(this),this.args.const=t||0,void 0):new a(t,e)}function i(t,e,n,a,s,o,h,u){return this instanceof i?(r.call(this),Array.prototype.slice.call(arguments).map(function(t,e){t&&(this.args[e]=t)},this),void 0):new i(t,e,n,a,s,o,h,u)}function s(t,e){return this instanceof s?(r.apply(this,arguments),this.args.data={},t&&this.update(t),void 0):new s(t,e)}function o(t,e){return this instanceof o?(s.apply(this,arguments),void 0):new o(t,e)}function h(t,e){return this instanceof h?(s.apply(this,arguments),void 0):new h(t,e)}function u(t,e){return this instanceof u?(s.apply(this,arguments),void 0):new u(t,e)}function c(t,e){return this instanceof c?(s.apply(this,arguments),void 0):new c(t,e)}function f(t,e,n){return this instanceof f?(r.call(this),this.args.parent=t,this.args.start=e||-1/0,this.args.fin=n||1/0,void 0):new f(t,e,n)}function p(t,e){return this instanceof p?(r.call(this),this.args.parent=t,this.args.start=e||0,void 0):new p(t,e)}function l(t){return this instanceof l?(r.call(this),this.args.parent=t,void 0):new r(t)}function y(t){return this instanceof y?(r.call(this),this.args.parent=t,void 0):new y(t)}function g(t,e){return this instanceof g?(r.call(this),this.args.parent=t,this.args.max=e||0,void 0):new g(t,e)}function v(t,e){return this instanceof v?(r.call(this),this.args.parent=t,this.args.min=e||0,void 0):new v(t,e)}function w(t){return this instanceof w?(r.call(this),this.args.parent=t,void 0):new w(t)}function D(t){return this instanceof D?(r.call(this),this.args.parent=t,this.args.start=d||0,void 0):new r}function m(t,e){return this instanceof m?(r.call(this),this.args.parent=t,this.args.strike=e||0,void 0):new m(t)}function M(t,e){return this instanceof M?(r.call(this),this.args.parent=t,this.args.strike=e||0,void 0):new M(t)}function x(t,e){return this instanceof x?(r.call(this),this.args.parent=t,this.args.calendar=e||P.calendar.weekday,void 0):new x(t,e)}function b(t,e,n){return this instanceof b?(r.apply(this),this.args.left=e,this.args.right=n,this.op=t,void 0):new b(t,e,n)}function k(t,e){return this instanceof k?(r.call(this,t),this.args.parent=t,void 0!==e&&this.setDaycount(e),void 0):new b(t,e)}function _(t,e,n){return this instanceof _?(r.call(this,t),this.args.parent=t,this.args.daycount=n||P.daycount.d_30_360,this.args.date=e||new Date,void 0):new _(t,e,n)}function I(t,e){return this instanceof I?(h.apply(this,arguments),this.df=new Y(this),this.args.daycount=P.daycount.d_30_360,void 0):new I(t,e)}function Y(t,e){r.call(this,d),this.args.parent=t,this.args.val=e}function O(t,e,n,a,i,s){return this instanceof O?(r.apply(this),this.notional=i||1,this.daycount=s,this.rate=a,this.schedule=P.interval(t,e,n).div(n),this.generate(),void 0):new O(t,e,n,a,i,s)}function F(){function t(){var t=n(),r=127&t;return h[r]>Math.abs(t)?t*s[r]:e(t,r)}function e(t,e){for(var a,i,u=3.442619855899,c=1/u;;){if(a=t*s[e],0===e){for(a=-Math.log(r())*c,i=-Math.log(r());a*a>i+i;)a=-Math.log(r())*c,i=-Math.log(r());return t>0?u+a:-u-a}if(Math.exp(-.5*a*a)>o[e]+r()*(o[e-1]-o[e]))return a;if(t=n(),e=127&t,h[e]>Math.abs(t))return t*s[e]}}function n(){var t=i,e=i;return e^=e<<13,e^=e>>>17,e^=e<<5,i=e,0|t+e}function r(){return.5*(1+n()/-Math.pow(2,31))}function a(){i^=(new Date).getTime();var t=2147483648,e=3.442619855899,n=e,r=.00991256303526217,a=r/Math.exp(-.5*e*e);h[0]=Math.floor(e/a*t),h[1]=0,s[0]=a/t,s[127]=e/t,o[0]=1,o[127]=Math.exp(-.5*e*e);for(var u=126;u>=1;u--)e=Math.sqrt(-2*Math.log(r/e+Math.exp(-.5*e*e))),h[u+1]=Math.floor(e/n*t),n=e,o[u]=Math.exp(-.5*e*e),s[u]=e/t}var i=123456789,s=Array(128),o=Array(128),h=Array(128);this.nextGaussian=function(){return t()},a()}function C(){return this instanceof C?(r.call(this),void 0):new C}function E(t){return this instanceof E?(r.apply(this),this.change=this.diff(this),this.random=t||new C,this.inputs=[t],void 0):new E(t)}function A(t,e,n,a){return this instanceof A?(r.apply(this),this.args.spot=t,this.args.vol=e,this.args.drift=n,this.args.random=a||new C,void 0):new A(t,e,n,a)}function N(t,e,n,r){return Math.exp((e-t*t/2)*r+n*t*Math.sqrt(r))}function j(t,e,n){return this instanceof j?(C.call(this),this.args.parent=t,this.args.random=n||new C,this.args.correl=e,void 0):new j(t,e)}function q(t){return this instanceof q?(n.call(this),this.num=t,void 0):new q(t)}var P=this.pyfy={};"undefined"!=typeof module&&(module.exports=P),P.util={},P.util.DAYMS=864e5,P.util.dateParts=function(t){t=new Date(t);var e={y:t.getFullYear(),m:t.getMonth(),d:t.getDate()};return e.date=new Date(e.y,e.m,e.d),e.lastofMonth=new Date(e.y,e.m,e.d+1).getMonth()==e.m+1,e.lastFeb=2==e.m&&e.lastofMonth,e},P.util.today=function(){return P.util.dateParts(new Date).date},P.util.nextDay=function(t,e){return void 0===e&&(e=0),new Date(t.getFullYear(),t.getMonth(),t.getDate()+e)},P.util.nextWeekday=function(t,e){var n=t.getDay(),r=n>e?e+7-n:e-n;return new Date(t.getFullYear(),t.getMonth(),t.getDate()+r)},P.util.bisect=function(t,n,r,a){for(3>arguments.length&&(r=0),4>arguments.length&&(a=t.length);a>r;){var i=r+a>>>1;n>e.call(t,t[i],i)?r=i+1:a=i}return r},P.calendar={},P.calendar.weekday=function(t){var e=t.getDay();return 0!==e&&6!=e},P.calendar.easter=function(t,e){e=e||[1,-2];var n,r,a,i,s,o,h,u,c;return 4>(t.getMonth()>1)?(n=t.getFullYear(),r=~~(n/100),a=n-19*~~(n/19),i=~~((r-17)/25),s=r-~~(r/4)-~~((r-i)/3)+19*a+15,s-=30*~~(s/30),s-=s/28*(1-~~(s/28)*~~(29/(s+1))*~~((21-a)/11)),o=n+~~(n/4)+s+2-r+~~(r/4),o-=7*~~(o/7),h=s-o,u=3+~~((h+40)/44)-1,c=Math.round(h+28-31*~~(u/4)),e.every(function(e){return t-new Date(n,u,c+e)})):!0},P.calendar.target=function(t){var e=t.getMonth(),n=t.getDate();return!(!P.calendar.weekday(t)||!P.calendar.easter(t,[1,-2])||0===e&&1==n||11==e&&(26==n||25==n)||4==e&&1==n)},P.calendar.is=function(t){var e=t.getFullYear(),n=t.getMonth(),r=t.getDate();return!(!P.calendar.weekday(t)||!P.calendar.easter(t,[1,-2,-3,39,50])||5==n&&17==r||0===n&&1==r||11==n&&(26==r||25==r)||4==n&&1==r||7==n&&0===t-P.util.nextWeekday(new Date(e,7,1),1)||3==n&&0===t-P.util.nextWeekday(new Date(e,3,19),4))},P.query=n,n.prototype.initCache=function(t){if(!t.ID)return!1;var e=!this.cache[t.ID]||this.cache[t.ID].version!=t.version;return t.args&&Object.keys(t.args).forEach(function(n){var r=t.args[n];this.initCache(r)&&(e=!0)},this),e&&(this.cache[t.ID]={obj:t,values:{},version:t.version}),e},n.prototype.getCache=function(t){return this.initCache(t),this.cache[t.ID]},n.prototype.dates=function(e){var n=this.getCache(e);if(!n.dates){var r=this.rawDates(e),a=n.dates=[];for(var i in r)a.push(r[i]);a.sort(t)}return n.dates},n.prototype.rawDates=function(t,e){var n=this.getCache(t);return e=e||{},n&&!n.rawDates&&(t.args&&Object.keys(t.args).forEach(function(n){e=this.rawDates(t.args[n],e)},this),t.rawDates&&(e=t.rawDates(e,this))),e},n.prototype.y=function(t,e){return this.get(t,e)},n.prototype.x=function(t){return this.dates(t).map(function(t){return new Date(t)})},n.prototype.val=function(t,e){return e=e||this.dates(t),e=[].concat(e),this.get(t,e).map(function(t,n){return{x:new Date(e[n]),y:t}},this)},n.prototype.get=function(t,e){return this.initCache(t),e||(e=this.dates(t)),[].concat(e).map(function(e){return this.fetch(t,e.valueOf())},this)},n.prototype.fetch=function(t,e){if(!isNaN(t))return t;var n=this.cache[t.ID].values;if(void 0===n[e]){var r=t.fn(this,e.valueOf());void 0!==r&&t.cache&&(n[e]=r)}return n[e]};var S=0;P.base=P.Base=r,r.prototype.set=function(t,e){return 1==arguments.length?this.args[t]:(this.args[t]=e,this.version+=1,this)},r.prototype.useCache=function(t){return arguments.length?(this.cache=t,this):this.cache},r.prototype.fn=function(){return 0},r.prototype.rawDates=void 0,[l,y,p,g,v,w,x,k,f,_,m,M,A].forEach(function(t){r.prototype[t.name.toLowerCase()]=function(e,n,r){return new t(this,e,n,r)}}),r.prototype.pv=function(t){var e=0;return isNaN(t)||(t=P.ir(t)),this.mul(t.df).y().forEach(function(t){e+=t}),e},r.prototype.y=function(t){return P.query().get(this,t)},r.prototype.x=function(t){return P.query().x(this,t)},r.prototype.val=function(t){return P.query().val(this,t)},r.prototype.dates=function(){return P.query().dates(this).map(function(t){return new Date(t)})},P.const=a,a.prototype=new r,a.prototype.fn=function(){return this.args.const},P.sum=i,i.prototype=new r,i.prototype.fn=function(t,e,n){var r=0;return Object.keys(this.args).forEach(function(a){r+=t.fetch(this.args[a],e,n)},this),r},P.data=P.Data=s,s.prototype=new r,s.prototype.rawDates=function(t,e){return e&&e.options&&e.options.settle||new Date,t=t||{},Object.keys(this.args.data).forEach(function(e){t[+e]=+e}),t},s.prototype.update=function(t){if(0===arguments.length)return this;if(isNaN(t))[].concat(t).forEach(function(t){this.args.data[(t.x||t[0]).valueOf()]=t.y||t[1]},this);else{var e=P.util.today().valueOf();this.args.data[e]=t}return this},s.prototype.fn=function(t,e){if(!Object.keys(this.args.data).length)return 0;if(this.args.data[e])return this.args.data[e];var n=t.dates(this),r=P.util.bisect(n,e),a=r-1;return r==n.length&&(r-=1),0===r&&(a=0),this._fn(e,n[a]||n[r],n[r])},s.prototype._fn=function(){return void 0},P.flow=o,o.prototype=new s,o.prototype.fn=function(t,e){return this.args.data[e]||0},P.stock=h,h.prototype=new s,h.prototype._fn=function(t,e){return this.args.data[e]},P.price=u,u.prototype=new s,u.prototype._fn=function(t,e,n){var r=this.args.data[e],a=this.args.data[n];return e==n?a:n>(t>e)?r+(a-r)*(t-e)/(n-e):a},P.stream=c,c.prototype=new s,P.interval=function(t,e,n,r){t=t||P.util.today();for(var a=[],i=0;n+1>i;i++)a.push({x:new Date(t.getFullYear(),t.getMonth()+i*e,t.getDate()),y:i?r||1:0});return P.flow(a)},P.period=f,f.prototype=new r,f.prototype.rawDates=function(t){var e={};return t&&Object.keys(t).forEach(function(n){var r=t[n];r>=this.args.start&&this.args.fin>=r&&(e[r]=r)},this),e},f.prototype.fn=function(t,e,n){return e>=this.args.start&&this.args.fin>=e?t.fetch(this.args.parent,e,n):0},P.prev=p,p.prototype=new r,p.prototype.fn=function(t,e,n){var r=t.dates(this),a=P.util.bisect(r,e);return a>0?t.fetch(this.args.parent,r[a-1],n):this.args.start},P.cumul=l,l.prototype=new r,l.prototype.fn=function(t,e,n){var r=t.dates(this),a=P.util.bisect(r,e);return t.fetch(this.args.parent,e,n)+(a?t.fetch(this,r[a-1],n):0)},P.diff=y,y.prototype=new r,y.prototype.fn=function(t,e,n){var r=t.dates(this),a=P.util.bisect(r,e);return a?t.fetch(this.args.parent,e,n)-t.fetch(this.args.parent,r[a-1],n):0},P.max=g,g.prototype=new r,g.prototype.fn=function(t,e,n){return Math.max(t.fetch(this.args.parent,e,n),this.args.max)},P.min=v,v.prototype=new r,v.prototype.fn=function(t,e,n){return Math.min(t.fetch(this.args.parent,e,n),this.args.min)},P.Neg=w,w.prototype=new r,w.prototype.fn=function(t,e,n){return-t.fetch(this.args.parent,e,n)},P.acct=D,D.prototype=new r,D.prototype.fn=function(t,e,n){var r=t.dates(this.args.parent),a=P.util.bisect(r,e);return 1>a?this.start:r[a]==e?t.fetch(this,r[a-1],n)+t.fetch(this.args.parent,e,n):t.fetch(this,r[a-1],n)},P.call=m,m.prototype=new r,m.prototype.fn=function(t,e,n){return Math.max(t.fetch(this.args.parent,e,n)-this.args.strike,0)},P.call=M,M.prototype=new r,M.prototype.fn=function(t,e,n){return Math.max(this.args.strike-t.fetch(this.args.parent,e,n),0)},P.Calendar=x,x.prototype=new r,x.prototype.checkDate=function(t){function e(){return!r.every(function(e){var n="string"==typeof e?P.calendar[e]:e;return n(t)},this)}function n(){if(t=new Date(t.getFullYear(),t.getMonth(),t.getDate()+1),a++>31)throw"Calendar function always returns false"}t=new Date(t);for(var r=[].concat(this.args.calendar),a=0;e();)n();return t.valueOf()},x.prototype.rawDates=function(t,e){var n=e.cache[this.ID];t={},n.dateMap={};for(var r in this.args.parent.rawDates()){var a=this.checkDate(+r);t[a]=+a,n.dateMap[a]=+r}return t},x.prototype.fn=function(t,e){var n=t.cache[this.ID];return t.fetch(this.args.parent,n.dateMap[e]||this.calendar(e))},P.operator=P.Operator=b;var W={add:function(t,e){return t+e},sub:function(t,e){return t-e},mul:function(t,e){return t*e},div:function(t,e){return t/e},pow:function(t,e){return Math.pow(t,e)}};Object.keys(W).forEach(function(t){r.prototype[t]=function(e){return new b(t,this,e)}}),b.prototype=new r,b.prototype.fn=function(t,e,n){var r,a;return a=t.fetch(this.args.right,e,n),a||"mul"!=this.op?(r=t.fetch(this.args.left,e,n),W[this.op](r,a)):0},P.daycount=P.daycount||{},P.daycount.d_30_360=function(t,e){return 31==t.d&&(t.d=30),30==t.d&&31==e.d&&(e.d=30),(360*(e.y-t.y)+30*(e.m-t.m)+(e.d-t.d))/360},P.daycount.d_30E_360=function(t,e){return 31==t.d&&(t.d=30),31==e.d&&(e.d=30),(360*(e.y-t.y)+30*(e.m-t.m)+(e.d-t.d))/360},P.daycount.d_30_360US=function(t,e){return t.lastofFeb&&e.lastofFeb&&(e.d=30),t.lastofFeb&&(t.d=30),31!=e.d||30!=t.d&&31!=t.d||(e.d=30),31==t.d&&(t.d=30),(360*(e.y-t.y)+30*(e.m-t.m)+(e.d-t.d))/360},P.daycount.d_act_360=function(t,e){return Math.round((e.date-t.date)/P.util.DAYMS)/360},P.daycount.d_act_act=function(t,e){for(var n=0,r=t.date,a=new Date(Math.min(new Date(r.getFullYear()+1,0,1),e.date));e.date>r;){var i=new Date(r.getFullYear(),1,29),s=29==i.getDate()?366:365;n+=Math.round((a-r)/P.util.DAYMS)/s,r=a,a=new Date(Math.min(new Date(r.getFullYear()+1,0,1),e.date))}return n},P.dcf=k,k.prototype=new r,k.prototype.fn=function(t,e){var n=t.cache[this.ID];if(!Object.keys(n.values).length){var r=t.dates(this);n.values={},r.slice(1).forEach(function(t,e){var a=P.util.dateParts(r[e]),i=P.util.dateParts(t);n.values[t]=r[e]?this.daycount(a,i):0},this)}return n.values[e]||0},k.prototype.daycount=P.daycount.d_30_360,k.prototype.setDaycount=function(t){return this.daycount="string"==typeof t?P.daycount[t]:t,this},P.timeDiff=_,_.prototype=new r,_.prototype.fn=function(t,e){var n=this.args.date;if("string"==typeof n){var r=t.dates(this.args.parent);n=new Date("L"===n.slice(0,1).toUpperCase()?r[r.length-1]:r[0])}return Math.abs(this.args.daycount(P.util.dateParts(n),P.util.dateParts(new Date(e))))},P.ir=I,I.prototype=new h,I.prototype.setDaycount=function(t){return this.args.daycount="string"==typeof t?P.daycount[t]:t,this},I.prototype._fn=function(t,e,n){return this.args.data[n]},P.df=function(t){return new Derived(t)},Y.prototype=new r,Y.prototype.fn=function(t,e,n){var r=t.dates(this),a=P.util.bisect(r,e),i=r[a-1];if(!i)return e==r[a]?1:0;var s=this.parent.daycount(P.util.dateParts(i),P.util.dateParts(e));return t.fetch(this,i,n)*Math.exp(-t.fetch(this.args.parent,e,n)*s)},P.bond=O,O.prototype=new r,O.prototype.generate=function(){this.bal=P.acct(this.notional||1),this.p_scheduled=this.schedule.mul(this.notional),this.p=this.schedule.mul(this.notional),this.bal.setParent(this.p.neg()),this.i=this.bal.prev().dcf().mul(this.rate),this.set("parent",this.p.add(this.i))},O.prototype.setSchedule=function(t){return this.schedule=t,this.generate(),this};var G=new F;P.rndNorm=G.nextGaussian,P.random=C,C.prototype=new r,C.prototype.fn=function(){var t,e,n;do t=2*Math.random()-1,e=2*Math.random()-1,n=t*t+e*e;while(!n||n>1);return t*Math.sqrt(-2*Math.log(n)/n)},C.prototype.correl=function(t){return P.correl(this,t)},C.prototype.wiener=function(){return P.wiener(this)},P.wiener=E,E.prototype=new r,E.prototype.rawDates=function(t){var e={};return t&&t.cache[this.ID]&&t.cache[this.ID].dates&&t.cache[this.ID].dates.forEach(function(t){e[t]=t}),e},E.prototype.fn=function(t,e){var n,r=t.cache[this.ID];if(!r.dates)return r.dates=[e],r.first={x:e,y:0},r.last={x:e,y:0},0;if(e>r.last.x)return r.dates.push(e),n=r.last.y+t.fetch(this.random,e)*(e-r.last.x)/P.util.DAYMS/365.25,r.last={x:e,y:n},n;if(r.first.x>e)return r.dates.slice(0,0,e),n=r.min.y-t.fetch(this.random,e)*(r.first.x-e)/P.util.DAYMS/365.25,r.first={x:e,y:n},n;var a=P.util.bisect(r.dates,e),i={x:r.dates[a-1]},s={x:r.dates[a]};return i.y=t.fetch(this,i.x),s.y=t.fetch(this,s.x),r.dates.splice(a,0,e),i.y+(e-i.x)/(s.x-i.x)*(s.y-i.y)},E.prototype.dates=function(t){return t?t.cache[this.ID].dates.all:[]},P.logNorm=A,A.prototype=new r,A.prototype.fn=function(t,e,n){var r=t.cache[this.ID];if(n=n||0,!r.extent){var a=t.dates(this.args.spot);if(!a.length)throw"no date information in spot";r.extent={first:a[0],last:a[a.length-1]}}var i=t.fetch(this.args.spot,e,n);if(i)return i;var s,o,h,u,c,f,p=t.dates(this),d=(p.length,P.util.bisect(r.dates,e)),l=r.extent.first>e?p[d]:e;return f=t.fetch(this.args.vol,l,n),u=t.fetch(this.args.random,l,n),h=t.fetch(this.args.drift,l,n),c=r.extent.first>e?p[d]-e:e-p[d-1],c=c/P.util.DAYMS/365.25,e>r.extent.last?(s=t.fetch(this,p[d-1],n),n||(p.push(e),r.extent.last=e),s*N(f,h,u,c)):r.extent.first>e?(o=t.fetch(this,p[d],n),n||(p.splice(0,0,e),r.extent.first=e),o/N(f,h,u,c)):(s=t.fetch(this,p[d-1],n),o=t.fetch(this,p[d],n),h=Math.log(o/s)/((p[d]-p[d-1])/P.util.DAYMS/365.25),n||p.splice(d,0,e),s*N(f,h,u,c))},P.correl=j,j.prototype=new C,j.prototype.fn=function(t,e,n){var r=t.fetch(this.args.correl,e,n);return r*t.fetch(this.args.parent,e,n)+Math.sqrt(1-r*r)*t.fetch(this.args.random,e,n)},P.simul=q,q.prototype=new n,q.prototype.fetch=function(t,e,n){if(!isNaN(t))return t;var r=this.cache[t.ID].values;if(r[e]=r[e]||[],void 0===r[e][n]){var a=t.fn(this,e.valueOf(),n);void 0!==a&&(r[e][n]=a)}return r[e][n]},q.prototype.get=function(t,e){return this.initCache(t),[].concat(e||this.dates(t)).map(function(e){for(var n=[],r=this.num;r--;)n.push(this.fetch(t,e.valueOf(),r));return n},this)}})();