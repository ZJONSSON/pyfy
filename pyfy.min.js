/**
  * pyfy.js (c) 2008-2013 Sigurgeir Orn Jonsson (ziggy.jonsson.nyc@gmail.com)
  * @license http://creativecommons.org/licenses/by-nc-sa/3.0/
  * Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported (CC BY-NC-SA 3.0)
  */
(function(){function t(t,n){return+t-n}function n(t,n,e,r){return t.fetch?t.fetch(n,e,r):t}function e(){this.ID=F++}function r(t){this.const=t||0}function o(t){this.parents=t}function i(t){e.apply(this,arguments),this.data={},this._dates=[],t&&this.update(t)}function a(){i.apply(this,arguments)}function u(){i.apply(this,arguments)}function s(){i.apply(this,arguments)}function h(t,n){e.call(this,arguments),this.parent=t||new e,n&&(this.fn=n)}function p(t,n,e){h.call(this,t),this.start=n||-1/0,this.fin=e||1/0}function f(t){h.call(this,t)}function c(t){h.call(this,t)}function y(t){h.call(this,t)}function d(t,n){h.call(this,t),this.max=n||0}function l(t,n){h.call(this,t),this.min=n||0}function _(t){h.call(this,t)}function w(t,n,r){e.apply(this,arguments),this.left=n,this.right=r,this.op=t}function m(n,r){e.apply(this,arguments),n&&(n=[].concat(n).sort(t)),this.customDates=n,arguments.length>1&&(this.daycount=r)}function v(){u.apply(this,arguments),this.df=new D(this)}function D(t,n){h.call(this,t),this.val=n}function g(){function t(){var t=e(),r=127&t;return s[r]>Math.abs(t)?t*a[r]:n(t,r)}function n(t,n){for(var o,i,h=3.442619855899,p=1/h;;){if(o=t*a[n],0===n){for(o=-Math.log(r())*p,i=-Math.log(r());o*o>i+i;)o=-Math.log(r())*p,i=-Math.log(r());return t>0?h+o:-h-o}if(Math.exp(-.5*o*o)>u[n]+r()*(u[n-1]-u[n]))return o;if(t=e(),n=127&t,s[n]>Math.abs(t))return t*a[n]}}function e(){var t=i,n=i;return n^=n<<13,n^=n>>>17,n^=n<<5,i=n,0|t+n}function r(){return.5*(1+e()/-Math.pow(2,31))}function o(){i^=(new Date).getTime();var t=2147483648,n=3.442619855899,e=n,r=.00991256303526217,o=r/Math.exp(-.5*n*n);s[0]=Math.floor(n/o*t),s[1]=0,a[0]=o/t,a[127]=n/t,u[0]=1,u[127]=Math.exp(-.5*n*n);for(var h=126;h>=1;h--)n=Math.sqrt(-2*Math.log(r/n+Math.exp(-.5*n*n))),s[h+1]=Math.floor(n/e*t),e=n,u[h]=Math.exp(-.5*n*n),a[h]=n/t}var i=123456789,a=Array(128),u=Array(128),s=Array(128);this.nextGaussian=function(){return t()},o()}function M(){return 2*Math.random()-1+(2*Math.random()-1)+(2*Math.random()-1)}function x(t,n,r){e.apply(this),this.s=t||0,this.r=n||0,this.vol=r||0}var I=this.pyfy={};"undefined"!=typeof module&&(module.exports=I);var b=864e5;I.util={},I.util.dateParts=function(t){var n={y:t.getFullYear(),m:t.getMonth(),d:t.getDate()};return n.date=new Date(n.y,n.m,n.d),n.lastofMonth=new Date(n.y,n.m,n.d+1).getMonth()==n.m+1,n.lastFeb=2==n.m&&n.lastofMonth,n},I.util.today=function(){return pyty.util.dateParts(new Date)},I.util.nextDay=function(t,n){return void 0===n&&(n=0),new Date(t.getFullYear(),t.getMonth(),t.getDate()+n)};var F=0;I.base=function(){return new e},I.Base=e,e.prototype.dates=function(n){var e=[],r=this.rawDates();n&&[].concat(n).forEach(function(t){r[t]=t});for(var o in r)e.push(r[o]);return e.sort(t)},e.prototype.rawDates=function(t,n){return t=t||{},n=n||{},!n[this.ID]&&this.inputs&&("function"==typeof this.inputs?this.inputs():this.inputs,n[this.ID]=!0,[].concat(this.inputs()).forEach(function(e){e.rawDates&&e.rawDates(t,n)})),t},e.prototype.y=function(t){return this.exec(t)[this.ID]},e.prototype.x=function(t){return this.dates(t)},e.prototype.val=function(t){var n=this.exec(t);return n[this.ID].map(function(t,e){return{x:n.__dates__[e],y:t}})},e.prototype.exec=function(t){var n={result:{}},e=n.__dates__=this.dates(t),r=e.length;return n.__dt__||(n.__dt__=e.map(function(t,n){return(t-(e[n-1]||e[0]))/b})),n[this.ID]||(n[this.ID]=[]),e.every(function(t,e){return this.fetch(n,t,e),n[this.ID].length!=r},this),n},e.prototype.fetch=function(t,n,e){if(t[this.ID]||(t[this.ID]=[]),void 0===t[this.ID][e]){var r=this.fn(t,n,e);void 0!==r&&(t[this.ID][e]=r)}return t[this.ID][e]},[c,y,f,d,l,_].forEach(function(t){e.prototype[t.name.toLowerCase()]=function(n){return new t(this,n)}}),e.prototype.pv=function(t,n,e){var r=0;return this.mul(t.df(n)).y(null,e).forEach(function(t){r+=t}),r},e.prototype.derived=function(t){return new h(this,t)},e.prototype.period=function(t,n){return new p(this,t,n)},e.prototype.fn=function(){return 0},I.const=I.c=function(t){return e.apply(this,arguments),new r(t)},r.prototype=new e,r.prototype.fn=function(){return this.const},r.prototype.update=r.prototype.set=function(t){return this.const=t,this},I.sum=function(t){return new o(t)},o.prototype=new e,o.prototype.inputs=function(){return this.parents},o.prototype.fn=function(t,n,e){var r=0;return this.parents.forEach(function(n){r+=n.fetch(t,n,e)}),r},I.Data=i,i.prototype=new e,i.prototype.rawDates=function(t,n){return t=t||{},n=n||{},n[this.ID]||(this._dates.forEach(function(n){t[n]=n}),n[this.ID]=!0),t},i.prototype.update=function(n){if(0===arguments.length)return this;var e=this;if(isNaN(n))void 0===n.length&&(n=[n]),n.forEach(function(t){e.data[t.x]=t});else{var r=today();this.data[r]={x:r,y:n}}return this._dates=Object.keys(this.data).map(function(t){return this.data[t].x},this).sort(t),this},i.prototype.set=function(t){return this.data={},this.update(t)},i.prototype.fn=function(t,n,e){var r=this,o=this.dates(),i=this.data[o[0]],a=this.data[o[o.length-1]];return t[this.ID]=t.__dates__.map(function(t){if(!Object.keys(r.data).length)return 0;for(;o.length;){var n=r.data[o[0]];if(t==n.x)return n.y;if(n.x>t)return r._fn(t,i,n);i=n,o=o.slice(1)}return a.y}),t[this.ID][e]},i.prototype._fn=function(){return void 0},I.flow=function(t){return new a(t)},I.Flow=a,a.prototype=new i,a.prototype.fn=function(t,n,e){var r=this;return t[this.ID]=t.__dates__.map(function(t){return r.data[t]?r.data[t].y:0}),t[this.ID][e]},I.Stock=u,I.stock=function(t){return new u(t)},u.prototype=new i,u.prototype._fn=function(t,n){return n.y},I.Price=s,I.price=function(t){return new s(t)},s.prototype=new i,s.prototype._fn=function(t,n,e){return e.x==n.x?n.y:e.x>t?n.y+(e.y-n.y)*(t-n.x)/(e.x-n.x):void 0},I.interval=function(t,n,e,r){for(var o=[],i=0;e>i;i++)o.push({x:t=new Date(t.getFullYear(),t.getMonth()+n,t.getDate()),y:r||1});return I.flow(o)},I.Derived=h,h.prototype=new e,h.prototype.inputs=function(){return this.parent},h.prototype.fn=function(t,n,e){return this.parent.fetch(t,n,e)},h.prototype.setParent=function(t){return this.parent=t,this},I.Period=p,p.prototype=new h,p.prototype.fn=function(t,n,e){return n>=this.start&&this.fin>=n?this.parent.fetch(t,n,e):0},I.Last=f,f.prototype=new h,f.prototype.fn=function(t,n,e){return 0+(e>0&&this.parent.fetch(t,n,e-1))},I.Cumul=c,c.prototype=new h,c.prototype.fn=function(t,n,e){return this.parent.fetch(t,n,e)+(e>0&&t[this.ID][e-1])},I.Diff=y,y.prototype=new h,y.prototype.fn=function(t,n,e){var r=Math.max(e-1,0);return+this.parent.fetch(t,n,e)-(this.parent.fetch(t,n,r)||0)},I.Max=d,d.prototype=new h,d.prototype.fn=function(t,n,e){return Math.max(this.parent.fetch(t,n,e),this.max)},I.Min=l,l.prototype=new h,l.prototype.fn=function(t,n,e){return Math.min(this.parent.fetch(t,n,e),this.min)},I.Neg=_,_.prototype=new h,_.prototype.fn=function(t,n,e){return-this.parent.fetch(t,n,e)},I.Operator=w;var E={add:function(t,n){return t+n},sub:function(t,n){return t-n},mul:function(t,n){return t*n},div:function(t,n){return t/n},pow:function(t,n){return Math.pow(t,n)}};Object.keys(E).forEach(function(t){e.prototype[t]=function(n){return new w(t,this,n)}}),I.Operator=w,w.prototype=new e,w.prototype.inputs=function(){return[this.left,this.right]},w.prototype.fn=function(t,e,r){var o,i;return i=n(this.right,t,e,r),i||"mul"!=this.op?(o=n(this.left,t,e,r),E[this.op](o,i)):0},I.daycount=I.daycount||{},I.daycount.d_30_360=function(t,n){return 31==t.d&&(t.d=30),30==t.d&&31==n.d&&(n.d=30),(360*(n.y-t.y)+30*(n.m-t.m)+(n.d-t.d))/360},I.daycount.d_30E_360=function(t,n){return 31==t.d&&(t.d=30),31==n.d&&(n.d=30),(360*(n.y-t.y)+30*(n.m-t.m)+(n.d-t.d))/360},I.daycount.d_30_360US=function(t,n){return t.lastofFeb&&n.lastofFeb&&(n.d=30),t.lastofFeb&&(t.d=30),31!=n.d||30!=t.d&&31!=t.d||(n.d=30),31==t.d&&(t.d=30),(360*(n.y-t.y)+30*(n.m-t.m)+(n.d-t.d))/360},I.daycount.d_act_360=function(t,n){return Math.round((n.date-t.date)/b)/360},I.daycount.d_act_act=function(t,n){for(var e=0,r=t.date,o=new Date(Math.min(new Date(r.getFullYear()+1,0,1),n.date));n.date>r;){var i=new Date(r.getFullYear(),1,29),a=29==i.getDate()?366:365;e+=Math.round((o-r)/b)/a,r=o,o=new Date(Math.min(new Date(r.getFullYear()+1,0,1),n.date))}return e},I.Dcf=m,I.dcf=function(t,n,e){return new m(t,n,e)},m.prototype=new e,m.prototype.rawDates=function(t){return t=t||{},this.customDates&&[].concat(this.customDates).forEach(function(n){n=this.calendar(n),t[n]=n},this),t},m.prototype.fn=function(t){var n={},e=this.dates();e.length||(e=t.__dates__),e.slice(1).map(function(t,r){var o=I.util.dateParts(e[r]),i=I.util.dateParts(t);n[t]=this.daycount(o,i)},this),t[this.ID]=t.__dates__.map(function(t){return n[t]||0})},m.prototype.calendar=function(t){return t},m.prototype.daycount=I.daycount.d_30_360,m.prototype.setDaycount=function(t){return this.daycount="string"==typeof t?I.daycount[t]:t,this},I.ir=function(t){return new v(t)},v.prototype=new u,v.prototype.daycount=I.dcf(),I.df=function(t){return new D(t)},D.prototype=new h,D.prototype.fn=function(t,e,r){var o=this,i=t.__dt__[r]/365;return 0===r?1:n(this,t,e,r-1)*Math.exp(-n(o.parent,t,e,r)*i)};var P=new g,M=I.rndNorm=P.nextGaussian;I.norm=function(t,n,e){return new x(t,n,e)},x.prototype=new e,x.prototype.inputs=function(){return[this.s,this.r,this.vol]},x.prototype.fn=function(t,e,r){var o=this.s;t.__dates__;var i=t.__dt__[r]/365,o=r>0?this.fetch(t,e,r-1):this.s,a=n(this.r,t,e,r),u=n(this.vol,t,e,r),s=(a-Math.pow(u,2)/2)*i+u*Math.sqrt(i)*M();return o*Math.exp(s)}})();