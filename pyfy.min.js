/**
  * pyfy.js (c) 2008-2013 Sigurgeir Orn Jonsson (ziggy.jonsson.nyc@gmail.com)
  * @license http://creativecommons.org/licenses/by-nc-sa/3.0/
  * Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported (CC BY-NC-SA 3.0)
  */
(function(){function t(t,e){return+t-e}function e(t){return t}function n(t){return this instanceof n?(this.cache={options:t},void 0):new n(t)}function r(){return this instanceof r?(this.ID=P++,this.args={},this.version=0,this.cache=!0,void 0):new r}function a(){r.apply(this)}function i(t,e,n,a,s,o,u,h){return this instanceof i?(r.call(this),Array.prototype.slice.call(arguments).map(function(t,e){t&&(this.args[e]=t)},this),void 0):new i(t,e,n,a,s,o,u,h)}function s(t,e){return this instanceof s?(r.apply(this,arguments),this.args.data={},t&&this.update(t),void 0):new s(t,e)}function o(t,e){return this instanceof o?(s.apply(this,arguments),void 0):new o(t,e)}function u(t,e){return this instanceof u?(s.apply(this,arguments),void 0):new u(t,e)}function h(t,e){return this instanceof h?(s.apply(this,arguments),void 0):new h(t,e)}function c(t,e){return this instanceof c?(s.apply(this,arguments),void 0):new c(t,e)}function f(){r.call(this)}function p(){r.call(this)}function l(){r.call(this)}function d(){r.call(this)}function y(){r.call(this)}function g(){r.call(this)}function v(){r.call(this)}function w(){r.call(this)}function D(){r.call(this)}function m(){r.call(this)}function M(){r.call(this)}function x(t,e,n){return this instanceof x?(r.apply(this),this.args.left=e,this.args.right=n,this.op=t,void 0):new x(t,e,n)}function b(){r.call(this)}function k(){r.call(this,parent)}function _(){u.apply(this,arguments),this.df=new I(this),this.args.daycount=q.daycount.d_30_360}function I(t,e){r.call(this),this.args.parent=t,this.args.val=e}function Y(t,e,n,a,i,s){return this instanceof Y?(r.apply(this),this.notional=i||1,this.daycount=s,this.rate=a,this.schedule=q.interval(t,e,n).div(n),this.generate(),void 0):new Y(t,e,n,a,i,s)}function O(){function t(){var t=n(),r=127&t;return u[r]>Math.abs(t)?t*s[r]:e(t,r)}function e(t,e){for(var a,i,h=3.442619855899,c=1/h;;){if(a=t*s[e],0===e){for(a=-Math.log(r())*c,i=-Math.log(r());a*a>i+i;)a=-Math.log(r())*c,i=-Math.log(r());return t>0?h+a:-h-a}if(Math.exp(-.5*a*a)>o[e]+r()*(o[e-1]-o[e]))return a;if(t=n(),e=127&t,u[e]>Math.abs(t))return t*s[e]}}function n(){var t=i,e=i;return e^=e<<13,e^=e>>>17,e^=e<<5,i=e,0|t+e}function r(){return.5*(1+n()/-Math.pow(2,31))}function a(){i^=(new Date).getTime();var t=2147483648,e=3.442619855899,n=e,r=.00991256303526217,a=r/Math.exp(-.5*e*e);u[0]=Math.floor(e/a*t),u[1]=0,s[0]=a/t,s[127]=e/t,o[0]=1,o[127]=Math.exp(-.5*e*e);for(var h=126;h>=1;h--)e=Math.sqrt(-2*Math.log(r/e+Math.exp(-.5*e*e))),u[h+1]=Math.floor(e/n*t),n=e,o[h]=Math.exp(-.5*e*e),s[h]=e/t}var i=123456789,s=Array(128),o=Array(128),u=Array(128);this.nextGaussian=function(){return t()},a()}function F(){return this instanceof F?(r.call(this),void 0):new F}function C(t){return this instanceof C?(r.apply(this),this.change=this.diff(this),this.random=t||new F,this.inputs=[t],void 0):new C(t)}function E(){r.apply(this)}function A(t,e,n,r){return Math.exp((e-t*t/2)*r+n*t*Math.sqrt(r))}function N(t,e,n){return this instanceof N?(F.call(this),this.args.parent=t,this.args.random=n||new F,this.args.correl=e,void 0):new N(t,e)}function j(t){return this instanceof j?(n.call(this),this.num=t,void 0):new j(t)}var q=this.pyfy={};"undefined"!=typeof module&&(module.exports=q),q.util={},q.util.DAYMS=864e5,q.util.dateParts=function(t){t=new Date(t);var e={y:t.getFullYear(),m:t.getMonth(),d:t.getDate()};return e.date=new Date(e.y,e.m,e.d),e.lastofMonth=new Date(e.y,e.m,e.d+1).getMonth()==e.m+1,e.lastFeb=2==e.m&&e.lastofMonth,e},q.util.today=function(){return q.util.dateParts(new Date).date},q.util.nextDay=function(t,e){return void 0===e&&(e=0),new Date(t.getFullYear(),t.getMonth(),t.getDate()+e)},q.util.nextWeekday=function(t,e){var n=t.getDay(),r=n>e?e+7-n:e-n;return new Date(t.getFullYear(),t.getMonth(),t.getDate()+r)},q.util.bisect=function(t,n,r,a){for(3>arguments.length&&(r=0),4>arguments.length&&(a=t.length);a>r;){var i=r+a>>>1;n>e.call(t,t[i],i)?r=i+1:a=i}return r},q.calendar={},q.calendar.weekday=function(t){var e=t.getDay();return 0!==e&&6!=e},q.calendar.easter=function(t,e){e=e||[1,-2];var n,r,a,i,s,o,u,h,c;return 4>(t.getMonth()>1)?(n=t.getFullYear(),r=~~(n/100),a=n-19*~~(n/19),i=~~((r-17)/25),s=r-~~(r/4)-~~((r-i)/3)+19*a+15,s-=30*~~(s/30),s-=s/28*(1-~~(s/28)*~~(29/(s+1))*~~((21-a)/11)),o=n+~~(n/4)+s+2-r+~~(r/4),o-=7*~~(o/7),u=s-o,h=3+~~((u+40)/44)-1,c=Math.round(u+28-31*~~(h/4)),e.every(function(e){return t-new Date(n,h,c+e)})):!0},q.calendar.target=function(t){var e=t.getMonth(),n=t.getDate();return!(!q.calendar.weekday(t)||!q.calendar.easter(t,[1,-2])||0===e&&1==n||11==e&&(26==n||25==n)||4==e&&1==n)},q.calendar.is=function(t){var e=t.getFullYear(),n=t.getMonth(),r=t.getDate();return!(!q.calendar.weekday(t)||!q.calendar.easter(t,[1,-2,-3,39,50])||5==n&&17==r||0===n&&1==r||11==n&&(26==r||25==r)||4==n&&1==r||7==n&&0===t-q.util.nextWeekday(new Date(e,7,1),1)||3==n&&0===t-q.util.nextWeekday(new Date(e,3,19),4))},q.query=n,n.prototype.initCache=function(t){if(!t.ID)return!1;var e=!this.cache[t.ID]||this.cache[t.ID].version!=t.version;return t.args&&Object.keys(t.args).forEach(function(n){var r=t.args[n];this.initCache(r)&&(e=!0)},this),e&&(this.cache[t.ID]={obj:t,values:{},version:t.version}),e},n.prototype.getCache=function(t){return this.initCache(t),this.cache[t.ID]},n.prototype.dates=function(e){var n=this.getCache(e);if(!n.dates){var r=this.rawDates(e),a=n.dates=[];for(var i in r)a.push(r[i]);a.sort(t)}return n.dates},n.prototype.rawDates=function(t,e){var n=this.getCache(t);return e=e||{},n&&!n.rawDates&&(t.args&&Object.keys(t.args).forEach(function(n){e=this.rawDates(t.args[n],e)},this),t.rawDates&&(e=t.rawDates(e,this))),e},n.prototype.y=function(t,e){return this.get(t,e)},n.prototype.x=function(t){return this.dates(t).map(function(t){return new Date(t)})},n.prototype.val=function(t,e){return e=e||this.dates(t),e=[].concat(e),this.get(t,e).map(function(t,n){return{x:new Date(e[n]),y:t}},this)},n.prototype.get=function(t,e){return this.initCache(t),e||(e=this.dates(t)),[].concat(e).map(function(e){return this.fetch(t,e.valueOf())},this)},n.prototype.fetch=function(t,e){if(!isNaN(t))return t;var n=this.cache[t.ID].values;if(void 0===n[e]){var r=t.fn(this,e.valueOf());void 0!==r&&t.cache&&(n[e]=r)}return n[e]};var P=0;q.base=q.Base=r,r.prototype.set=function(t,e){return 1==arguments.length?this.args[t]:(this.args[t]=e,this.version+=1,this)},r.prototype.useCache=function(t){return arguments.length?(this.cache=t,this):this.cache},r.prototype.fn=function(){return 0},r.prototype.rawDates=void 0,["cumul","diff","prev","max","min","neg","calendar","dcf","period","timeDiff","call","put","logNorm"].forEach(function(t){r.prototype[t]=function(e,n,r){return q[t](this,e,n,r)}}),r.prototype.pv=function(t){var e=0;return isNaN(t)||(t=q.ir(t)),this.mul(t.df).y().forEach(function(t){e+=t}),e},r.prototype.y=function(t){return q.query().get(this,t)},r.prototype.x=function(t){return q.query().x(this,t)},r.prototype.val=function(t){return q.query().val(this,t)},r.prototype.dates=function(){return q.query().dates(this).map(function(t){return new Date(t)})},q.const=function(t){return(new a).set("const",t||0)},a.prototype=new r,a.prototype.fn=function(){return this.args.const},q.sum=i,i.prototype=new r,i.prototype.fn=function(t,e,n){var r=0;return Object.keys(this.args).forEach(function(a){r+=t.fetch(this.args[a],e,n)},this),r},q.data=q.Data=s,s.prototype=new r,s.prototype.rawDates=function(t,e){return e&&e.options&&e.options.settle||new Date,t=t||{},Object.keys(this.args.data).forEach(function(e){t[+e]=+e}),t},s.prototype.update=function(t){if(0===arguments.length)return this;if(isNaN(t))[].concat(t).forEach(function(t){this.args.data[(t.x||t[0]).valueOf()]=t.y||t[1]},this);else{var e=q.util.today().valueOf();this.args.data[e]=t}return this},s.prototype.fn=function(t,e){if(!Object.keys(this.args.data).length)return 0;if(this.args.data[e])return this.args.data[e];var n=t.dates(this),r=q.util.bisect(n,e),a=r-1;return r==n.length&&(r-=1),0===r&&(a=0),this._fn(e,n[a]||n[r],n[r])},s.prototype._fn=function(){return void 0},q.flow=o,o.prototype=new s,o.prototype.fn=function(t,e){return this.args.data[e]||0},q.stock=u,u.prototype=new s,u.prototype._fn=function(t,e){return this.args.data[e]},q.price=h,h.prototype=new s,h.prototype._fn=function(t,e,n){var r=this.args.data[e],a=this.args.data[n];return e==n?a:n>(t>e)?r+(a-r)*(t-e)/(n-e):a},q.stream=c,c.prototype=new s,q.interval=function(t,e,n,r){t=t||q.util.today();for(var a=[],i=0;n+1>i;i++)a.push({x:new Date(t.getFullYear(),t.getMonth()+i*e,t.getDate()),y:i?r||1:0});return q.flow(a)},q.period=function(t,e,n){return(new f).set("parent",t).set("start",e||-1/0).set("finish",n||1/0)},f.prototype=new r,f.prototype.rawDates=function(t){var e={};return t&&Object.keys(t).forEach(function(n){var r=t[n];r>=this.args.start&&this.args.finish>=r&&(e[r]=r)},this),e},f.prototype.fn=function(t,e,n){return e>=this.args.start&&this.args.finish>=e?t.fetch(this.args.parent,e,n):0},q.prev=function(t,e){return(new p).set("parent",t).set("start",e||0)},p.prototype=new r,p.prototype.fn=function(t,e,n){var r=t.dates(this),a=q.util.bisect(r,e);return a>0?t.fetch(this.args.parent,r[a-1],n):this.args.start},q.cumul=function(t){return(new l).set("parent",t)},l.prototype=new r,l.prototype.fn=function(t,e,n){var r=t.dates(this),a=q.util.bisect(r,e);return t.fetch(this.args.parent,e,n)+(a?t.fetch(this,r[a-1],n):0)},q.diff=function(t){return(new d).set("parent",t)},d.prototype=new r,d.prototype.fn=function(t,e,n){var r=t.dates(this),a=q.util.bisect(r,e);return a?t.fetch(this.args.parent,e,n)-t.fetch(this.args.parent,r[a-1],n):0},q.max=function(t,e){return(new y).set("parent",t).set("max",e)},y.prototype=new r,y.prototype.fn=function(t,e,n){return Math.max(t.fetch(this.args.parent,e,n),this.args.max)},q.min=function(t,e){return(new g).set("parent",t).set("min",e)},g.prototype=new r,g.prototype.fn=function(t,e,n){return Math.min(t.fetch(this.args.parent,e,n),this.args.min)},q.neg=function(t){return(new v).set("parent",t)},v.prototype=new r,v.prototype.fn=function(t,e,n){return-t.fetch(this.args.parent,e,n)},q.acct=function(t,e){return(new w).set("parent",t).set("start",e||0)},w.prototype=new r,w.prototype.fn=function(t,e,n){var r=t.dates(this.args.parent),a=q.util.bisect(r,e);return 1>a?this.args.start:r[a]==e?t.fetch(this,r[a-1],n)+t.fetch(this.args.parent,e,n):t.fetch(this,r[a-1],n)},q.call=function(t,e){return(new D).set("parent",t).set("strike",e)},D.prototype=new r,D.prototype.fn=function(t,e,n){return Math.max(t.fetch(this.args.parent,e,n)-this.args.strike,0)},q.put=function(t,e){return(new m).set("parent",t).set("strike",e||0)},m.prototype=new r,m.prototype.fn=function(t,e,n){return Math.max(this.args.strike-t.fetch(this.args.parent,e,n),0)},q.Calendar=function(t,e){return(new M).set("parent",t).set("calendar",e||q.calendar.weekday)},M.prototype=new r,M.prototype.checkDate=function(t){function e(){return!r.every(function(e){var n="string"==typeof e?q.calendar[e]:e;return n(t)},this)}function n(){if(t=new Date(t.getFullYear(),t.getMonth(),t.getDate()+1),a++>31)throw"Calendar function always returns false"}t=new Date(t);for(var r=[].concat(this.args.calendar),a=0;e();)n();return t.valueOf()},M.prototype.rawDates=function(t,e){var n=e.cache[this.ID];t={},n.dateMap={};for(var r in this.args.parent.rawDates()){var a=this.checkDate(+r);t[a]=+a,n.dateMap[a]=+r}return t},M.prototype.fn=function(t,e){var n=t.cache[this.ID];return t.fetch(this.args.parent,n.dateMap[e]||this.calendar(e))},q.operator=q.Operator=x;var S={add:function(t,e){return t+e},sub:function(t,e){return t-e},mul:function(t,e){return t*e},div:function(t,e){return t/e},pow:function(t,e){return Math.pow(t,e)}};Object.keys(S).forEach(function(t){r.prototype[t]=function(e){return new x(t,this,e)}}),x.prototype=new r,x.prototype.fn=function(t,e,n){var r,a;return a=t.fetch(this.args.right,e,n),a||"mul"!=this.op?(r=t.fetch(this.args.left,e,n),S[this.op](r,a)):0},q.daycount=q.daycount||{},q.daycount.d_30_360=function(t,e){return 31==t.d&&(t.d=30),30==t.d&&31==e.d&&(e.d=30),(360*(e.y-t.y)+30*(e.m-t.m)+(e.d-t.d))/360},q.daycount.d_30E_360=function(t,e){return 31==t.d&&(t.d=30),31==e.d&&(e.d=30),(360*(e.y-t.y)+30*(e.m-t.m)+(e.d-t.d))/360},q.daycount.d_30_360US=function(t,e){return t.lastofFeb&&e.lastofFeb&&(e.d=30),t.lastofFeb&&(t.d=30),31!=e.d||30!=t.d&&31!=t.d||(e.d=30),31==t.d&&(t.d=30),(360*(e.y-t.y)+30*(e.m-t.m)+(e.d-t.d))/360},q.daycount.d_act_360=function(t,e){return Math.round((e.date-t.date)/q.util.DAYMS)/360},q.daycount.d_act_act=function(t,e){for(var n=0,r=t.date,a=new Date(Math.min(new Date(r.getFullYear()+1,0,1),e.date));e.date>r;){var i=new Date(r.getFullYear(),1,29),s=29==i.getDate()?366:365;n+=Math.round((a-r)/q.util.DAYMS)/s,r=a,a=new Date(Math.min(new Date(r.getFullYear()+1,0,1),e.date))}return n},q.dcf=function(t,e){return(new b).set("parent",t).set("daycount",e||q.daycount.d_30_360)},b.prototype=new r,b.prototype.fn=function(t,e){"string"==typeof this.args.daycount&&(this.args.daycount=q.daycount[this.args.daycount]);var n=t.cache[this.ID];if(!Object.keys(n.values).length){var r=t.dates(this);n.values={},r.slice(1).forEach(function(t,e){var a=q.util.dateParts(r[e]),i=q.util.dateParts(t);n.values[t]=r[e]?this.args.daycount(a,i):0},this)}return n.values[e]||0},q.timeDiff=function(t,e,n){return(new k).set("parent",t).set("daycount",n||q.daycount.d_30_360).set("date",e||new Date)},k.prototype=new r,k.prototype.fn=function(t,e){var n=this.args.date;if("string"==typeof n){var r=t.dates(this.args.parent);n=new Date("L"===n.slice(0,1).toUpperCase()?r[r.length-1]:r[0])}return Math.abs(this.args.daycount(q.util.dateParts(n),q.util.dateParts(new Date(e))))},q.ir=function(t,e){return(new _).set("data",t).set("options",e)},_.prototype=new u,_.prototype.setDaycount=function(t){return this.args.daycount="string"==typeof t?q.daycount[t]:t,this},_.prototype._fn=function(t,e,n){return this.args.data[n]},q.df=function(t){return new Derived(t)},I.prototype=new r,I.prototype.fn=function(t,e,n){var r=t.dates(this),a=q.util.bisect(r,e),i=r[a-1];if(!i)return e==r[a]?1:0;var s=this.parent.daycount(q.util.dateParts(i),q.util.dateParts(e));return t.fetch(this,i,n)*Math.exp(-t.fetch(this.args.parent,e,n)*s)},q.bond=Y,Y.prototype=new r,Y.prototype.generate=function(){this.bal=q.acct(this.notional||1),this.p_scheduled=this.schedule.mul(this.notional),this.p=this.schedule.mul(this.notional),this.bal.setParent(this.p.neg()),this.i=this.bal.prev().dcf().mul(this.rate),this.set("parent",this.p.add(this.i))},Y.prototype.setSchedule=function(t){return this.schedule=t,this.generate(),this};var W=new O;q.rndNorm=W.nextGaussian,q.random=F,F.prototype=new r,F.prototype.fn=function(){var t,e,n;do t=2*Math.random()-1,e=2*Math.random()-1,n=t*t+e*e;while(!n||n>1);return t*Math.sqrt(-2*Math.log(n)/n)},F.prototype.correl=function(t){return q.correl(this,t)},F.prototype.wiener=function(){return q.wiener(this)},q.wiener=C,C.prototype=new r,C.prototype.rawDates=function(t){var e={};return t&&t.cache[this.ID]&&t.cache[this.ID].dates&&t.cache[this.ID].dates.forEach(function(t){e[t]=t}),e},C.prototype.fn=function(t,e){var n,r=t.cache[this.ID];if(!r.dates)return r.dates=[e],r.first={x:e,y:0},r.last={x:e,y:0},0;if(e>r.last.x)return r.dates.push(e),n=r.last.y+t.fetch(this.random,e)*(e-r.last.x)/q.util.DAYMS/365.25,r.last={x:e,y:n},n;if(r.first.x>e)return r.dates.slice(0,0,e),n=r.min.y-t.fetch(this.random,e)*(r.first.x-e)/q.util.DAYMS/365.25,r.first={x:e,y:n},n;var a=q.util.bisect(r.dates,e),i={x:r.dates[a-1]},s={x:r.dates[a]};return i.y=t.fetch(this,i.x),s.y=t.fetch(this,s.x),r.dates.splice(a,0,e),i.y+(e-i.x)/(s.x-i.x)*(s.y-i.y)},C.prototype.dates=function(t){return t?t.cache[this.ID].dates.all:[]},q.logNorm=function(t,e,n,a){return(new r).set("spot",t).set("vol",e).set("drift",n).set("random",a||new F)},E.prototype=new r,E.prototype.fn=function(t,e,n){var r=t.cache[this.ID];if(n=n||0,!r.extent){var a=t.dates(this.args.spot);if(!a.length)throw"no date information in spot";r.extent={first:a[0],last:a[a.length-1]}}var i=t.fetch(this.args.spot,e,n);if(i)return i;var s,o,u,h,c,f,p=t.dates(this),l=(p.length,q.util.bisect(r.dates,e)),d=r.extent.first>e?p[l]:e;return f=t.fetch(this.args.vol,d,n),h=t.fetch(this.args.random,d,n),u=t.fetch(this.args.drift,d,n),c=r.extent.first>e?p[l]-e:e-p[l-1],c=c/q.util.DAYMS/365.25,e>r.extent.last?(s=t.fetch(this,p[l-1],n),n||(p.push(e),r.extent.last=e),s*A(f,u,h,c)):r.extent.first>e?(o=t.fetch(this,p[l],n),n||(p.splice(0,0,e),r.extent.first=e),o/A(f,u,h,c)):(s=t.fetch(this,p[l-1],n),o=t.fetch(this,p[l],n),u=Math.log(o/s)/((p[l]-p[l-1])/q.util.DAYMS/365.25),n||p.splice(l,0,e),s*A(f,u,h,c))},q.correl=N,N.prototype=new F,N.prototype.fn=function(t,e,n){var r=t.fetch(this.args.correl,e,n);return r*t.fetch(this.args.parent,e,n)+Math.sqrt(1-r*r)*t.fetch(this.args.random,e,n)},q.simul=j,j.prototype=new n,j.prototype.fetch=function(t,e,n){if(!isNaN(t))return t;var r=this.cache[t.ID].values;if(r[e]=r[e]||[],void 0===r[e][n]){var a=t.fn(this,e.valueOf(),n);void 0!==a&&(r[e][n]=a)}return r[e][n]},j.prototype.get=function(t,e){return this.initCache(t),[].concat(e||this.dates(t)).map(function(e){for(var n=[],r=this.num;r--;)n.push(this.fetch(t,e.valueOf(),r));return n},this)}})();