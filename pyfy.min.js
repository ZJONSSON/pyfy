!function(){function ascending(a,b){return+a-b}function f(d){return d}function Base(){return this instanceof Base?(this.ID=ID++,this.args={},this.version=0,this.cache=!0,void 0):new Base}function Query(options){return this instanceof Query?(this.cache={options:options},void 0):new Query(options)}function Const(){Base.apply(this)}function Sum(a,b,c,d,e,f,g,h){return this instanceof Sum?(Base.call(this),Array.prototype.slice.call(arguments).map(function(d,i){d&&(this.args[i]=d)},this),void 0):new Sum(a,b,c,d,e,f,g,h)}function Data(data,options){return this instanceof Data?(Base.apply(this,arguments),this.args.data={},data&&this.update(data),void 0):new Data(data,options)}function Flow(data,options){return this instanceof Flow?(Data.apply(this,arguments),void 0):new Flow(data,options)}function Stock(data,options){return this instanceof Stock?(Data.apply(this,arguments),void 0):new Stock(data,options)}function Price(data,options){return this instanceof Price?(Data.apply(this,arguments),void 0):new Price(data,options)}function Stream(data,options){return this instanceof Stream?(Data.apply(this,arguments),void 0):new Stream(data,options)}function Period(){Base.call(this)}function Prev(){Base.call(this)}function Cumul(){Base.call(this)}function Diff(){Base.call(this)}function Max(){Base.call(this)}function Min(){Base.call(this)}function Neg(){Base.call(this)}function Acct(){Base.call(this)}function Call(){Base.call(this)}function Put(){Base.call(this)}function Calendar(){Base.call(this)}function Operator(op,left,right){return this instanceof Operator?(Base.apply(this),this.args.left=left,this.args.right=right,this.op=op,void 0):new Operator(op,left,right)}function Dcf(){Base.call(this)}function TimeDiff(){Base.call(this,parent)}function Ir(){Stock.apply(this,arguments),this.df=new Df(this),this.args.daycount=pyfy.daycount.d_30_360}function Df(parent,val){Base.call(this),this.args.parent=parent,this.args.val=val}function Bond(start,dm,num,rate,notional,daycount){return this instanceof Bond?(Base.apply(this),this.notional=notional||1,this.daycount=daycount,this.rate=rate,this.schedule=pyfy.interval(start,dm,num).div(num),this.generate(),void 0):new Bond(start,dm,num,rate,notional,daycount)}function Ziggurat(){function RNOR(){var hz=SHR3(),iz=127&hz;return Math.abs(hz)<kn[iz]?hz*wn[iz]:nfix(hz,iz)}function nfix(hz,iz){for(var x,y,r=3.442619855899,r1=1/r;;){if(x=hz*wn[iz],0===iz){for(x=-Math.log(UNI())*r1,y=-Math.log(UNI());x*x>y+y;)x=-Math.log(UNI())*r1,y=-Math.log(UNI());return hz>0?r+x:-r-x}if(fn[iz]+UNI()*(fn[iz-1]-fn[iz])<Math.exp(-.5*x*x))return x;if(hz=SHR3(),iz=127&hz,Math.abs(hz)<kn[iz])return hz*wn[iz]}}function SHR3(){var jz=jsr,jzr=jsr;return jzr^=jzr<<13,jzr^=jzr>>>17,jzr^=jzr<<5,jsr=jzr,0|jz+jzr}function UNI(){return.5*(1+SHR3()/-Math.pow(2,31))}function zigset(){jsr^=(new Date).getTime();var m1=2147483648,dn=3.442619855899,tn=dn,vn=.00991256303526217,q=vn/Math.exp(-.5*dn*dn);kn[0]=Math.floor(dn/q*m1),kn[1]=0,wn[0]=q/m1,wn[127]=dn/m1,fn[0]=1,fn[127]=Math.exp(-.5*dn*dn);for(var i=126;i>=1;i--)dn=Math.sqrt(-2*Math.log(vn/dn+Math.exp(-.5*dn*dn))),kn[i+1]=Math.floor(dn/tn*m1),tn=dn,fn[i]=Math.exp(-.5*dn*dn),wn[i]=dn/m1}var jsr=123456789,wn=new Array(128),fn=new Array(128),kn=new Array(128);this.nextGaussian=function(){return RNOR()},zigset()}function Random(){return this instanceof Random?(Base.call(this),void 0):new Random}function Wiener(random){return this instanceof Wiener?(Base.apply(this),this.change=this.diff(this),this.random=random||new Random,this.inputs=[random],void 0):new Wiener(random)}function LogNorm(){Base.apply(this)}function pyfy_exp(vol,drift,rnd,dt){return Math.exp((drift-vol*vol/2)*dt+rnd*vol*Math.sqrt(dt))}function Correl(parent,correl,random){return this instanceof Correl?(Random.call(this),this.args.parent=parent,this.args.random=random||new Random,this.args.correl=correl,void 0):new Correl(parent,correl)}function Simul(num){return this instanceof Simul?(Query.call(this),this.num=num,void 0):new Simul(num)}var pyfy=this.pyfy={};"undefined"!=typeof module&&(module.exports=pyfy),pyfy.util={},pyfy.util.DAYMS=864e5,pyfy.util.dateParts=function(d){d=new Date(d);var query={y:d.getFullYear(),m:d.getMonth(),d:d.getDate()};return query.date=new Date(query.y,query.m,query.d),query.lastofMonth=new Date(query.y,query.m,query.d+1).getMonth()==query.m+1,query.lastFeb=2==query.m&&query.lastofMonth,query},pyfy.util.today=function(){return pyfy.util.dateParts(new Date).date},pyfy.util.nextDay=function(d,i){return void 0===i&&(i=0),new Date(d.getFullYear(),d.getMonth(),d.getDate()+i)},pyfy.util.nextWeekday=function(date,weekday){var currentWeekday=date.getDay(),dt=currentWeekday>weekday?weekday+7-currentWeekday:weekday-currentWeekday;return new Date(date.getFullYear(),date.getMonth(),date.getDate()+dt)},pyfy.util.bisect=function(a,x,lo,hi){for(arguments.length<3&&(lo=0),arguments.length<4&&(hi=a.length);hi>lo;){var mid=lo+hi>>>1;f.call(a,a[mid],mid)<x?lo=mid+1:hi=mid}return lo};var ID=0;pyfy.base=pyfy.Base=Base,Base.prototype.set=function(d,v){return 1==arguments.length?this.args[d]:(this.args[d]=v,this.version+=1,this)},Base.prototype.useCache=function(d){return arguments.length?(this.cache=d,this):this.cache},Base.prototype.fn=function(){return 0},Base.prototype.rawDates=void 0,["cumul","diff","prev","max","min","neg","calendar","dcf","period","timeDiff","call","put","logNorm"].forEach(function(fn){Base.prototype[fn]=function(a,b,c){return pyfy[fn](this,a,b,c)}}),Base.prototype.pv=function(curve){var pv=0;return isNaN(curve)||(curve=pyfy.ir(curve)),this.mul(curve.df).y().forEach(function(cf){pv+=cf}),pv},Base.prototype.y=function(dates){return pyfy.query().get(this,dates)},Base.prototype.x=function(dates){return pyfy.query().x(this,dates)},Base.prototype.val=function(dates){return pyfy.query().val(this,dates)},Base.prototype.dates=function(){return pyfy.query().dates(this).map(function(d){return new Date(d)})},pyfy.query=Query,Query.prototype.initCache=function(obj){if(!obj.ID)return!1;var clear=!this.cache[obj.ID]||this.cache[obj.ID].version!=obj.version;return obj.args&&Object.keys(obj.args).forEach(function(key){var parent=obj.args[key];this.initCache(parent)&&(clear=!0)},this),clear&&(this.cache[obj.ID]={obj:obj,values:{},version:obj.version}),clear},Query.prototype.getCache=function(obj){return this.initCache(obj),this.cache[obj.ID]},Query.prototype.dates=function(obj){var cache=this.getCache(obj);if(!cache.dates){var rawDates=this.rawDates(obj),dates=cache.dates=[];for(var date in rawDates)dates.push(rawDates[date]);dates.sort(ascending)}return cache.dates},Query.prototype.rawDates=function(obj,rawDates){var cache=this.getCache(obj);return rawDates=rawDates||{},cache&&!cache.rawDates&&(obj.args&&Object.keys(obj.args).forEach(function(key){rawDates=this.rawDates(obj.args[key],rawDates)},this),obj.rawDates&&(rawDates=obj.rawDates(rawDates,this))),rawDates},Query.prototype.y=function(obj,dates){return this.get(obj,dates)},Query.prototype.x=function(obj){return this.dates(obj).map(function(d){return new Date(d)})},Query.prototype.val=function(obj,dates){return dates=dates||this.dates(obj),dates=[].concat(dates),this.get(obj,dates).map(function(d,i){return{x:new Date(dates[i]),y:d}},this)},Query.prototype.get=function(obj,d){return this.initCache(obj),d||(d=this.dates(obj)),[].concat(d).map(function(d){return this.fetch(obj,d.valueOf())},this)},Query.prototype.fetch=function(obj,d){if(!isNaN(obj))return obj;var values=this.cache[obj.ID].values;if(void 0===values[d]){var fn=obj.fn(this,d.valueOf());void 0!==fn&&obj.cache&&(values[d]=fn)}return values[d]},pyfy.const=function(value){return(new Const).set("const",value||0)},Const.prototype=new Base,Const.prototype.fn=function(){return this.args.const},pyfy.sum=Sum,Sum.prototype=new Base,Sum.prototype.fn=function(query,d,i){var sum=0;return Object.keys(this.args).forEach(function(key){sum+=query.fetch(this.args[key],d,i)},this),sum},pyfy.data=pyfy.Data=Data,Data.prototype=new Base,Data.prototype.rawDates=function(rawDates,query){return query&&query.options&&query.options.settle||new Date,rawDates=rawDates||{},Object.keys(this.args.data).forEach(function(e){rawDates[+e]=+e}),rawDates},Data.prototype.update=function(a){if(0===arguments.length)return this;if(isNaN(a))[].concat(a).forEach(function(d){this.args.data[(d.x||d[0]).valueOf()]=d.y||d[1]},this);else{var x=pyfy.util.today().valueOf();this.args.data[x]=a}return this},Data.prototype.fn=function(query,d){if(!Object.keys(this.args.data).length)return 0;if(this.args.data[d])return this.args.data[d];var dates=query.dates(this),next=pyfy.util.bisect(dates,d),prev=next-1;return next==dates.length&&(next-=1),0===next&&(prev=0),this._fn(d,dates[prev]||dates[next],dates[next])},Data.prototype._fn=function(){return void 0},pyfy.flow=Flow,Flow.prototype=new Data,Flow.prototype.fn=function(query,d){return this.args.data[d]||0},pyfy.stock=Stock,Stock.prototype=new Data,Stock.prototype._fn=function(d,last){return this.args.data[last]},pyfy.price=Price,Price.prototype=new Data,Price.prototype._fn=function(d,prev,next){var prevVal=this.args.data[prev],nextVal=this.args.data[next];return prev==next?nextVal:next>(d>prev)?prevVal+(nextVal-prevVal)*(d-prev)/(next-prev):nextVal},pyfy.stream=Stream,Stream.prototype=new Data,pyfy.interval=function(start,dm,no,val){start=start||pyfy.util.today();for(var interval=[],i=0;no+1>i;i++)interval.push({x:new Date(start.getFullYear(),start.getMonth()+i*dm,start.getDate()),y:i?val||1:0});return pyfy.flow(interval)},pyfy.period=function(parent,start,finish){return(new Period).set("parent",parent).set("start",start||-1/0).set("finish",finish||1/0)},Period.prototype=new Base,Period.prototype.rawDates=function(rawDates){var res={};return rawDates&&Object.keys(rawDates).forEach(function(key){var d=rawDates[key];d>=this.args.start&&d<=this.args.finish&&(res[d]=d)},this),res},Period.prototype.fn=function(query,d,i){return d>=this.args.start&&d<=this.args.finish?query.fetch(this.args.parent,d,i):0},pyfy.prev=function(parent,start){return(new Prev).set("parent",parent).set("start",start||0)},Prev.prototype=new Base,Prev.prototype.fn=function(query,d,i){var dates=query.dates(this),datePos=pyfy.util.bisect(dates,d);return datePos>0?query.fetch(this.args.parent,dates[datePos-1],i):this.args.start},pyfy.cumul=function(parent){return(new Cumul).set("parent",parent)},Cumul.prototype=new Base,Cumul.prototype.fn=function(query,d,i){var dates=query.dates(this),datePos=pyfy.util.bisect(dates,d);return query.fetch(this.args.parent,d,i)+(datePos?query.fetch(this,dates[datePos-1],i):0)},pyfy.diff=function(parent){return(new Diff).set("parent",parent)},Diff.prototype=new Base,Diff.prototype.fn=function(query,d,i){var dates=query.dates(this),datePos=pyfy.util.bisect(dates,d);return datePos?query.fetch(this.args.parent,d,i)-query.fetch(this.args.parent,dates[datePos-1],i):0},pyfy.max=function(parent,max){return(new Max).set("parent",parent).set("max",max)},Max.prototype=new Base,Max.prototype.fn=function(query,d,i){return Math.max(query.fetch(this.args.parent,d,i),this.args.max)},pyfy.min=function(parent,min){return(new Min).set("parent",parent).set("min",min)},Min.prototype=new Base,Min.prototype.fn=function(query,d,i){return Math.min(query.fetch(this.args.parent,d,i),this.args.min)},pyfy.neg=function(parent){return(new Neg).set("parent",parent)},Neg.prototype=new Base,Neg.prototype.fn=function(query,d,i){return-query.fetch(this.args.parent,d,i)},pyfy.acct=function(parent,start){return(new Acct).set("parent",parent).set("start",start||0)},Acct.prototype=new Base,Acct.prototype.fn=function(query,d,i){var dates=query.dates(this.args.parent),pos=pyfy.util.bisect(dates,d);return 1>pos?this.args.start:dates[pos]==d?query.fetch(this,dates[pos-1],i)+query.fetch(this.args.parent,d,i):query.fetch(this,dates[pos-1],i)},pyfy.call=function(parent,strike){return(new Call).set("parent",parent).set("strike",strike)},Call.prototype=new Base,Call.prototype.fn=function(query,d,i){return Math.max(query.fetch(this.args.parent,d,i)-this.args.strike,0)},pyfy.put=function(parent,strike){return(new Put).set("parent",parent).set("strike",strike||0)},Put.prototype=new Base,Put.prototype.fn=function(query,d,i){return Math.max(this.args.strike-query.fetch(this.args.parent,d,i),0)},pyfy.Calendar=function(parent,calendar){return(new Calendar).set("parent",parent).set("calendar",calendar||pyfy.calendar.weekday)},Calendar.prototype=new Base,Calendar.prototype.checkDate=function(date){function isHoliday(){return!calendar.every(function(d){var fn="string"==typeof d?pyfy.calendar[d]:d;return fn(date)},this)}function nextDay(){if(date=new Date(date.getFullYear(),date.getMonth(),date.getDate()+1),i++>31)throw"Calendar function always returns false"}date=new Date(date);for(var calendar=[].concat(this.args.calendar),i=0;isHoliday();)nextDay();return date.valueOf()},Calendar.prototype.rawDates=function(rawDates,query){var cache=query.cache[this.ID];rawDates={},cache.dateMap={};for(var pd in this.args.parent.rawDates()){var date=this.checkDate(+pd);rawDates[date]=+date,cache.dateMap[date]=+pd}return rawDates},Calendar.prototype.fn=function(query,d){var cache=query.cache[this.ID];return query.fetch(this.args.parent,cache.dateMap[d]||this.calendar(d))},pyfy.operator=pyfy.Operator=Operator;var ops={add:function(a,b){return a+b},sub:function(a,b){return a-b},mul:function(a,b){return a*b},div:function(a,b){return a/b},pow:function(a,b){return Math.pow(a,b)},gt:function(a,b){return 1*(a>b)},lt:function(a,b){return 1*(b>a)}};Object.keys(ops).forEach(function(op){Base.prototype[op]=function(d){return new Operator(op,this,d)}}),Operator.prototype=new Base,Operator.prototype.fn=function(query,d,i){var left,right;return right=query.fetch(this.args.right,d,i),right||"mul"!=this.op?(left=query.fetch(this.args.left,d,i),ops[this.op](left,right)):0},pyfy.daycount=pyfy.daycount||{},pyfy.daycount.d_30_360=function(d1,d2){return 31==d1.d&&(d1.d=30),30==d1.d&&31==d2.d&&(d2.d=30),(360*(d2.y-d1.y)+30*(d2.m-d1.m)+(d2.d-d1.d))/360},pyfy.daycount.d_30E_360=function(d1,d2){return 31==d1.d&&(d1.d=30),31==d2.d&&(d2.d=30),(360*(d2.y-d1.y)+30*(d2.m-d1.m)+(d2.d-d1.d))/360},pyfy.daycount.d_30_360US=function(d1,d2){return d1.lastofFeb&&d2.lastofFeb&&(d2.d=30),d1.lastofFeb&&(d1.d=30),31!=d2.d||30!=d1.d&&31!=d1.d||(d2.d=30),31==d1.d&&(d1.d=30),(360*(d2.y-d1.y)+30*(d2.m-d1.m)+(d2.d-d1.d))/360},pyfy.daycount.d_act_360=function(d1,d2){return Math.round((d2.date-d1.date)/pyfy.util.DAYMS)/360},pyfy.daycount.d_act_act=function(d1,d2){for(var dct=0,_d1=d1.date,_d2=new Date(Math.min(new Date(_d1.getFullYear()+1,0,1),d2.date));_d1<d2.date;){var testDate=new Date(_d1.getFullYear(),1,29),denom=29==testDate.getDate()?366:365;dct+=Math.round((_d2-_d1)/pyfy.util.DAYMS)/denom,_d1=_d2,_d2=new Date(Math.min(new Date(_d1.getFullYear()+1,0,1),d2.date))}return dct},pyfy.calendar={},pyfy.calendar.weekday=function(d){var weekday=d.getDay();return 0!==weekday&&6!=weekday},pyfy.calendar.easter=function(date,dt){dt=dt||[1,-2];var y,c,n,k,i,j,l,m,d;return 1<date.getMonth()<4?(y=date.getFullYear(),c=~~(y/100),n=y-19*~~(y/19),k=~~((c-17)/25),i=c-~~(c/4)-~~((c-k)/3)+19*n+15,i-=30*~~(i/30),i-=i/28*(1-~~(i/28)*~~(29/(i+1))*~~((21-n)/11)),j=y+~~(y/4)+i+2-c+~~(c/4),j-=7*~~(j/7),l=i-j,m=3+~~((l+40)/44)-1,d=Math.round(l+28-31*~~(m/4)),dt.every(function(dt){return date-new Date(y,m,d+dt)})):!0},pyfy.calendar.target=function(date){var m=date.getMonth(),d=date.getDate();return!(!pyfy.calendar.weekday(date)||!pyfy.calendar.easter(date,[1,-2])||0===m&&1==d||11==m&&(26==d||25==d)||4==m&&1==d)},pyfy.calendar.is=function(date){var y=date.getFullYear(),m=date.getMonth(),d=date.getDate();return!(!pyfy.calendar.weekday(date)||!pyfy.calendar.easter(date,[1,-2,-3,39,50])||5==m&&17==d||0===m&&1==d||11==m&&(26==d||25==d)||4==m&&1==d||7==m&&0===date-pyfy.util.nextWeekday(new Date(y,7,1),1)||3==m&&0===date-pyfy.util.nextWeekday(new Date(y,3,19),4))},pyfy.dcf=function(parent,daycount){return(new Dcf).set("parent",parent).set("daycount",daycount||pyfy.daycount.d_30_360)},Dcf.prototype=new Base,Dcf.prototype.fn=function(query,d){"string"==typeof this.args.daycount&&(this.args.daycount=pyfy.daycount[this.args.daycount]);var cache=query.cache[this.ID];if(!Object.keys(cache.values).length){var dates=query.dates(this);cache.values={},dates.slice(1).forEach(function(d,i){var d1=pyfy.util.dateParts(dates[i]),d2=pyfy.util.dateParts(d);cache.values[d]=dates[i]?this.args.daycount(d1,d2):0},this)}return cache.values[d]||0},pyfy.timeDiff=function(parent,date,daycount){return(new TimeDiff).set("parent",parent).set("daycount",daycount||pyfy.daycount.d_30_360).set("date",date||new Date)},TimeDiff.prototype=new Base,TimeDiff.prototype.fn=function(query,d){var date=this.args.date;if("string"==typeof date){var parentDates=query.dates(this.args.parent);date=new Date("L"===date.slice(0,1).toUpperCase()?parentDates[parentDates.length-1]:parentDates[0])}return Math.abs(this.args.daycount(pyfy.util.dateParts(date),pyfy.util.dateParts(new Date(d))))},pyfy.ir=function(data,options){return(new Ir).set("data",data).set("options",options)},Ir.prototype=new Stock,Ir.prototype.setDaycount=function(d){return this.args.daycount="string"==typeof d?pyfy.daycount[d]:d,this},Ir.prototype._fn=function(d,last,next){return this.args.data[next]},pyfy.df=function(d){return new Derived(d)},Df.prototype=new Base,Df.prototype.fn=function(query,d,i){var dates=query.dates(this),pos=pyfy.util.bisect(dates,d),last=dates[pos-1];if(!last)return d==dates[pos]?1:0;var dcf=this.parent.daycount(pyfy.util.dateParts(last),pyfy.util.dateParts(d));return query.fetch(this,last,i)*Math.exp(-query.fetch(this.args.parent,d,i)*dcf)},pyfy.bond=Bond,Bond.prototype=new Base,Bond.prototype.generate=function(){this.bal=pyfy.acct(this.notional||1),this.p_scheduled=this.schedule.mul(this.notional),this.p=this.schedule.mul(this.notional),this.bal.setParent(this.p.neg()),this.i=this.bal.prev().dcf().mul(this.rate),this.set("parent",this.p.add(this.i))},Bond.prototype.setSchedule=function(d){return this.schedule=d,this.generate(),this};var z=new Ziggurat;pyfy.rndNorm=z.nextGaussian,pyfy.random=Random,Random.prototype=new Base,Random.prototype.fn=function(){var x,y,r;do x=2*Math.random()-1,y=2*Math.random()-1,r=x*x+y*y;while(!r||r>1);return x*Math.sqrt(-2*Math.log(r)/r)},Random.prototype.correl=function(correl){return pyfy.correl(this,correl)},Random.prototype.wiener=function(){return pyfy.wiener(this)},pyfy.wiener=Wiener,Wiener.prototype=new Base,Wiener.prototype.rawDates=function(query){var res={};return query&&query.cache[this.ID]&&query.cache[this.ID].dates&&query.cache[this.ID].dates.forEach(function(d){res[d]=d}),res},Wiener.prototype.fn=function(query,d){var val,cache=query.cache[this.ID];if(!cache.dates)return cache.dates=[d],cache.first={x:d,y:0},cache.last={x:d,y:0},0;if(d>cache.last.x)return cache.dates.push(d),val=cache.last.y+query.fetch(this.random,d)*(d-cache.last.x)/pyfy.util.DAYMS/365.25,cache.last={x:d,y:val},val;if(d<cache.first.x)return cache.dates.slice(0,0,d),val=cache.min.y-query.fetch(this.random,d)*(cache.first.x-d)/pyfy.util.DAYMS/365.25,cache.first={x:d,y:val},val;var datePos=pyfy.util.bisect(cache.dates,d),prev={x:cache.dates[datePos-1]},next={x:cache.dates[datePos]};return prev.y=query.fetch(this,prev.x),next.y=query.fetch(this,next.x),cache.dates.splice(datePos,0,d),prev.y+(d-prev.x)/(next.x-prev.x)*(next.y-prev.y)},Wiener.prototype.dates=function(query){return query?query.cache[this.ID].dates.all:[]},pyfy.logNorm=function(spot,vol,drift,random){return(new Base).set("spot",spot).set("vol",vol).set("drift",drift).set("random",random||new Random)},LogNorm.prototype=new Base,LogNorm.prototype.fn=function(query,d,i){var cache=query.cache[this.ID];if(i=i||0,!cache.extent){var spotDates=query.dates(this.args.spot);if(!spotDates.length)throw"no date information in spot";cache.extent={first:spotDates[0],last:spotDates[spotDates.length-1]}}var res=query.fetch(this.args.spot,d,i);if(res)return res;var prev,next,drift,rnd,dt,vol,dates=query.dates(this),datePos=(dates.length,pyfy.util.bisect(cache.dates,d)),pd=d<cache.extent.first?dates[datePos]:d;return vol=query.fetch(this.args.vol,pd,i),rnd=query.fetch(this.args.random,pd,i),drift=query.fetch(this.args.drift,pd,i),dt=d<cache.extent.first?dates[datePos]-d:d-dates[datePos-1],dt=dt/pyfy.util.DAYMS/365.25,d>cache.extent.last?(prev=query.fetch(this,dates[datePos-1],i),i||(dates.push(d),cache.extent.last=d),prev*pyfy_exp(vol,drift,rnd,dt)):d<cache.extent.first?(next=query.fetch(this,dates[datePos],i),i||(dates.splice(0,0,d),cache.extent.first=d),next/pyfy_exp(vol,drift,rnd,dt)):(prev=query.fetch(this,dates[datePos-1],i),next=query.fetch(this,dates[datePos],i),drift=Math.log(next/prev)/((dates[datePos]-dates[datePos-1])/pyfy.util.DAYMS/365.25),i||dates.splice(datePos,0,d),prev*pyfy_exp(vol,drift,rnd,dt))},pyfy.correl=Correl,Correl.prototype=new Random,Correl.prototype.fn=function(query,d,i){var correl=query.fetch(this.args.correl,d,i);return correl*query.fetch(this.args.parent,d,i)+Math.sqrt(1-correl*correl)*query.fetch(this.args.random,d,i)},pyfy.simul=Simul,Simul.prototype=new Query,Simul.prototype.fetch=function(obj,d,i){if(!isNaN(obj))return obj;var values=this.cache[obj.ID].values;if(values[d]=values[d]||[],void 0===values[d][i]){var fn=obj.fn(this,d.valueOf(),i);void 0!==fn&&(values[d][i]=fn)}return values[d][i]},Simul.prototype.get=function(obj,dates){return this.initCache(obj),[].concat(dates||this.dates(obj)).map(function(d){for(var res=[],i=this.num;i--;)res.push(this.fetch(obj,d.valueOf(),i));return res},this)}}();