/**
  * pyfy.js (c) 2008-2013 Sigurgeir Orn Jonsson (ziggy.jonsson.nyc@gmail.com)
  * @license http://creativecommons.org/licenses/by-nc-sa/3.0/
  * Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported (CC BY-NC-SA 3.0)
  */
(function(){function t(t,n){return+t-n}function n(t,n,e,r){return t.fetch?t.fetch(n,e,r):t}function e(t){this.rawDates={},this.cache={},this.cache[t]={values:[]}}function r(){this.ID=E++}function a(t){this.const=t||0}function o(t){this.parents=t}function i(t){r.apply(this,arguments),this.data={},this._dates=[],t&&this.update(t)}function s(){i.apply(this,arguments)}function u(){i.apply(this,arguments)}function h(){i.apply(this,arguments)}function c(t,n){r.call(this,arguments),this.parent=t||new r,n&&(this.fn=n)}function p(t,n,e){c.call(this,t),this.start=n||-1/0,this.fin=e||1/0}function f(t){c.call(this,t)}function y(t){c.call(this,t)}function d(t){c.call(this,t)}function l(t,n){c.call(this,t),this.max=n||0}function w(t,n){c.call(this,t),this.min=n||0}function D(t){c.call(this,t)}function v(t,n){c.call(this,t),n&&(this.calendar=n)}function m(t,n,e){r.apply(this,arguments),this.left=n,this.right=e,this.op=t}function g(t,n){c.call(this,t),void 0!==n&&this.setDaycount(n)}function M(){u.apply(this,arguments),this.df=new x(this)}function x(t,n){c.call(this,t),this.val=n}function I(){function t(){var t=e(),r=127&t;return u[r]>Math.abs(t)?t*i[r]:n(t,r)}function n(t,n){for(var a,o,h=3.442619855899,c=1/h;;){if(a=t*i[n],0===n){for(a=-Math.log(r())*c,o=-Math.log(r());a*a>o+o;)a=-Math.log(r())*c,o=-Math.log(r());return t>0?h+a:-h-a}if(Math.exp(-.5*a*a)>s[n]+r()*(s[n-1]-s[n]))return a;if(t=e(),n=127&t,u[n]>Math.abs(t))return t*i[n]}}function e(){var t=o,n=o;return n^=n<<13,n^=n>>>17,n^=n<<5,o=n,0|t+n}function r(){return.5*(1+e()/-Math.pow(2,31))}function a(){o^=(new Date).getTime();var t=2147483648,n=3.442619855899,e=n,r=.00991256303526217,a=r/Math.exp(-.5*n*n);u[0]=Math.floor(n/a*t),u[1]=0,i[0]=a/t,i[127]=n/t,s[0]=1,s[127]=Math.exp(-.5*n*n);for(var h=126;h>=1;h--)n=Math.sqrt(-2*Math.log(r/n+Math.exp(-.5*n*n))),u[h+1]=Math.floor(n/e*t),e=n,s[h]=Math.exp(-.5*n*n),i[h]=n/t}var o=123456789,i=Array(128),s=Array(128),u=Array(128);this.nextGaussian=function(){return t()},a()}function _(){return 2*Math.random()-1+(2*Math.random()-1)+(2*Math.random()-1)}function F(t,n,e){r.apply(this),this.s=t||0,this.r=n||0,this.vol=e||0}var b=this.pyfy={};"undefined"!=typeof module&&(module.exports=b),b.util={},b.util.DAYMS=864e5,b.util.dateParts=function(t){var n={y:t.getFullYear(),m:t.getMonth(),d:t.getDate()};return n.date=new Date(n.y,n.m,n.d),n.lastofMonth=new Date(n.y,n.m,n.d+1).getMonth()==n.m+1,n.lastFeb=2==n.m&&n.lastofMonth,n},b.util.today=function(){return pyty.util.dateParts(new Date)},b.util.nextDay=function(t,n){return void 0===n&&(n=0),new Date(t.getFullYear(),t.getMonth(),t.getDate()+n)},e.prototype.register=function(t){this.cache[t]||(this.cache[t]={})},e.prototype.y=function(t){return this.cache[t].values},e.prototype.x=function(){return this.dates},e.prototype.val=function(t){return this.y(t).map(function(t,n){return{x:this.dates[n],y:t}},this)};var E=0;b.base=function(){return new r},b.Base=r,r.prototype.dates=function(n,r){r=r||new e(this.ID),r.dates=[];var a=this.rawDates(r);n&&[].concat(n).forEach(function(t){r.rawDates[t]=t});for(var o in a)r.dates.push(a[o]);return r.dates.sort(t)},r.prototype.rawDates=function(t){if(t=t||new e(this.ID),t.cache[this.ID]=t.cache[this.ID]||{},!t.cache[this.ID].rawDates&&this.inputs){var n="function"==typeof this.inputs?this.inputs():this.inputs;t.cache[this.ID].rawDates=!0,[].concat(n).forEach(function(n){n.rawDates&&n.rawDates(t)})}return t.rawDates},r.prototype.y=function(t){return this.exec(t).y(this.ID)},r.prototype.x=function(t){return this.dates(t)},r.prototype.val=function(t){return this.exec(t).val(this.ID)},r.prototype.exec=function(t){var n=new e,r=n.dates=this.dates(t,n),a=r.length;return n.cache[this.ID]=n.cache[this.ID]||{},n.cache[this.ID].values=[],r.every(function(t,e){return this.fetch(n,t,e),n.cache[this.ID].values.length!=a},this),n},r.prototype.fetch=function(t,n,e){if(t.cache[this.ID]||(t.cache[this.ID]={}),t.cache[this.ID].values||(t.cache[this.ID].values=[]),void 0===t.cache[this.ID].values[e]){var r=this.fn(t,n,e);void 0!==r&&(t.cache[this.ID].values[e]=r)}return t.cache[this.ID].values[e]},[y,d,f,l,w,D,v,g].forEach(function(t){r.prototype[t.name.toLowerCase()]=function(n){return new t(this,n)}}),r.prototype.pv=function(t,n,e){var r=0;return this.mul(t.df(n)).y(null,e).forEach(function(t){r+=t}),r},r.prototype.derived=function(t){return new c(this,t)},r.prototype.period=function(t,n){return new p(this,t,n)},r.prototype.fn=function(){return 0},b.const=b.c=function(t){return r.apply(this,arguments),new a(t)},a.prototype=new r,a.prototype.fn=function(){return this.const},a.prototype.update=a.prototype.set=function(t){return this.const=t,this},b.sum=function(t){return new o(t)},o.prototype=new r,o.prototype.inputs=function(){return this.parents},o.prototype.fn=function(t,n,e){var r=0;return this.parents.forEach(function(n){r+=n.fetch(t,n,e)}),r},b.Data=i,i.prototype=new r,i.prototype.rawDates=function(t){return t=t||new e,t.cache[this.ID]=t.cache[this.ID]||{},t.cache[this.ID].rawDates||(this._dates.forEach(function(n){t.rawDates[n]=n}),t.cache[this.ID].rawDates=!0),t.rawDates},i.prototype.update=function(n){if(0===arguments.length)return this;var e=this;if(isNaN(n))void 0===n.length&&(n=[n]),n.forEach(function(t){e.data[t.x]=t});else{var r=today();this.data[r]={x:r,y:n}}return this._dates=Object.keys(this.data).map(function(t){return this.data[t].x},this).sort(t),this},i.prototype.set=function(t){return this.data={},this.update(t)},i.prototype.fn=function(t,n,e){var r=this,a=this.dates(),o=this.data[a[0]],i=this.data[a[a.length-1]];return t.cache[this.ID].values=t.dates.map(function(t){if(!Object.keys(r.data).length)return 0;for(;a.length;){var n=r.data[a[0]];if(t==n.x)return n.y;if(n.x>t)return r._fn(t,o,n);o=n,a=a.slice(1)}return i.y}),t.cache[this.ID].values[e]},i.prototype._fn=function(){return void 0},b.flow=function(t){return new s(t)},b.Flow=s,s.prototype=new i,s.prototype.fn=function(t,n,e){var r=this;return t.cache[this.ID].values=t.dates.map(function(t){return r.data[t]?r.data[t].y:0}),t.cache[this.ID].values[e]},b.Stock=u,b.stock=function(t){return new u(t)},u.prototype=new i,u.prototype._fn=function(t,n){return n.y},b.Price=h,b.price=function(t){return new h(t)},h.prototype=new i,h.prototype._fn=function(t,n,e){return e.x==n.x?n.y:e.x>t?n.y+(e.y-n.y)*(t-n.x)/(e.x-n.x):void 0},b.interval=function(t,n,e,r){for(var a=[],o=0;e+1>o;o++)a.push({x:new Date(t.getFullYear(),t.getMonth()+o*n,t.getDate()),y:r||0==o?0:1});return b.flow(a)},b.Derived=c,c.prototype=new r,c.prototype.inputs=function(){return this.parent},c.prototype.fn=function(t,n,e){return this.parent.fetch(t,n,e)},c.prototype.setParent=function(t){return this.parent=t,this},b.Period=p,p.prototype=new c,p.prototype.fn=function(t,n,e){return n>=this.start&&this.fin>=n?this.parent.fetch(t,n,e):0},b.Last=f,f.prototype=new c,f.prototype.fn=function(t,n,e){return 0+(e>0&&this.parent.fetch(t,n,e-1))},b.Cumul=y,y.prototype=new c,y.prototype.fn=function(t,n,e){return this.parent.fetch(t,n,e)+(e>0&&t.cache[this.ID].values[e-1])},b.Diff=d,d.prototype=new c,d.prototype.fn=function(t,n,e){var r=Math.max(e-1,0);return+this.parent.fetch(t,n,e)-(this.parent.fetch(t,n,r)||0)},b.Max=l,l.prototype=new c,l.prototype.fn=function(t,n,e){return Math.max(this.parent.fetch(t,n,e),this.max)},b.Min=w,w.prototype=new c,w.prototype.fn=function(t,n,e){return Math.min(this.parent.fetch(t,n,e),this.min)},b.Neg=D,D.prototype=new c,D.prototype.fn=function(t,n,e){return-this.parent.fetch(t,n,e)},b.Calendar=v,v.prototype=new c,v.prototype.rawDates=function(t){t=t||new e(this.ID);var n=t.cache[this.ID]=t.cache[this.ID]||{};if(!n.rawDates&&this.parent){var r=n.parentRes=new e,a=this.parent.dates([],r);n.rawDates=!0,n.dateMap={},a.forEach(function(e,r){var a=this.calendar(e);t.rawDates[a]=a,n.dateMap[a]={d:e,i:r}},this)}return t.rawDates},v.prototype.fn=function(t,n){var e=t.cache[this.ID],r=e.dateMap[n];return r?this.parent.fetch(e.parentRes,r.d,r.i):0},v.prototype.calendar=function(t){var n=t.getDay();return 0==n||6==n?this.calendar(new Date(t.getFullYear(),t.getMonth(),t.getDate()+1)):t},b.Operator=m;var Y={add:function(t,n){return t+n},sub:function(t,n){return t-n},mul:function(t,n){return t*n},div:function(t,n){return t/n},pow:function(t,n){return Math.pow(t,n)}};Object.keys(Y).forEach(function(t){r.prototype[t]=function(n){return new m(t,this,n)}}),b.Operator=m,m.prototype=new r,m.prototype.inputs=function(){return[this.left,this.right]},m.prototype.fn=function(t,e,r){var a,o;return o=n(this.right,t,e,r),o||"mul"!=this.op?(a=n(this.left,t,e,r),Y[this.op](a,o)):0},b.daycount=b.daycount||{},b.daycount.d_30_360=function(t,n){return 31==t.d&&(t.d=30),30==t.d&&31==n.d&&(n.d=30),(360*(n.y-t.y)+30*(n.m-t.m)+(n.d-t.d))/360},b.daycount.d_30E_360=function(t,n){return 31==t.d&&(t.d=30),31==n.d&&(n.d=30),(360*(n.y-t.y)+30*(n.m-t.m)+(n.d-t.d))/360},b.daycount.d_30_360US=function(t,n){return t.lastofFeb&&n.lastofFeb&&(n.d=30),t.lastofFeb&&(t.d=30),31!=n.d||30!=t.d&&31!=t.d||(n.d=30),31==t.d&&(t.d=30),(360*(n.y-t.y)+30*(n.m-t.m)+(n.d-t.d))/360},b.daycount.d_act_360=function(t,n){return Math.round((n.date-t.date)/b.util.DAYMS)/360},b.daycount.d_act_act=function(t,n){for(var e=0,r=t.date,a=new Date(Math.min(new Date(r.getFullYear()+1,0,1),n.date));n.date>r;){var o=new Date(r.getFullYear(),1,29),i=29==o.getDate()?366:365;e+=Math.round((a-r)/b.util.DAYMS)/i,r=a,a=new Date(Math.min(new Date(r.getFullYear()+1,0,1),n.date))}return e},b.Dcf=g,g.prototype=new c,g.prototype.fn=function(t){var n=this.dates(),e={};n.slice(1).map(function(t,r){var a=b.util.dateParts(n[r]),o=b.util.dateParts(t);e[t]=this.daycount(a,o)},this),t.cache[this.ID].values=t.dates.map(function(t){return e[t]||0})},g.prototype.daycount=b.daycount.d_30_360,g.prototype.setDaycount=function(t){return this.daycount="string"==typeof t?b.daycount[t]:t,this},b.ir=function(t){return new M(t)},M.prototype=new u,b.df=function(t){return new x(t)},x.prototype=new c,x.prototype.fn=function(t,e,r){var a=this,o=t.__dt__[r]/365;return 0===r?1:n(this,t,e,r-1)*Math.exp(-n(a.parent,t,e,r)*o)};var P=new I,_=b.rndNorm=P.nextGaussian;b.norm=function(t,n,e){return new F(t,n,e)},F.prototype=new r,F.prototype.inputs=function(){return[this.s,this.r,this.vol]},F.prototype.fn=function(t,e,r){var a=this.s;t.__dates__;var o=(t.dates[r]-(t.dates[r-1]||t.dates[0]))/365,a=r>0?this.fetch(t,e,r-1):this.s,i=n(this.r,t,e,r),s=n(this.vol,t,e,r),u=(i-Math.pow(s,2)/2)*o+s*Math.sqrt(o)*_();return a*Math.exp(u)}})();