/**
  * pyfy.js (c) 2008-2013 Sigurgeir Orn Jonsson (ziggy.jonsson.nyc@gmail.com)
  * @license http://creativecommons.org/licenses/by-nc-sa/3.0/
  * Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported (CC BY-NC-SA 3.0)
  */
(function(){function t(t,n){return+t-n}function n(t){return t}function e(){this.rawDates={},this.cache={}}function r(){this.ID=E++}function a(t){this.const=t||0}function o(t){this.parents=t}function i(t){r.apply(this,arguments),this.data={},this._dates=[],t&&this.update(t)}function s(){i.apply(this,arguments)}function u(){i.apply(this,arguments)}function c(){i.apply(this,arguments)}function h(t,n){r.call(this,arguments),this.parent=t||new r,n&&(this.fn=n)}function f(t,n,e){h.call(this,t),this.start=n||-1/0,this.fin=e||1/0}function p(t,n){h.call(this,t),this.default=n||0}function d(t){h.call(this,t)}function y(t){h.call(this,t)}function l(t,n){h.call(this,t),this.max=n||0}function w(t,n){h.call(this,t),this.min=n||0}function D(t){h.call(this,t)}function v(t){h.call(this,t),this.start=t||0}function g(t,n){h.call(this,t),n&&(this.calendar=n)}function m(t,n,e){r.apply(this,arguments),this.left=n,this.right=e,this.op=t}function M(t,n){h.call(this,t),void 0!==n&&this.setDaycount(n)}function _(){u.apply(this,arguments),this.df=new x(this),this.daycount=F.daycount.d_30_360}function x(t,n){h.call(this,t),this.val=n}function I(){function t(){var t=e(),r=127&t;return u[r]>Math.abs(t)?t*i[r]:n(t,r)}function n(t,n){for(var a,o,c=3.442619855899,h=1/c;;){if(a=t*i[n],0===n){for(a=-Math.log(r())*h,o=-Math.log(r());a*a>o+o;)a=-Math.log(r())*h,o=-Math.log(r());return t>0?c+a:-c-a}if(Math.exp(-.5*a*a)>s[n]+r()*(s[n-1]-s[n]))return a;if(t=e(),n=127&t,u[n]>Math.abs(t))return t*i[n]}}function e(){var t=o,n=o;return n^=n<<13,n^=n>>>17,n^=n<<5,o=n,0|t+n}function r(){return.5*(1+e()/-Math.pow(2,31))}function a(){o^=(new Date).getTime();var t=2147483648,n=3.442619855899,e=n,r=.00991256303526217,a=r/Math.exp(-.5*n*n);u[0]=Math.floor(n/a*t),u[1]=0,i[0]=a/t,i[127]=n/t,s[0]=1,s[127]=Math.exp(-.5*n*n);for(var c=126;c>=1;c--)n=Math.sqrt(-2*Math.log(r/n+Math.exp(-.5*n*n))),u[c+1]=Math.floor(n/e*t),e=n,s[c]=Math.exp(-.5*n*n),i[c]=n/t}var o=123456789,i=Array(128),s=Array(128),u=Array(128);this.nextGaussian=function(){return t()},a()}function b(){return 2*Math.random()-1+(2*Math.random()-1)+(2*Math.random()-1)}function P(t,n,e){r.apply(this),this.s=t||0,this.r=n||0,this.vol=e||0}var F=this.pyfy={};"undefined"!=typeof module&&(module.exports=F),F.util={},F.util.DAYMS=864e5,F.util.dateParts=function(t){t=new Date(t);var n={y:t.getFullYear(),m:t.getMonth(),d:t.getDate()};return n.date=new Date(n.y,n.m,n.d),n.lastofMonth=new Date(n.y,n.m,n.d+1).getMonth()==n.m+1,n.lastFeb=2==n.m&&n.lastofMonth,n},F.util.today=function(){return F.util.dateParts(new Date).date},F.util.nextDay=function(t,n){return void 0===n&&(n=0),new Date(t.getFullYear(),t.getMonth(),t.getDate()+n)},F.util.bisect=function(t,e,r,a){for(3>arguments.length&&(r=0),4>arguments.length&&(a=t.length);a>r;){var o=r+a>>>1;e>n.call(t,t[o],o)?r=o+1:a=o}return r},F.res=function(t,n){return n=n||new e,n.cache[t]=n.cache[t]||{values:{}},n.cache[t].values=n.cache[t].values||{},n},e.prototype.register=function(t){this.cache[t]||(this.cache[t]={})},e.prototype.y=function(t){return"object"==typeof t&&(t=t.ID),this.dates.map(function(n){return this.cache[t].values[n]},this)},e.prototype.x=function(){return"object"==typeof id&&(id=id.ID),this.dates.map(function(t){return new Date(t)})},e.prototype.val=function(t){return"object"==typeof t&&(t=t.ID),this.y(t).map(function(t,n){return{x:new Date(this.dates[n]),y:t}},this)},e.prototype.get=function(t,n){return n||(n=t.dates()),[].concat(n).map(function(n){return this.fetch(t,n)},this)},e.prototype.fetch=function(t,n){if(!isNaN(t))return t;this.cache[t.ID]||(this.cache[t.ID]={values:{}});var e=this.cache[t.ID].values;if(void 0===e[n]){var r=t.fn(this,n);void 0!==r&&(e[n]=r)}return e[n]};var E=0;F.base=function(){return new r},F.Base=r,r.prototype.dates=function(n){n=n||new e(this.ID);var r=n.cache[this.ID]=n.cache[this.ID]||{values:{}};if(!r.dates){var a=this.rawDates(n);r.dates=[],r.datePos={};for(var o in a)r.dates.push(+a[o]);r.dates.sort(t).forEach(function(t,n){r.datePos[t]=n})}return r.dates},r.prototype.rawDates=function(t){t=F.res(this.ID,t);var n=t.cache[this.ID];if(!n.rawDates){n.rawDates={};var e="function"==typeof this.inputs?this.inputs():this.inputs;[].concat(e).filter(function(t){return t&&t.rawDates}).forEach(function(e){for(var r in e.rawDates(t))n.rawDates[r]=+r})}return n.rawDates},r.prototype.exec=function(n){var e=F.res(this.ID);return e.dates=this.dates(e),n&&(n=[].concat(n).map(function(t){return t.valueOf()}),e.dates=e.dates.concat(n).sort(t)),e.dates.forEach(function(t){e.fetch(this,t)},this),e},r.prototype.fn=function(){return 0},[d,y,p,l,w,D,g,M,f,h].forEach(function(t){r.prototype[t.name.toLowerCase()]=function(n,e,r){return new t(this,n,e,r)}}),r.prototype.pv=function(t){var n=0;return isNaN(t)||(t=F.ir(t)),this.mul(t.df).y().forEach(function(t){n+=t}),n},r.prototype.y=function(t){return this.exec(t).y(this.ID)},r.prototype.x=function(t){return this.exec(t).x(this.ID)},r.prototype.val=function(t){return this.exec(t).val(this.ID)},F.const=F.c=function(t){return r.apply(this,arguments),new a(t)},a.prototype=new r,a.prototype.fn=function(){return this.const},a.prototype.update=a.prototype.set=function(t){return this.const=t,this},F.sum=function(t){return new o(t)},o.prototype=new r,o.prototype.inputs=function(){return this.parents},o.prototype.fn=function(t,n){var e=0;return this.parents.forEach(function(r){e+=t.fetch(r,n)}),e},F.Data=i,i.prototype=new r,i.prototype.rawDates=function(t){t=F.res(this.ID,t);var n=t.cache[this.ID];return n.rawDates||(n.rawDates={},this._dates.forEach(function(t){n.rawDates[t]=t})),n.rawDates},i.prototype.update=function(n){if(0===arguments.length)return this;if(isNaN(n))[].concat(n).forEach(function(t){this.data[t.x.valueOf()]=t.y},this);else{var e=F.util.today().valueOf();this.data[e]=n}return this._dates=Object.keys(this.data).map(function(t){return+t}).sort(t),this},i.prototype.set=function(t){return this.data={},this.update(t)},i.prototype.fn=function(t,n){if(!Object.keys(this.data).length)return 0;if(this.data[n])return this.data[n];var e=this.dates(),r=F.util.bisect(e,n),a=r-1;return r==e.length&&(r-=1),0===r&&(a=0),this._fn(n,e[a]||e[r],e[r])},i.prototype._fn=function(){return void 0},F.flow=function(t){return new s(t)},F.Flow=s,s.prototype=new i,s.prototype.fn=function(t,n){return this.data[n]||0},F.Stock=u,F.stock=function(t){return new u(t)},u.prototype=new i,u.prototype._fn=function(t,n){return this.data[n]},F.Price=c,F.price=function(t){return new c(t)},c.prototype=new i,c.prototype._fn=function(t,n,e){var r=this.data[n],a=this.data[e];return n==e?a:e>(t>n)?r+(a-r)*(t-n)/(e-n):a},F.interval=function(t,n,e,r){for(var a=[],o=0;e+1>o;o++)a.push({x:new Date(t.getFullYear(),t.getMonth()+o*n,t.getDate()),y:r||!o?0:1});return F.flow(a)},F.Derived=h,h.prototype=new r,h.prototype.inputs=function(){return this.parent},h.prototype.rawDates=function(t){return this.parent.rawDates(t)},h.prototype.fn=function(t,n){return t.fetch(this.parent,n)},h.prototype.setParent=function(t){return this.parent=t,this},F.Period=f,f.prototype=new h,f.prototype.fn=function(t,n){return n>=this.start&&this.fin>=n?t.fetch(this.parent,n):0},F.Last=p,p.prototype=new h,p.prototype.fn=function(t,n){var e=this.dates(t),r=t.cache[this.ID].datePos[n];return r>0?t.fetch(this.parent,e[r-1]):this.default},F.Cumul=d,d.prototype=new h,d.prototype.fn=function(t,n){var e=this.dates(t),r=t.cache[this.ID].datePos[n];return t.fetch(this.parent,n)+(r?t.fetch(this,e[r-1]):0)},F.Diff=y,y.prototype=new h,y.prototype.fn=function(t,n){var e=this.dates(t),r=t.cache[this.ID].datePos[n];return r?t.fetch(this.parent,n)-t.fetch(this.parent,e[r-1]):0},F.Max=l,l.prototype=new h,l.prototype.fn=function(t,n){return Math.max(t.fetch(this.parent,n),this.max)},F.Min=w,w.prototype=new h,w.prototype.fn=function(t,n){return Math.min(t.fetch(this.parent,n),this.min)},F.Neg=D,D.prototype=new h,D.prototype.fn=function(t,n){return-t.fetch(this.parent,n)},F.Acct=v,F.acct=function(t){return new v(t)},v.prototype=new h,v.prototype.fn=function(t,n){var e=this.parent.dates(t);return pos=F.util.bisect(e,n),1>pos?this.start:e[pos]==n?t.fetch(this,e[pos-1])+t.fetch(this.parent,n):t.fetch(this,e[pos-1])},F.Calendar=g,g.prototype=new h,g.prototype.rawDates=function(t){t=F.res(this.ID,t);var n=t.cache[this.ID];n.dateMap={},n.rawDates={};for(var e in this.parent.rawDates(t)){var r=this.calendar(new Date(+e)).valueOf();n.rawDates[r]=+r,n.dateMap[r]=+e}return n.rawDates},g.prototype.fn=function(t,n){var e=t.cache[this.ID];return t.fetch(this.parent,e.dateMap[n]||this.calendar(n))},g.prototype.calendar=function(t){var n=t.getDay();return 0===n||6===n?this.calendar(new Date(t.getFullYear(),t.getMonth(),t.getDate()+1)):t},F.Operator=m;var O={add:function(t,n){return t+n},sub:function(t,n){return t-n},mul:function(t,n){return t*n},div:function(t,n){return t/n},pow:function(t,n){return Math.pow(t,n)}};Object.keys(O).forEach(function(t){r.prototype[t]=function(n){return new m(t,this,n)}}),F.Operator=m,m.prototype=new r,m.prototype.inputs=function(){return[this.left,this.right]},m.prototype.fn=function(t,n){var e,r;return r=t.fetch(this.right,n),r||"mul"!=this.op?(e=t.fetch(this.left,n),O[this.op](e,r)):0},F.daycount=F.daycount||{},F.daycount.d_30_360=function(t,n){return 31==t.d&&(t.d=30),30==t.d&&31==n.d&&(n.d=30),(360*(n.y-t.y)+30*(n.m-t.m)+(n.d-t.d))/360},F.daycount.d_30E_360=function(t,n){return 31==t.d&&(t.d=30),31==n.d&&(n.d=30),(360*(n.y-t.y)+30*(n.m-t.m)+(n.d-t.d))/360},F.daycount.d_30_360US=function(t,n){return t.lastofFeb&&n.lastofFeb&&(n.d=30),t.lastofFeb&&(t.d=30),31!=n.d||30!=t.d&&31!=t.d||(n.d=30),31==t.d&&(t.d=30),(360*(n.y-t.y)+30*(n.m-t.m)+(n.d-t.d))/360},F.daycount.d_act_360=function(t,n){return Math.round((n.date-t.date)/F.util.DAYMS)/360},F.daycount.d_act_act=function(t,n){for(var e=0,r=t.date,a=new Date(Math.min(new Date(r.getFullYear()+1,0,1),n.date));n.date>r;){var o=new Date(r.getFullYear(),1,29),i=29==o.getDate()?366:365;e+=Math.round((a-r)/F.util.DAYMS)/i,r=a,a=new Date(Math.min(new Date(r.getFullYear()+1,0,1),n.date))}return e},F.Dcf=M,M.prototype=new h,M.prototype.fn=function(t){var n=t.cache[this.ID];if(Object.keys(n.values).length)return 0;var e=this.dates();n.values={},e.slice(1).forEach(function(t,r){var a=F.util.dateParts(e[r]),o=F.util.dateParts(t);n.values[t]=this.daycount(a,o)},this)},M.prototype.daycount=F.daycount.d_30_360,M.prototype.setDaycount=function(t){return this.daycount="string"==typeof t?F.daycount[t]:t,this},F.ir=function(t){return new _(t)},_.prototype=new u,_.prototype.setDaycount=function(t){return this.daycount="string"==typeof t?F.daycount[t]:t,this},_.prototype._fn=function(t,n,e){return this.data[e]},F.df=function(t){return new h(t)},x.prototype=new M,x.prototype.rawDates=function(t){return r.prototype.rawDates.call(this,t),{}},x.prototype.fn=function(t,n){var e=this.dates(t),r=F.util.bisect(e,n),a=e[r-1];if(!a)return n==e[r]?1:0;var o=this.parent.daycount(F.util.dateParts(a),F.util.dateParts(n));return t.fetch(this,a)*Math.exp(-t.fetch(this.parent,n)*o)};var Y=new I,b=F.rndNorm=Y.nextGaussian;F.norm=function(t,n,e){return new P(t,n,e)},P.prototype=new r,P.prototype.inputs=function(){return[this.s,this.r,this.vol]},P.prototype.fn=function(t,n,e){var r=this.s;t.__dates__;var a=(t.dates[e]-(t.dates[e-1]||t.dates[0]))/365,r=e>0?this.fetch(t,n,e-1):this.s,o=fetch(this.r,t,n,e),i=fetch(this.vol,t,n,e),s=(o-Math.pow(i,2)/2)*a+i*Math.sqrt(a)*b();return r*Math.exp(s)}})();