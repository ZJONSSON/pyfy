/**
  * pyfy.js (c) 2008-2013 Sigurgeir Orn Jonsson (ziggy.jonsson.nyc@gmail.com)
  * @license http://creativecommons.org/licenses/by-nc-sa/3.0/
  * Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported (CC BY-NC-SA 3.0)
  */
(function(){function t(t,e){return+t-e}function e(t){return t}function n(){return this instanceof n?(this.cache={},void 0):new n}function r(){return this instanceof r?(this.ID=N++,void 0):new r}function a(t,e){return this instanceof a?(this.const=t||0,void 0):new a(t,e)}function i(t){return this instanceof i?(this.parents=t,void 0):new i(t)}function o(t,e){return this instanceof o?(r.apply(this,arguments),this.data={},this._dates=[],t&&this.update(t),void 0):new o(t,e)}function s(t,e){return this instanceof s?(o.apply(this,arguments),void 0):new s(t,e)}function u(t,e){return this instanceof u?(o.apply(this,arguments),void 0):new u(t,e)}function h(t,e){return this instanceof h?(o.apply(this,arguments),void 0):new h(t,e)}function c(t,e){return this instanceof c?(o.apply(this,arguments),void 0):new c(t,e)}function f(t,e){return this instanceof f?(r.call(this,arguments),this.parent=t||new r,e&&(this.fn=e),void 0):new f(t,e)}function p(t,e,n){return this instanceof p?(f.call(this,t),this.start=e||-1/0,this.fin=n||1/0,void 0):new p(t,e,n)}function d(t,e){return this instanceof d?(f.call(this,t),this.default=e||0,void 0):new d(t,e)}function l(t){return this instanceof l?(f.call(this,t),void 0):new l(t)}function y(t){return this instanceof y?(f.call(this,t),void 0):new y}function v(t,e){return this instanceof v?(f.call(this,t),this.max=e||0,void 0):new v(t,e)}function w(t,e){return this instanceof w?(f.call(this,t),this.min=e||0,void 0):new w}function D(t){return this instanceof D?(f.call(this,t),void 0):new D}function g(t){return this instanceof g?(f.call(this,t),this.start=t||0,void 0):new g(t)}function m(t,e){return this instanceof m?(f.call(this,t),e&&(this.calendar=e),void 0):new m(t,e)}function M(t,e,n){return this instanceof M?(r.apply(this,arguments),this.left=e,this.right=n,this.op=t,void 0):new M(t,e,n)}function x(t,e){return this instanceof x?(f.call(this,t),void 0!==e&&this.setDaycount(e),void 0):new M(t,e)}function b(t,e){return this instanceof b?(u.apply(this,arguments),this.df=new _(this),this.daycount=E.daycount.d_30_360,void 0):new b(t,e)}function _(t,e){f.call(this,t),this.val=e}function I(t,e,n,r,a,i){return this instanceof I?(E.derived.apply(this),this.notional=a||1,this.daycount=i,this.rate=r,this.schedule=E.interval(t,e,n).div(n),this.generate(),void 0):new I(t,e,n,r,a,i)}function Y(){function t(){var t=n(),r=127&t;return u[r]>Math.abs(t)?t*o[r]:e(t,r)}function e(t,e){for(var a,i,h=3.442619855899,c=1/h;;){if(a=t*o[e],0===e){for(a=-Math.log(r())*c,i=-Math.log(r());a*a>i+i;)a=-Math.log(r())*c,i=-Math.log(r());return t>0?h+a:-h-a}if(Math.exp(-.5*a*a)>s[e]+r()*(s[e-1]-s[e]))return a;if(t=n(),e=127&t,u[e]>Math.abs(t))return t*o[e]}}function n(){var t=i,e=i;return e^=e<<13,e^=e>>>17,e^=e<<5,i=e,0|t+e}function r(){return.5*(1+n()/-Math.pow(2,31))}function a(){i^=(new Date).getTime();var t=2147483648,e=3.442619855899,n=e,r=.00991256303526217,a=r/Math.exp(-.5*e*e);u[0]=Math.floor(e/a*t),u[1]=0,o[0]=a/t,o[127]=e/t,s[0]=1,s[127]=Math.exp(-.5*e*e);for(var h=126;h>=1;h--)e=Math.sqrt(-2*Math.log(r/e+Math.exp(-.5*e*e))),u[h+1]=Math.floor(e/n*t),n=e,s[h]=Math.exp(-.5*e*e),o[h]=e/t}var i=123456789,o=Array(128),s=Array(128),u=Array(128);this.nextGaussian=function(){return t()},a()}function F(){return this instanceof F?(r.call(this),void 0):new F}function k(t){return this instanceof k?(r.apply(this),this.change=this.diff(this),this.random=t||new F,this.inputs=[t],void 0):new k(t)}function O(t,e,n){return this instanceof O?(k.apply(this),this.s=t||0,this.r=e||0,this.vol=n||0,void 0):new O(t,e,n)}function q(t,e){return this instanceof q?(F.call(this),this.parent=t,this.correl=e,void 0):new q(t,e)}var E=this.pyfy={};"undefined"!=typeof module&&(module.exports=E),E.util={},E.util.DAYMS=864e5,E.util.dateParts=function(t){t=new Date(t);var e={y:t.getFullYear(),m:t.getMonth(),d:t.getDate()};return e.date=new Date(e.y,e.m,e.d),e.lastofMonth=new Date(e.y,e.m,e.d+1).getMonth()==e.m+1,e.lastFeb=2==e.m&&e.lastofMonth,e},E.util.today=function(){return E.util.dateParts(new Date).date},E.util.nextDay=function(t,e){return void 0===e&&(e=0),new Date(t.getFullYear(),t.getMonth(),t.getDate()+e)},E.util.nextWeekday=function(t,e){var n=t.getDay(),r=n>e?e+7-n:e-n;return new Date(t.getFullYear(),t.getMonth(),t.getDate()+r)},E.util.bisect=function(t,n,r,a){for(3>arguments.length&&(r=0),4>arguments.length&&(a=t.length);a>r;){var i=r+a>>>1;n>e.call(t,t[i],i)?r=i+1:a=i}return r},E.calendar={},E.calendar.weekday=function(t){var e=t.getDay();return 0!==e&&6!=e},E.calendar.easter=function(t,e){e=e||[1,-2];var n,r,a,i,o,s,u,h,c;return 4>(t.getMonth()>1)?(n=t.getFullYear(),r=~~(n/100),a=n-19*~~(n/19),i=~~((r-17)/25),o=r-~~(r/4)-~~((r-i)/3)+19*a+15,o-=30*~~(o/30),o-=o/28*(1-~~(o/28)*~~(29/(o+1))*~~((21-a)/11)),s=n+~~(n/4)+o+2-r+~~(r/4),s-=7*~~(s/7),u=o-s,h=3+~~((u+40)/44)-1,c=Math.round(u+28-31*~~(h/4)),e.every(function(e){return t-new Date(n,h,c+e)})):!0},E.calendar.target=function(t){var e=t.getMonth(),n=t.getDate();return!(!E.calendar.weekday(t)||!E.calendar.easter(t,[1,-2])||0===e&&1==n||11==e&&(26==n||25==n)||4==e&&1==n)},E.calendar.is=function(t){var e=t.getFullYear(),n=t.getMonth(),r=t.getDate();return!(!E.calendar.weekday(t)||!E.calendar.easter(t,[1,-2,-3,39,50])||5==n&&17==r||0===n&&1==r||11==n&&(26==r||25==r)||4==n&&1==r||7==n&&0===t-E.util.nextWeekday(new Date(e,7,1),1)||3==n&&0===t-E.util.nextWeekday(new Date(e,3,19),4))},E.Query=n,E.query=function(t,e){return e=e||new n,t&&(e.cache[t]=e.cache[t]||{values:{}},e.cache[t].values=e.cache[t].values||{}),e},n.prototype.getCache=function(t){return this.cache[t.ID]||(this.cache[t.ID]={values:{}})},n.prototype.dates=function(e){var n=this.getCache(e);return n.dates||(n.dates=e.dates(this).map(function(t){return t.valueOf()}).sort(t)),n.dates},n.prototype.y=function(t,e){return this.get(t,e)},n.prototype.x=function(t){return this.dates(t).map(function(t){return new Date(t)})},n.prototype.val=function(t,e){return e=e||this.dates(t),e=[].concat(e),this.get(t,e).map(function(t,n){return{x:new Date(e[n]),y:t}},this)},n.prototype.get=function(t,e){return e||(e=this.dates(t)),[].concat(e).map(function(e){return this.fetch(t,e.valueOf())},this)},n.prototype.fetch=function(t,e){if(!isNaN(t))return t;var n=this.getCache(t).values;if(void 0===n[e]){var r=t.fn(this,e.valueOf());void 0!==r&&(n[e]=r)}return n[e]};var N=0;E.base=E.Base=r,r.prototype.dates=function(e){var n=this.rawDates(e),r=[];for(var a in n)r.push(new Date(+n[a]));return r.sort(t)},r.prototype.rawDates=function(t){t=E.query(this.ID,t);var e=t.cache[this.ID];if(!e.rawDates){e.rawDates={};var n="function"==typeof this.inputs?this.inputs():this.inputs;[].concat(n).filter(function(t){return t&&t.rawDates}).forEach(function(n){for(var r in n.rawDates(t))e.rawDates[r]=+r})}return e.rawDates},r.prototype.fn=function(){return 0},[l,y,d,v,w,D,m,x,p,f].forEach(function(t){r.prototype[t.name.toLowerCase()]=function(e,n,r){return new t(this,e,n,r)}}),r.prototype.pv=function(t){var e=0;return isNaN(t)||(t=E.ir(t)),this.mul(t.df).y().forEach(function(t){e+=t}),e},r.prototype.y=function(t){return E.query().get(this,t)},r.prototype.x=function(t){return E.query().x(this,t)},r.prototype.val=function(t){return E.query().val(this,t)},E.const=a,a.prototype=new r,a.prototype.fn=function(){return this.const},a.prototype.update=a.prototype.set=function(t){return this.const=t,this},E.sum=i,i.prototype=new r,i.prototype.inputs=function(){return this.parents},i.prototype.fn=function(t,e){var n=0;return this.parents.forEach(function(r){n+=t.fetch(r,e)}),n},E.data=E.Data=o,o.prototype=new r,o.prototype.rawDates=function(t){t=E.query(this.ID,t);var e=t.cache[this.ID];return e.rawDates||(e.rawDates={},this._dates.forEach(function(t){e.rawDates[t]=t})),e.rawDates},o.prototype.update=function(e){if(0===arguments.length)return this;if(isNaN(e))[].concat(e).forEach(function(t){this.data[t.x.valueOf()]=t.y},this);else{var n=E.util.today().valueOf();this.data[n]=e}return this._dates=Object.keys(this.data).map(function(t){return+t}).sort(t),this},o.prototype.set=function(t){return this.data={},this.update(t)},o.prototype.fn=function(t,e){if(!Object.keys(this.data).length)return 0;if(this.data[e])return this.data[e];var n=t.dates(this),r=E.util.bisect(n,e),a=r-1;return r==n.length&&(r-=1),0===r&&(a=0),this._fn(e,n[a]||n[r],n[r])},o.prototype._fn=function(){return void 0},E.flow=s,s.prototype=new o,s.prototype.fn=function(t,e){return this.data[e]||0},E.stock=u,u.prototype=new o,u.prototype._fn=function(t,e){return this.data[e]},E.price=h,h.prototype=new o,h.prototype._fn=function(t,e,n){var r=this.data[e],a=this.data[n];return e==n?a:n>(t>e)?r+(a-r)*(t-e)/(n-e):a},E.stream=c,c.prototype=new o,E.interval=function(t,e,n,r){t=t||E.util.today();for(var a=[],i=0;n+1>i;i++)a.push({x:new Date(t.getFullYear(),t.getMonth()+i*e,t.getDate()),y:i?r||1:0});return E.flow(a)},E.derived=E.Derived=f,f.prototype=new r,f.prototype.inputs=function(){return this.parent},f.prototype.fn=function(t,e){return t.fetch(this.parent,e)},f.prototype.setParent=function(t){return this.parent=t,this},E.period=p,p.prototype=new f,p.prototype.fn=function(t,e){return e>=this.start&&this.fin>=e?t.fetch(this.parent,e):0},E.prev=d,d.prototype=new f,d.prototype.fn=function(t,e){var n=t.dates(this),r=E.util.bisect(n,e);return r>0?t.fetch(this.parent,n[r-1]):this.default},E.cumul=l,l.prototype=new f,l.prototype.fn=function(t,e){var n=t.dates(this),r=E.util.bisect(n,e);return t.fetch(this.parent,e)+(r?t.fetch(this,n[r-1]):0)},E.diff=y,y.prototype=new f,y.prototype.fn=function(t,e){var n=t.dates(this),r=E.util.bisect(n,e);return r?t.fetch(this.parent,e)-t.fetch(this.parent,n[r-1]):0},E.max=v,v.prototype=new f,v.prototype.fn=function(t,e){return Math.max(t.fetch(this.parent,e),this.max)},E.min=w,w.prototype=new f,w.prototype.fn=function(t,e){return Math.min(t.fetch(this.parent,e),this.min)},E.Neg=D,D.prototype=new f,D.prototype.fn=function(t,e){return-t.fetch(this.parent,e)},E.acct=g,g.prototype=new f,g.prototype.fn=function(t,e){var n=t.dates(this.parent),r=E.util.bisect(n,e);return 1>r?this.start:n[r]==e?t.fetch(this,n[r-1])+t.fetch(this.parent,e):t.fetch(this,n[r-1])},E.Calendar=m,m.prototype=new f,m.prototype.rawDates=function(t){t=E.query(this.ID,t);var e=t.cache[this.ID];e.dateMap={},e.rawDates={};for(var n in this.parent.rawDates(t)){for(var r=new Date(+n),a=[].concat(this.calendar),i=0;!a.every(function(t){var e="string"==typeof t?E.calendar[t]:t;return e(r)},this);)if(r=new Date(r.getFullYear(),r.getMonth(),r.getDate()+1),i++>31)throw"Calendar function always returns false";r=r.valueOf(),e.rawDates[r]=+r,e.dateMap[r]=+n}return e.rawDates},m.prototype.fn=function(t,e){var n=t.cache[this.ID];return t.fetch(this.parent,n.dateMap[e]||this.calendar(e))},m.prototype.calendar=E.calendar.weekday,E.operator=E.Operator=M;var P={add:function(t,e){return t+e},sub:function(t,e){return t-e},mul:function(t,e){return t*e},div:function(t,e){return t/e},pow:function(t,e){return Math.pow(t,e)}};Object.keys(P).forEach(function(t){r.prototype[t]=function(e){return new M(t,this,e)}}),M.prototype=new r,M.prototype.inputs=function(){return[this.left,this.right]},M.prototype.fn=function(t,e){var n,r;return r=t.fetch(this.right,e),r||"mul"!=this.op?(n=t.fetch(this.left,e),P[this.op](n,r)):0},E.daycount=E.daycount||{},E.daycount.d_30_360=function(t,e){return 31==t.d&&(t.d=30),30==t.d&&31==e.d&&(e.d=30),(360*(e.y-t.y)+30*(e.m-t.m)+(e.d-t.d))/360},E.daycount.d_30E_360=function(t,e){return 31==t.d&&(t.d=30),31==e.d&&(e.d=30),(360*(e.y-t.y)+30*(e.m-t.m)+(e.d-t.d))/360},E.daycount.d_30_360US=function(t,e){return t.lastofFeb&&e.lastofFeb&&(e.d=30),t.lastofFeb&&(t.d=30),31!=e.d||30!=t.d&&31!=t.d||(e.d=30),31==t.d&&(t.d=30),(360*(e.y-t.y)+30*(e.m-t.m)+(e.d-t.d))/360},E.daycount.d_act_360=function(t,e){return Math.round((e.date-t.date)/E.util.DAYMS)/360},E.daycount.d_act_act=function(t,e){for(var n=0,r=t.date,a=new Date(Math.min(new Date(r.getFullYear()+1,0,1),e.date));e.date>r;){var i=new Date(r.getFullYear(),1,29),o=29==i.getDate()?366:365;n+=Math.round((a-r)/E.util.DAYMS)/o,r=a,a=new Date(Math.min(new Date(r.getFullYear()+1,0,1),e.date))}return n},E.dcf=x,x.prototype=new f,x.prototype.fn=function(t,e){var n=t.cache[this.ID];if(!Object.keys(n.values).length){var r=t.dates(this);n.values={},r.slice(1).forEach(function(e,a){var i=E.util.dateParts(r[a]),o=E.util.dateParts(e);n.values[e]=r[a]?this.daycount(i,o)*t.fetch(this.parent,e):0},this)}return n.values[e]||0},x.prototype.daycount=E.daycount.d_30_360,x.prototype.setDaycount=function(t){return this.daycount="string"==typeof t?E.daycount[t]:t,this},E.ir=b,b.prototype=new u,b.prototype.setDaycount=function(t){return this.daycount="string"==typeof t?E.daycount[t]:t,this},b.prototype._fn=function(t,e,n){return this.data[n]},E.df=function(t){return new f(t)},_.prototype=new x,_.prototype.fn=function(t,e){var n=t.dates(this),r=E.util.bisect(n,e),a=n[r-1];if(!a)return e==n[r]?1:0;var i=this.parent.daycount(E.util.dateParts(a),E.util.dateParts(e));return t.fetch(this,a)*Math.exp(-t.fetch(this.parent,e)*i)},E.bond=I,I.prototype=new E.derived,I.prototype.generate=function(){this.bal=E.acct(this.notional||1),this.p_scheduled=this.schedule.mul(this.notional),this.p=this.schedule.mul(this.notional),this.bal.setParent(this.p.neg()),this.i=this.bal.prev().dcf().mul(this.rate),this.setParent(this.p.add(this.i))},I.prototype.setSchedule=function(t){return this.schedule=t,this.generate(),this};{var A=new Y;E.rndNorm=A.nextGaussian}E.random=F,F.prototype=new r,F.prototype.fn=function(){return 2*Math.random()-1+(2*Math.random()-1)+(2*Math.random()-1)},F.prototype.correl=function(t){return E.correl(this,t)},F.prototype.wiener=function(){return E.wiener(this)},E.wiener=k,k.prototype=new r,k.prototype.rawDates=function(t){var e={};return t&&t.cache[this.ID]&&t.cache[this.ID].dates&&t.cache[this.ID].dates.forEach(function(t){e[t]=t}),e},k.prototype.fn=function(t,e){var n,r=t.cache[this.ID];if(!r.dates)return r.dates=[e],r.first={x:e,y:0},r.last={x:e,y:0},0;if(e>r.last.x)return r.dates.push(e),n=r.last.y+t.fetch(this.random,e)*(e-r.last.x)/E.util.DAYMS/365.25,r.last={x:e,y:n},n;if(r.first.x>e)return r.dates.slice(0,0,e),n=r.min.y-t.fetch(this.random,e)*(r.first.x-e)/E.util.DAYMS/365.25,r.first={x:e,y:n},n;var a=E.util.bisect(r.dates,e),i={x:r.dates[a-1]},o={x:r.dates[a]};return i.y=t.fetch(this,i.x),o.y=t.fetch(this,o.x),r.dates.splice(a,0,e),i.y+(e-i.x)/(o.x-i.x)*(o.y-i.y)},k.prototype.dates=function(t){return t?t.cache[this.ID].dates.all:[]},E.logNorm=function(t,e,n){return new Norm(t,e,n)},O.prototype=new k,O.prototype.inputs=function(){return[this.s,this.r,this.vol]},O.prototype.fn=function(t,e){if(0==t.cache[this.ID].values.length){var n=new Date;t.cache[this.ID].values[n]=a,t.fetch(this.parent,n)}return i*Math.sqrt(r)*t.fetch(this.parent,e);var r,a,i},E.correl=q,q.prototype=new F,q.prototype.fn=function(t,e){var n=t.fetch(this.correl,e);return n*t.fetch(this.parent,e)+Math.sqrt(1-n*n)*this.parent.fn.call(this,t,e)}})();