/**
  * pyfy.js (c) 2008-2013 Sigurgeir Orn Jonsson (ziggy.jonsson.nyc@gmail.com)
  * @license http://creativecommons.org/licenses/by-nc-sa/3.0/
  * Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported (CC BY-NC-SA 3.0)
  */
var pyfy={};(function(){function t(){return new Date(Math.floor(new Date/I)*I+18e6)}function n(t,n){return+t-n}function r(t,n,r,e){return t.fetch?t.fetch(n,r,e):t}function e(){this.ID=E++}function o(t){this.const=t}function i(t){this.parents=t}function s(t){e.apply(this,arguments),this.data={},this.sorted=[],this._dates=[],t&&this.update(t)}function p(){s.apply(this,arguments)}function u(){s.apply(this,arguments)}function a(){s.apply(this,arguments)}function f(t,n){e.call(this,arguments),this.parent=t,n&&(this.fn=n)}function h(t,n,r){f.call(this,t),this.start=n||-1/0,this.fin=r||1/0}function c(t){f.call(this,t)}function y(t){f.call(this,t)}function l(t){f.call(this,t)}function d(t,n){f.call(this,t),this.max=n||0}function v(t,n){f.call(this,t),this.min=n||0}function w(t){f.call(this,t)}function _(t,n,r){e.apply(this,arguments),this.parent=n,this.other=r,this.op=t}function m(){u.apply(this,arguments),this.df=new D(this)}function D(t,n){f.call(this,t),this.val=n}function x(){function t(){var t=r(),e=127&t;return u[e]>Math.abs(t)?t*s[e]:n(t,e)}function n(t,n){for(var o,i,a=3.442619855899,f=1/a;;){if(o=t*s[n],0===n){for(o=-Math.log(e())*f,i=-Math.log(e());o*o>i+i;)o=-Math.log(e())*f,i=-Math.log(e());return t>0?a+o:-a-o}if(Math.exp(-.5*o*o)>p[n]+e()*(p[n-1]-p[n]))return o;if(t=r(),n=127&t,u[n]>Math.abs(t))return t*s[n]}}function r(){var t=i,n=i;return n^=n<<13,n^=n>>>17,n^=n<<5,i=n,0|t+n}function e(){return.5*(1+r()/-Math.pow(2,31))}function o(){i^=(new Date).getTime();var t=2147483648,n=3.442619855899,r=n,e=.00991256303526217,o=e/Math.exp(-.5*n*n);u[0]=Math.floor(n/o*t),u[1]=0,s[0]=o/t,s[127]=n/t,p[0]=1,p[127]=Math.exp(-.5*n*n);for(var a=126;a>=1;a--)n=Math.sqrt(-2*Math.log(e/n+Math.exp(-.5*n*n))),u[a+1]=Math.floor(n/r*t),r=n,p[a]=Math.exp(-.5*n*n),s[a]=n/t}var i=123456789,s=Array(128),p=Array(128),u=Array(128);this.nextGaussian=function(){return t()},o()}function g(){return 2*Math.random()-1+(2*Math.random()-1)+(2*Math.random()-1)}function M(t,n,r){e.apply(this),this.s=t||0,this.r=n||0,this.vol=r||0}var I=864e5,E=0;pyfy.base=function(){return new e},e.prototype.dates=function(t){var r=[],e=this.rawDates();t&&[].concat(t).forEach(function(t){e[t]=t});for(var o in e)r.push(e[o]);return r.sort(n)},e.prototype.rawDates=function(t,n){return t=t||{},n=n||{},!n[this.ID]&&this.inputs&&("function"==typeof this.inputs?this.inputs():this.inputs,n[this.ID]=!0,[].concat(this.inputs()).forEach(function(r){r.rawDates&&r.rawDates(t,n)})),t},e.prototype.point=function(t,n){var r=0;return this.value(t,n).forEach(function(n){n.x==t&&(r=n.y)}),r},e.prototype.value=function(t,n){return this.get(t,n)[this.ID]},e.prototype.y=function(t,n){return this.value(t,n).map(function(t){return t.y})},e.prototype.x=function(t){return this.dates(t)},e.prototype.get=function(t,n){n||(n={});var r=n.__dates__=this.dates(t),e=r.length;return n.__dt__||(n.__dt__=r.map(function(t,n){return(t-(r[n-1]||r[0]))/I})),n[this.ID]||(n[this.ID]=[]),r.every(function(t,r){return this.fetch(n,t,r),n[this.ID].length!=e},this),n},e.prototype.fetch=function(t,n,r){if(t[this.ID]||(t[this.ID]=[]),void 0===t[this.ID][r]){var e=this.fn(t,n,r);t[this.ID][r]||(t[this.ID][r]={x:n,y:e})}return t[this.ID][r].y},[y,l,c,d,v,w].forEach(function(t){e.prototype[t.name.toLowerCase()]=function(n){return new t(this,n)}}),e.prototype.pv=function(t,n,r){var e=0;return this.mul(t.df(n)).y(null,r).forEach(function(t){e+=t}),e},e.prototype.derived=function(t){return new f(this,t)},e.prototype.period=function(t,n){return new h(this,t,n)},pyfy.const=pyfy.c=function(t){return e.apply(this,arguments),new o(t)},o.prototype=new e,o.prototype.fn=function(){return this.const},o.prototype.update=o.prototype.set=function(t){return this.const=t,this},pyfy.sum=function(t){return new i(t)},i.prototype=new e,i.prototype.inputs=function(){return this.parents},i.prototype.fn=function(t,n,r){var e=0;return this.parents.forEach(function(n){e+=n.fetch(t,n,r)}),e},s.prototype=new e,s.prototype.rawDates=function(t,n){return t=t||{},n=n||{},n[this.ID]||(this._dates.forEach(function(n){t[n]=n}),n[this.ID]=!0),t},s.prototype.update=function(r){if(0===arguments.length)return this;var e=this;if(isNaN(r))void 0===r.length&&(r=[r]),r.forEach(function(t){e.data[t.x]=t});else{var o=t();this.data[o]={x:o,y:r}}return this._dates=[],this.sorted=Object.keys(this.data).map(function(t){var n=e.data[t];return e._dates.push(n.x),n}).sort(n),this},s.prototype.set=function(t){return this.data={},this.update(t)},pyfy.flow=function(t){return new p(t)},pyfy.Flow=p,p.prototype=new s,p.prototype.fn=function(t,n,r){var e=this;return t[this.ID]=t.__dates__.map(function(t){return e.data[t]||{x:t,y:0}}),t[this.ID][r].y},pyfy.Stock=u,pyfy.stock=function(t){return new u(t)},u.prototype=new s,u.prototype.fn=function(t,n,r){var e=this;return t[this.ID]=t.__dates__.map(function(t){for(var n=e.sorted.length;n--;)if(t>=e.sorted[n].x)return{x:t,y:e.sorted[n].y};return{x:t,y:0}}),t[this.ID][r].y},u.prototype.val=function(t){var n=this;return 0===arguments.length?this.sorted:(void 0===t.length&&(t=[t]),t.map(function(t){for(var r=n.sorted.length;--r;)if(t>=n.sorted[r].x)return{x:t,y:n.sorted[r].y};return n.sorted[0]}))},pyfy.Price=a,pyfy.price=function(t){return new a(t)},a.prototype=new s,a.prototype.fn=function(t,n,r){var e=this;return t[this.ID]=t.__dates__.map(function(t){for(var n=e.sorted.length,r=e.sorted[e.sorted.length-1];n--;){var o=e.sorted[n];if(t>=o.x)return{x:t,y:o.y+(r.y-o.y)*(t-o.x)/(o.x-r.x)};r=o}return{x:t,y:0}}),t[this.ID][r]},pyfy.interval=function(t,n,r,e){for(var o=[],i=0;r>i;i++)o.push({x:t=new Date(t.getFullYear(),t.getMonth()+n,t.getDate()),y:e||1});return pyfy.flow(o)},pyfy.Derived=f,f.prototype=new e,f.prototype.inputs=function(){return this.parent},f.prototype.fn=function(t,n,r){return this.parent.fetch(t,n,r)},f.prototype.setParent=function(t){return this.parent=t,this},pyfy.Period=h,h.prototype=new f,h.prototype.fn=function(t,n,r){return n>=this.start&&this.fin>=n?this.parent.fetch(t,n,r):0},pyfy.Last=c,c.prototype=new f,c.prototype.fn=function(t,n,r){return 0+(r>0&&this.parent.fetch(t,n,r-1))},pyfy.Cumul=y,y.prototype=new f,y.prototype.fn=function(t,n,r){return this.parent.fetch(t,n,r)+(r>0&&t[this.ID][r-1])},pyfy.Diff=l,l.prototype=new f,l.prototype.fn=function(t,n,r){var e=Math.max(r-1,0);return+this.parent.fetch(t,n,r)-(this.parent.fetch(t,n,e)||0)},pyfy.Max=d,d.prototype=new f,d.prototype.fn=function(t,n,r){return Math.max(this.parent.fetch(t,n,r),this.max)},pyfy.Min=v,v.prototype=new f,v.prototype.fn=function(t,n,r){return Math.min(this.parent.fetch(t,n,r),this.min)},pyfy.Neg=w,w.prototype=new f,w.prototype.fn=function(t,n,r){return-this.parent.fetch(t,n,r)},pyfy.Operator=_;var b={add:function(t,n){return t+n},sub:function(t,n){return t-n},mul:function(t,n){return t*n},div:function(t,n){return t/n},pow:function(t,n){return Math.pow(t,n)}};Object.keys(b).forEach(function(t){e.prototype[t]=function(n){return new _(t,this,n)}}),_.prototype=new e,_.prototype.inputs=function(){return[this.parent,this.other]},_.prototype.fn=function(t,n,e){var o=r(this.parent,t,n,e),i=r(this.other,t,n,e);return b[this.op](o,i)},pyfy.ir=function(t){return new m(t)},m.prototype=new u,pyfy.df=function(t){return new D(t)},D.prototype=new f,D.prototype.fn=function(t,n,e){var o=this,i=t.__dt__[e]/365;return 0===e?1:r(this,t,n,e-1)*Math.exp(-r(o.parent,t,n,e)*i)};var k=new x,g=pyfy.rndNorm=k.nextGaussian;pyfy.norm=function(t,n,r){return new M(t,n,r)},M.prototype=new e,M.prototype.inputs=function(){return[this.s,this.r,this.vol]},M.prototype.fn=function(t,n,e){var o=this.s;t.__dates__;var i=t.__dt__[e]/365,o=e>0?this.fetch(t,n,e-1):this.s,s=r(this.r,t,n,e),p=r(this.vol,t,n,e),u=(s-Math.pow(p,2)/2)*i+p*Math.sqrt(i)*g();return o*Math.exp(u)}})();