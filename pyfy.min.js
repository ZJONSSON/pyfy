/**
  * pyfy.js (c) 2008-2013 Sigurgeir Orn Jonsson (ziggy.jonsson.nyc@gmail.com)
  * @license http://creativecommons.org/licenses/by-nc-sa/3.0/
  * Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported (CC BY-NC-SA 3.0)
  */
var pyfy={};(function(){function t(){return new Date(Math.floor(new Date/I)*I+18e6)}function n(t,n){return+t-n}function r(){this.ID=E++}function e(t){this.const=t}function o(t){r.apply(this,arguments),this.data={},this.sorted=[],this._dates=[],t&&this.update(t)}function i(){o.apply(this,arguments)}function a(){o.apply(this,arguments)}function s(){o.apply(this,arguments)}function p(t,n){r.call(this,arguments),this.parent=t,n&&(this.fn=n)}function u(t,n,r){p.call(this,t),this.min=n||-1/0,this.max=r||1/0}function h(t){p.call(this,t)}function f(t){p.call(this,t)}function y(t){p.call(this,t)}function c(){return new l.apply(this,arguments)}function l(){this.parents=Array.prototype.slice(arguments)}function d(t,n){this.max=n||0,p.call(this,t)}function v(t,n){this.min=n||0,p.call(this,t)}function w(t){p.call(this,t)}function m(t,n,e){r.apply(this,arguments),this.parent=n,this.other=e,this.op=t}function D(){a.apply(this,arguments)}function _(t,n){p.call(this,t),this.val=n}function x(){function t(){var t=r(),e=127&t;return p[e]>Math.abs(t)?t*a[e]:n(t,e)}function n(t,n){for(var o,i,u=3.442619855899,h=1/u;;){if(o=t*a[n],0===n){for(o=-Math.log(e())*h,i=-Math.log(e());o*o>i+i;)o=-Math.log(e())*h,i=-Math.log(e());return t>0?u+o:-u-o}if(Math.exp(-.5*o*o)>s[n]+e()*(s[n-1]-s[n]))return o;if(t=r(),n=127&t,p[n]>Math.abs(t))return t*a[n]}}function r(){var t=i,n=i;return n^=n<<13,n^=n>>>17,n^=n<<5,i=n,0|t+n}function e(){return.5*(1+r()/-Math.pow(2,31))}function o(){i^=(new Date).getTime();var t=2147483648,n=3.442619855899,r=n,e=.00991256303526217,o=e/Math.exp(-.5*n*n);p[0]=Math.floor(n/o*t),p[1]=0,a[0]=o/t,a[127]=n/t,s[0]=1,s[127]=Math.exp(-.5*n*n);for(var u=126;u>=1;u--)n=Math.sqrt(-2*Math.log(e/n+Math.exp(-.5*n*n))),p[u+1]=Math.floor(n/r*t),r=n,s[u]=Math.exp(-.5*n*n),a[u]=n/t}var i=123456789,a=Array(128),s=Array(128),p=Array(128);this.nextGaussian=function(){return t()},o()}function g(){return 2*Math.random()-1+(2*Math.random()-1)+(2*Math.random()-1)}function M(t,n,e){r.apply(this),this.s=t||0,this.r=n||0,this.vol=e||0}var I=864e5;pyfy.Base=r;var E=0;r.prototype.dates=function(t){var r=[],e=this.rawDates();t&&[].concat(t).forEach(function(t){e[t]=t});for(var o in e)r.push(e[o]);return r.sort(n)},r.prototype.rawDates=function(t){return t||{}},r.prototype.point=function(t,n){var r=0;return this.value(t,n).forEach(function(n){n.x==t&&(r=n.y)}),r},r.prototype.value=function(t,n){return this.get(t,n)[this.ID]},r.prototype.y=function(t,n){return this.value(t,n).map(function(t){return t.y})},r.prototype.x=function(t){return this.dates(t)},r.prototype.get=function(t,r){r||(r={});var e=r.__dates__=this.dates(t).sort(n);r.__dt__=e.map(function(t,n){return(t-(e[n-1]||e[0]))/I}),r[this.ID]||(r[this.ID]=[]);var o,i=r.__dates__.length;for(o=0;i>o&&(this.fetch(r,r.__dates__[o],o),r[this.ID].length!=i);o++);return r},r.prototype.fetch=function(t,n,r){return t[this.ID]||(t[this.ID]=[]),void 0===t[this.ID][r]&&(t[this.ID][r]={x:n,y:this.fn(t,n,r)}),t[this.ID][r]},[f,y,h,d,v,w].forEach(function(t){r.prototype[t.name.toLowerCase()]=function(n){return new t(this,n)}}),r.prototype.pv=function(t,n,r){var e=0;return this.mul(t.df(n)).y(null,r).forEach(function(t){e+=t}),e},r.prototype.derived=function(t){return new p(this,t)},r.prototype.filter=function(t,n){return new u(this,t,n)},pyfy.const=pyfy.c=function(t){return new e(t)},e.prototype=new r,e.prototype.fn=function(){return this.const},e.prototype.update=e.prototype.set=function(t){return this.const=t,this},o.prototype=new r,o.prototype.rawDates=function(t,n){return t=t||{},n=n||{},n[this.ID]||(this._dates.forEach(function(n){t[n]=n}),n[this.ID]=!0),t},o.prototype.update=function(r){if(0===arguments.length)return this;var e=this;if(isNaN(r))void 0===r.length&&(r=[r]),r.forEach(function(t){e.data[t.x]=t});else{var o=t();this.data[o]={x:o,y:r}}return this._dates=[],this.sorted=Object.keys(this.data).map(function(t){var n=e.data[t];return e._dates.push(n.x),n}).sort(n),this},o.prototype.set=function(t){return this.data={},this.update(t)},pyfy.flow=function(t){return new i(t)},pyfy.Flow=i,i.prototype=new o,i.prototype.fn=function(t,n,r){var e=this;return t[this.ID]=t.__dates__.map(function(t){return e.data[t]||{x:t,y:0}}),t[this.ID][r]},pyfy.Stock=a,pyfy.stock=function(t){return new a(t)},a.prototype=new o,a.prototype.fn=function(t,n,r){var e=this;return t[this.ID]=t.__dates__.map(function(t){for(var n=e.sorted.length;n--;)if(t>=e.sorted[n].x)return{x:t,y:e.sorted[n].y};return{x:t,y:0}}),t[this.ID][r]},a.prototype.val=function(t){var n=this;return 0===arguments.length?this.sorted:(void 0===t.length&&(t=[t]),t.map(function(t){for(var r=n.sorted.length;--r;)if(t>=n.sorted[r].x)return{x:t,y:n.sorted[r].y};return n.sorted[0]}))},pyfy.Price=s,pyfy.price=function(t){return new s(t)},s.prototype=new o,s.prototype.fn=function(t,n,r){var e=this;return t[this.ID]=t.__dates__.map(function(t){for(var n=e.sorted.length,r=e.sorted[e.sorted.length-1];n--;){var o=e.sorted[n];if(t>=o.x)return{x:t,y:o.y+(r.y-o.y)*(t-o.x)/(o.x-r.x)};r=o}return{x:t,y:0}}),t[this.ID][r]},pyfy.interval=function(t,n,r,e){for(var o=[],i=0;r>i;i++)o.push({x:t=new Date(t.getFullYear(),t.getMonth()+n,t.getDate()),y:e||1});return pyfy.flow(o)},pyfy.Derived=p,p.prototype=new r,p.prototype.rawDates=function(){return this.parent.rawDates.apply(this.parent,arguments)},p.prototype.fn=function(t,n,r){return this.parent.fetch(t,n,r).y},p.prototype.setParent=function(t){return this.parent=t,this},pyfy.Filter=u,u.prototype=new p,u.prototype.fn=function(t,n,r){return n>=this.min&&this.max>=n?this.parent.fetch(t,n,r-1).y:0},pyfy.Last=h,h.prototype=new p,h.prototype.fn=function(t,n,r){return 0+(r>0&&this.parent.fetch(t,n,r-1).y)},pyfy.Cumul=f,f.prototype=new p,f.prototype.fn=function(t,n,r){return this.parent.fetch(t,n,r).y+(r>0&&t[this.ID][r-1].y)},pyfy.Diff=y,y.prototype=new p,y.prototype.fn=function(t,n,r){var e=Math.max(r-1,0);return+this.parent.fetch(t,n,r).y-(this.parent.fetch(t,n,e).y||0)},pyfy.sum=c,pyfy.Sum=l,l.prototype=new r,l.prototype.dates=function(){var t={};return this.parents.forEach(function(n){n.dates().forEach(function(n){t[n]=n})}),Object.keys(t).map(function(n){return t[n]}).sort(n)},l.prototype.fn=function(t,n,r){var e=0;return this.parents.forEach(function(n){e+=n.fetch(t,n,r).y}),e},pyfy.Max=d,d.prototype=new p,d.prototype.fn=function(t,n,r){return Math.max(this.parent.fetch(t,n,r).y,this.max)},pyfy.Min=v,v.prototype=new p,v.prototype.fn=function(t,n,r){return Math.min(this.parent.fetch(t,n,r).y,this.min)},pyfy.Neg=w,w.prototype=new p,w.prototype.fn=function(t,n,r){return-this.parent.fetch(t,n,r).y},pyfy.Operator=m;var b={add:function(t,n){return t+n},sub:function(t,n){return t-n},mul:function(t,n){return t*n},div:function(t,n){return t/n},pow:function(t,n){return Math.pow(t,n)}};Object.keys(b).forEach(function(t){r.prototype[t]=function(n){return new m(t,this,n)}}),m.prototype=new r,m.prototype.rawDates=function(t,n){return t=t||{},n=n||{},n[this.ID]||(n[this.ID]=!0,this.parent.rawDates&&this.parent.rawDates(t,n),this.other.rawDates&&this.other.rawDates(t,n)),t},m.prototype.fn=function(t,n,r){var e=this.parent.fetch(t,n,r).y,o=this.other.fetch?this.other.fetch(t,n,r).y:this.other;return b[this.op](e,o)},pyfy.ir=function(t){return new D(t)},D.prototype=new a,D.prototype.df=function(t){return new _(this,t)},_.prototype=new p,_.prototype.rawDates=function(t,n){return n=n||{},t=t||{},n[this.ID]||(this.parent.rawDates.apply(this.parent,t,n),this.val&&(t[this.val]=this.val),n[this.ID]=!0),t},_.prototype.fn=function(t,n,r){var e=this,o=1,i=this.val||t.__dates__[0];return t[this.ID]=t.__dates__.map(function(n,r){var a={x:n,y:0};return n>=i&&(a.y=o*=Math.exp(-e.parent.fetch(t,n,r).y*(n-i)/I/365),i=n),a}),t[this.ID][r]};var k=new x,g=pyfy.rndNorm=k.nextGaussian;pyfy.norm=function(t,n,r){return new M(t,n,r)},M.prototype=new r,M.prototype.fn=function(t,n,r){var e=this.s,o=this,i=t.__dates__;return t[this.ID]=i.map(function(t,n){return t-(i[n-1]||i[0])/I}).map(function(t,n){var r=o.r-Math.pow(o.vol,2)/2*t+o.vol*Math.sqrt(t)*g();return{x:i[n],y:e*=Math.exp(r)}}),t[this.ID][r]}})();